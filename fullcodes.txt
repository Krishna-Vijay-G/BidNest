//src/middleware.ts
import { NextRequest, NextResponse } from "next/server";
import { verifyToken } from "@/lib/auth";

const PUBLIC_PATHS = ["/", "/login", "/register", "/api/auth/login", "/api/auth/register"];

export function middleware(req: NextRequest) {
  const { pathname } = req.nextUrl;

  // allow public paths
  if (PUBLIC_PATHS.some((p) => pathname === p || pathname.startsWith(p))) {
    return NextResponse.next();
  }

  // allow public assets
  if (pathname.startsWith("/_next") || pathname.startsWith("/icons") || pathname === "/manifest.json") {
    return NextResponse.next();
  }

  const token = req.cookies.get("bidnest-token")?.value;

  if (!token) {
    return NextResponse.redirect(new URL("/login", req.url));
  }

  const payload = verifyToken(token);

  if (!payload) {
    return NextResponse.redirect(new URL("/login", req.url));
  }

  return NextResponse.next();
}

export const config = {
  matcher: ["/((?!_next/static|_next/image|favicon.ico).*)"],
};
========================================
/* src/app/globals.css */
@import "tailwindcss";

@custom-variant dark (&:where(.dark, .dark *));

/* ======================================
   THEME VARIABLES
   ====================================== */

:root {
  --page-bg: #f8fafc;
  --page-bg-alt: #f1f5f9;
  --foreground: #0f172a;
  --foreground-secondary: #475569;
  --foreground-muted: #94a3b8;
  --surface: rgba(255, 255, 255, 0.8);
  --surface-hover: rgba(0, 0, 0, 0.04);
  --border-color: rgba(0, 0, 0, 0.08);
  --glass-bg: rgba(255, 255, 255, 0.7);
  --glass-bg-strong: rgba(255, 255, 255, 0.9);
  --glass-border: rgba(0, 0, 0, 0.06);
  --glass-border-strong: rgba(0, 0, 0, 0.1);
  --glass-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
  --glass-blur: 12px;
  --glass-hover-bg: rgba(0, 0, 0, 0.03);
  --glass-hover-border: rgba(0, 240, 255, 0.25);
  --input-bg: rgba(255, 255, 255, 0.9);
  --input-border: rgba(0, 0, 0, 0.12);
  --input-text: #0f172a;
  --input-placeholder: #94a3b8;
  --input-focus-bg: #ffffff;
  --input-option-bg: #ffffff;
  --table-header-bg: rgba(0, 0, 0, 0.03);
  --table-header-text: #64748b;
  --table-row-hover: rgba(0, 0, 0, 0.02);
  --table-cell-text: #334155;
  --table-cell-border: rgba(0, 0, 0, 0.06);
  --sidebar-bg: rgba(255, 255, 255, 0.85);
  --sidebar-hover: rgba(0, 240, 255, 0.06);
  --header-bg: rgba(255, 255, 255, 0.75);
  --scrollbar-thumb: rgba(0, 0, 0, 0.12);
  --scrollbar-hover: rgba(0, 240, 255, 0.4);
  --progress-track: rgba(0, 0, 0, 0.06);
  --mesh-cyan: rgba(0, 240, 255, 0.04);
  --mesh-purple: rgba(168, 85, 247, 0.03);
  --mesh-pink: rgba(244, 114, 182, 0.02);
  --neon-cyan-text-shadow: none;
  --neon-purple-text-shadow: none;
  --neon-pink-text-shadow: none;
  --neon-border-shadow: 0 0 8px rgba(0, 240, 255, 0.1);
  --shimmer-color: rgba(0, 0, 0, 0.04);
  color-scheme: light;
}

.dark {
  --page-bg: #050510;
  --page-bg-alt: #0a0a1a;
  --foreground: #f1f5f9;
  --foreground-secondary: #cbd5e1;
  --foreground-muted: #64748b;
  --surface: rgba(255, 255, 255, 0.04);
  --surface-hover: rgba(255, 255, 255, 0.08);
  --border-color: rgba(255, 255, 255, 0.06);
  --glass-bg: rgba(255, 255, 255, 0.04);
  --glass-bg-strong: rgba(255, 255, 255, 0.08);
  --glass-border: rgba(255, 255, 255, 0.08);
  --glass-border-strong: rgba(255, 255, 255, 0.12);
  --glass-shadow: none;
  --glass-blur: 20px;
  --glass-hover-bg: rgba(255, 255, 255, 0.08);
  --glass-hover-border: rgba(0, 240, 255, 0.2);
  --input-bg: rgba(255, 255, 255, 0.05);
  --input-border: rgba(255, 255, 255, 0.1);
  --input-text: #e2e8f0;
  --input-placeholder: #64748b;
  --input-focus-bg: rgba(255, 255, 255, 0.08);
  --input-option-bg: #0a0a1a;
  --table-header-bg: rgba(255, 255, 255, 0.05);
  --table-header-text: #94a3b8;
  --table-row-hover: rgba(255, 255, 255, 0.04);
  --table-cell-text: #cbd5e1;
  --table-cell-border: rgba(255, 255, 255, 0.04);
  --sidebar-bg: rgba(10, 10, 30, 0.8);
  --sidebar-hover: rgba(0, 240, 255, 0.1);
  --header-bg: rgba(5, 5, 16, 0.5);
  --scrollbar-thumb: rgba(255, 255, 255, 0.15);
  --scrollbar-hover: rgba(0, 240, 255, 0.3);
  --progress-track: rgba(255, 255, 255, 0.06);
  --mesh-cyan: rgba(0, 240, 255, 0.08);
  --mesh-purple: rgba(168, 85, 247, 0.06);
  --mesh-pink: rgba(244, 114, 182, 0.04);
  --neon-cyan-text-shadow: 0 0 10px rgba(0, 240, 255, 0.5), 0 0 40px rgba(0, 240, 255, 0.2);
  --neon-purple-text-shadow: 0 0 10px rgba(168, 85, 247, 0.5), 0 0 40px rgba(168, 85, 247, 0.2);
  --neon-pink-text-shadow: 0 0 10px rgba(244, 114, 182, 0.5), 0 0 40px rgba(244, 114, 182, 0.2);
  --neon-border-shadow: inset 0 0 20px rgba(0, 240, 255, 0.05), 0 0 20px rgba(0, 240, 255, 0.3), 0 0 60px rgba(0, 240, 255, 0.1);
  --shimmer-color: rgba(255, 255, 255, 0.05);
  color-scheme: dark;
}

/* ======================================
   TAILWIND THEME TOKENS
   ====================================== */

@theme inline {
  --color-primary: #00f0ff;
  --color-primary-dark: #00b8d4;
  --color-primary-light: #67f7ff;
  --color-secondary: #a855f7;
  --color-accent: #f472b6;
  --color-success: #22c55e;
  --color-danger: #ef4444;
  --color-warning: #f59e0b;
  --color-foreground: var(--foreground);
  --color-foreground-secondary: var(--foreground-secondary);
  --color-foreground-muted: var(--foreground-muted);
  --color-surface: var(--surface);
  --color-surface-hover: var(--surface-hover);
  --color-border: var(--border-color);
  --color-page: var(--page-bg);
  --color-page-alt: var(--page-bg-alt);
  --color-sidebar: var(--sidebar-bg);
  --color-sidebar-hover: var(--sidebar-hover);
  --color-text: var(--foreground);
  --color-text-secondary: var(--foreground-secondary);
  --color-text-muted: var(--foreground-muted);
  --glow-cyan: 0 0 20px rgba(0, 240, 255, 0.3), 0 0 60px rgba(0, 240, 255, 0.1);
  --glow-purple: 0 0 20px rgba(168, 85, 247, 0.3), 0 0 60px rgba(168, 85, 247, 0.1);
  --glow-pink: 0 0 20px rgba(244, 114, 182, 0.3), 0 0 60px rgba(244, 114, 182, 0.1);
  --glow-green: 0 0 20px rgba(34, 197, 94, 0.3), 0 0 60px rgba(34, 197, 94, 0.1);
  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* ======================================
   BASE STYLES
   ====================================== */

* { box-sizing: border-box; }

html { scroll-behavior: smooth; }

body {
  font-family: var(--font-sans);
  background-color: var(--page-bg);
  color: var(--foreground);
  min-height: 100vh;
  transition: background-color 0.3s ease, color 0.3s ease;
}

/* === Mesh Gradient Background === */
.bg-mesh {
  background:
    radial-gradient(ellipse 80% 60% at 10% 20%, var(--mesh-cyan) 0%, transparent 50%),
    radial-gradient(ellipse 60% 80% at 80% 80%, var(--mesh-purple) 0%, transparent 50%),
    radial-gradient(ellipse 50% 50% at 50% 50%, var(--mesh-pink) 0%, transparent 50%),
    var(--page-bg);
}

/* === Glass Card === */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(var(--glass-blur));
  -webkit-backdrop-filter: blur(var(--glass-blur));
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  box-shadow: var(--glass-shadow);
}

.glass-strong {
  background: var(--glass-bg-strong);
  backdrop-filter: blur(calc(var(--glass-blur) + 4px));
  -webkit-backdrop-filter: blur(calc(var(--glass-blur) + 4px));
  border: 1px solid var(--glass-border-strong);
  border-radius: 16px;
  box-shadow: var(--glass-shadow);
}

.glass-hover:hover {
  background: var(--glass-hover-bg);
  border-color: var(--glass-hover-border);
  box-shadow: var(--glow-cyan);
}

/* === Neon Text === */
.neon-text {
  color: #00f0ff;
  text-shadow: var(--neon-cyan-text-shadow);
}

.neon-text-purple {
  color: #a855f7;
  text-shadow: var(--neon-purple-text-shadow);
}

.neon-text-pink {
  color: #f472b6;
  text-shadow: var(--neon-pink-text-shadow);
}

/* === Neon Border === */
.neon-border {
  border: 1px solid var(--glass-hover-border);
  box-shadow: var(--neon-border-shadow);
}

/* === Neon Button === */
.btn-neon {
  background: linear-gradient(135deg, rgba(0, 240, 255, 0.15), rgba(0, 240, 255, 0.05));
  border: 1px solid rgba(0, 240, 255, 0.4);
  color: #00f0ff;
  box-shadow: 0 0 15px rgba(0, 240, 255, 0.2);
  transition: all 0.3s ease;
}

.btn-neon:hover {
  background: linear-gradient(135deg, rgba(0, 240, 255, 0.25), rgba(0, 240, 255, 0.1));
  box-shadow: 0 0 25px rgba(0, 240, 255, 0.4), 0 0 50px rgba(0, 240, 255, 0.15);
  transform: translateY(-1px);
}

/* === Custom Scrollbar === */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-hover); }

/* Input number spinner hide */
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
input[type="number"] { -moz-appearance: textfield; }

/* === Animations === */
@keyframes slideIn {
  from { opacity: 0; transform: translateY(-10px) scale(0.98); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes pulse-soft {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

@keyframes glow-pulse {
  0%, 100% { box-shadow: 0 0 15px rgba(0, 240, 255, 0.2); }
  50% { box-shadow: 0 0 30px rgba(0, 240, 255, 0.4), 0 0 60px rgba(0, 240, 255, 0.15); }
}

@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-6px); }
}

@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}

@keyframes gradient-shift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.animate-slide-in { animation: slideIn 0.3s ease-out; }
.animate-slide-up { animation: slideUp 0.4s ease-out; }
.animate-fade-in { animation: fadeIn 0.3s ease-out; }
.animate-pulse-soft { animation: pulse-soft 2s ease-in-out infinite; }
.animate-glow-pulse { animation: glow-pulse 3s ease-in-out infinite; }
.animate-float { animation: float 3s ease-in-out infinite; }
.animate-shimmer {
  background: linear-gradient(90deg, transparent, var(--shimmer-color), transparent);
  background-size: 200% 100%;
  animation: shimmer 2s infinite;
}
.animate-gradient {
  background-size: 200% 200%;
  animation: gradient-shift 6s ease infinite;
}

/* === Stagger Children === */
.stagger-children > * { animation: slideUp 0.4s ease-out both; }
.stagger-children > *:nth-child(1) { animation-delay: 0ms; }
.stagger-children > *:nth-child(2) { animation-delay: 60ms; }
.stagger-children > *:nth-child(3) { animation-delay: 120ms; }
.stagger-children > *:nth-child(4) { animation-delay: 180ms; }
.stagger-children > *:nth-child(5) { animation-delay: 240ms; }
.stagger-children > *:nth-child(6) { animation-delay: 300ms; }

/* === Glass Input === */
.glass-input {
  background: var(--input-bg);
  border: 1px solid var(--input-border);
  color: var(--input-text);
  border-radius: 12px;
  transition: all 0.2s ease;
}

.glass-input::placeholder { color: var(--input-placeholder); }

.glass-input:focus {
  outline: none;
  border-color: rgba(0, 240, 255, 0.4);
  box-shadow: 0 0 0 3px rgba(0, 240, 255, 0.1), 0 0 15px rgba(0, 240, 255, 0.1);
  background: var(--input-focus-bg);
}

.glass-input:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* === Glass Table === */
.glass-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
}

.glass-table thead th {
  background: var(--table-header-bg);
  color: var(--table-header-text);
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  padding: 12px 16px;
  border-bottom: 1px solid var(--table-cell-border);
  text-align: left;
}

.glass-table tbody tr { transition: background 0.15s ease; }
.glass-table tbody tr:hover { background: var(--table-row-hover); }

.glass-table tbody td {
  padding: 12px 16px;
  border-bottom: 1px solid var(--table-cell-border);
  font-size: 0.875rem;
  color: var(--table-cell-text);
}

/* === Progress Bar === */
.neon-progress {
  height: 6px;
  background: var(--progress-track);
  border-radius: 999px;
  overflow: hidden;
}

.neon-progress-bar {
  height: 100%;
  border-radius: 999px;
  background: linear-gradient(90deg, #00f0ff, #a855f7);
  box-shadow: 0 0 10px rgba(0, 240, 255, 0.4);
  transition: width 0.6s ease;
}

/* === Light mode specific fixes === */
:root .glass-table tbody td { color: var(--table-cell-text); }
:root .glass-table thead th { color: var(--table-header-text); }
========================================
//src/app/layout.tsx
import type { Metadata, Viewport } from "next";
import { Inter } from "next/font/google";
import "./globals.css";
import { Providers } from "@/components/providers";

const inter = Inter({
  variable: "--font-inter",
  subsets: ["latin"],
  weight: ["300", "400", "500", "600", "700", "800", "900"],
});

export const viewport: Viewport = {
  themeColor: "#00f0ff",
  width: "device-width",
  initialScale: 1,
};

export const metadata: Metadata = {
  title: "BidNest – Chit Fund Management",
  description: "Modern chit fund management platform",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en" className="dark" suppressHydrationWarning>
      <head>
        <script dangerouslySetInnerHTML={{
          __html: `(function(){try{var t=localStorage.getItem('bidnest-theme');if(t==='light'){document.documentElement.classList.remove('dark')}else{document.documentElement.classList.add('dark')}}catch(e){}})()`,
        }} />
      </head>
      <body className={`${inter.variable} antialiased bg-mesh`}>
        <Providers>
          {children}
        </Providers>
      </body>
    </html>
  );
}
========================================
//src/app/page.tsx
import Link from 'next/link';
import {
  HiOutlineUserGroup,
  HiOutlineShieldCheck,
  HiOutlineChartBar,
  HiOutlineBell,
  HiOutlineBanknotes,
  HiOutlineArrowTrendingUp,
} from 'react-icons/hi2';

export default function HomePage() {
  return (
    <div className="min-h-screen relative overflow-hidden">
      {/* Ambient background orbs */}
      <div className="fixed inset-0 pointer-events-none">
        <div className="absolute top-[-20%] left-[-10%] w-150 h-150 rounded-full bg-cyan-500/[0.07] blur-[120px]" />
        <div className="absolute bottom-[-20%] right-[-10%] w-125 h-125 rounded-full bg-purple-500/[0.07] blur-[120px]" />
        <div className="absolute top-[40%] right-[20%] w-75 h-75 rounded-full bg-pink-500/5 blur-[100px]" />
      </div>

      {/* Navigation */}
      <nav className="relative z-10 flex items-center justify-between px-6 sm:px-12 py-5">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-xl flex items-center justify-center bg-linear-to-br from-cyan-400 to-purple-500 shadow-lg shadow-cyan-500/20">
            <span className="text-white font-black text-lg">B</span>
          </div>
          <span className="text-foreground font-bold text-xl tracking-tight">
            Bid<span className="neon-text">Nest</span>
          </span>
        </div>
        <div className="flex items-center gap-3">
          <Link
            href="/login"
            className="text-foreground-secondary hover:text-cyan-400 px-4 py-2 text-sm font-medium transition-colors"
          >
            Sign In
          </Link>
          <Link
            href="/register"
            className="btn-neon px-5 py-2 rounded-xl text-sm font-semibold"
          >
            Get Started
          </Link>
        </div>
      </nav>

      {/* Hero */}
      <section className="relative z-10 px-6 sm:px-12 py-20 sm:py-32 text-center max-w-5xl mx-auto">
        <div className="inline-flex items-center gap-2 glass rounded-full px-4 py-1.5 mb-8">
          <span className="w-2 h-2 bg-cyan-400 rounded-full animate-pulse-soft" />
          <span className="text-foreground-secondary text-sm">
            Trusted by chit fund managers across India
          </span>
        </div>
        <h1 className="text-4xl sm:text-6xl lg:text-7xl font-black text-foreground leading-[1.1] mb-6 tracking-tight">
          Modern Chit Fund
          <br />
          <span className="bg-linear-to-r from-cyan-400 via-purple-400 to-pink-400 bg-clip-text text-transparent animate-gradient">
            Management Platform
          </span>
        </h1>
        <p className="text-foreground-muted text-lg sm:text-xl max-w-2xl mx-auto mb-12 leading-relaxed">
          Streamline your rotating chit fund operations with automated auctions,
          real-time tracking, and precise financial calculations.
        </p>
        <div className="flex flex-col sm:flex-row items-center justify-center gap-4">
          <Link
            href="/register"
            className="relative group overflow-hidden bg-linear-to-r from-cyan-500 to-purple-500 text-white px-8 py-3.5 rounded-xl text-base font-semibold transition-all shadow-lg shadow-cyan-500/25 hover:shadow-cyan-500/40 hover:-translate-y-0.5 w-full sm:w-auto"
          >
            <span className="relative z-10">Start Managing Now</span>
            <div className="absolute inset-0 bg-linear-to-r from-cyan-400 to-purple-400 opacity-0 group-hover:opacity-100 transition-opacity" />
          </Link>
          <Link
            href="/login"
            className="glass border border-border hover:border-cyan-500/30 text-foreground px-8 py-3.5 rounded-xl text-base font-semibold transition-all hover:shadow-[0_0_20px_rgba(0,240,255,0.15)] w-full sm:w-auto"
          >
            Sign In
          </Link>
        </div>

        {/* Stats bar */}
        <div className="mt-16 glass-strong rounded-2xl p-6 grid grid-cols-3 gap-6 max-w-xl mx-auto">
          {[
            { value: '100%', label: 'Accurate Math' },
            { value: 'Real-time', label: 'Tracking' },
            { value: 'Secure', label: 'Data Protected' },
          ].map((stat) => (
            <div key={stat.label}>
              <div className="text-xl font-bold neon-text">{stat.value}</div>
              <div className="text-foreground-muted text-xs mt-1">{stat.label}</div>
            </div>
          ))}
        </div>
      </section>

      {/* Features */}
      <section className="relative z-10 px-6 sm:px-12 pb-24 max-w-6xl mx-auto">
        <div className="text-center mb-12">
          <h2 className="text-2xl sm:text-3xl font-bold text-foreground mb-3">
            Everything You Need
          </h2>
          <p className="text-foreground-muted max-w-lg mx-auto">
            A complete toolkit to manage chit funds efficiently, from group creation to payout tracking.
          </p>
        </div>
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 stagger-children">
          {[
            {
              icon: <HiOutlineUserGroup className="w-6 h-6" />,
              title: 'Group Management',
              desc: 'Create and manage multiple chit groups with flexible configurations and member tracking.',
              iconBg: 'bg-cyan-500/10 text-cyan-400',
            },
            {
              icon: <HiOutlineChartBar className="w-6 h-6" />,
              title: 'Auto Calculations',
              desc: 'Accurate dividend, commission, and payout calculations computed automatically every month.',
              iconBg: 'bg-purple-500/10 text-purple-400',
            },
            {
              icon: <HiOutlineBanknotes className="w-6 h-6" />,
              title: 'Payment Tracking',
              desc: 'Track contributions, payouts, and pending amounts with real-time status updates.',
              iconBg: 'bg-green-500/10 text-green-400',
            },
            {
              icon: <HiOutlineArrowTrendingUp className="w-6 h-6" />,
              title: 'Auction System',
              desc: 'Conduct monthly auctions with bid tracking, winner selection, and instant calculations.',
              iconBg: 'bg-pink-500/10 text-pink-400',
            },
            {
              icon: <HiOutlineShieldCheck className="w-6 h-6" />,
              title: 'Secure & Reliable',
              desc: 'Role-based access control with row-level security. Admin and member views separated.',
              iconBg: 'bg-amber-500/10 text-amber-400',
            },
            {
              icon: <HiOutlineBell className="w-6 h-6" />,
              title: 'Real-time Alerts',
              desc: 'Instant notifications for reminders, auction results, payment confirmations, and more.',
              iconBg: 'bg-blue-500/10 text-blue-400',
            },
          ].map((feature) => (
            <div
              key={feature.title}
              className="glass glass-hover rounded-2xl p-6 transition-all duration-300 group cursor-default"
            >
              <div className={`p-3 rounded-xl w-fit mb-4 ${feature.iconBg} transition-transform group-hover:scale-110`}>
                {feature.icon}
              </div>
              <h3 className="text-foreground font-semibold text-base mb-2">{feature.title}</h3>
              <p className="text-foreground-muted text-sm leading-relaxed">{feature.desc}</p>
            </div>
          ))}
        </div>
      </section>

      {/* Footer */}
      <footer className="relative z-10 border-t border-border py-8 text-center">
        <p className="text-foreground-muted text-sm">
          &copy; {new Date().getFullYear()} BidNest. Built for the chit fund community.
        </p>
      </footer>
    </div>
  );
}
========================================
//src/app/api/auctions/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { z } from "zod";
import { calculateAuction } from "@/utils/dividend";

// ─── SCHEMAS ───────────────────────────────────────────────

const CreateAuctionSchema = z.object({
  chit_group_id: z.string().uuid(),
  month_number: z.number().int().positive(),
  winner_chit_member_id: z.string().uuid(),
  original_bid: z.number().positive(),
});

// ─── POST /api/auctions ────────────────────────────────────

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const parsed = CreateAuctionSchema.safeParse(body);

    if (!parsed.success) {
      return NextResponse.json(
        { error: parsed.error.flatten() },
        { status: 400 }
      );
    }

    // get chit group
    const chitGroup = await prisma.chitGroup.findUnique({
      where: { id: parsed.data.chit_group_id },
    });
    if (!chitGroup) {
      return NextResponse.json({ error: "Chit group not found" }, { status: 404 });
    }

    // check winner is a valid chit member of this group
    const winnerChitMember = await prisma.chitMember.findUnique({
      where: { id: parsed.data.winner_chit_member_id },
    });
    if (!winnerChitMember || winnerChitMember.chit_group_id !== parsed.data.chit_group_id) {
      return NextResponse.json(
        { error: "Winner is not a member of this chit group" },
        { status: 400 }
      );
    }

    // check this ticket hasn't already won
    const alreadyWon = await prisma.auction.findFirst({
      where: { winner_chit_member_id: parsed.data.winner_chit_member_id },
    });
    if (alreadyWon) {
      return NextResponse.json(
        { error: "This ticket has already won an auction" },
        { status: 409 }
      );
    }

    // check month_number not already auctioned
    const monthTaken = await prisma.auction.findUnique({
      where: {
        chit_group_id_month_number: {
          chit_group_id: parsed.data.chit_group_id,
          month_number: parsed.data.month_number,
        },
      },
    });
    if (monthTaken) {
      return NextResponse.json(
        { error: `Month ${parsed.data.month_number} already has an auction` },
        { status: 409 }
      );
    }

    // get carry_previous from last month's auction
    const previousAuction = await prisma.auction.findUnique({
      where: {
        chit_group_id_month_number: {
          chit_group_id: parsed.data.chit_group_id,
          month_number: parsed.data.month_number - 1,
        },
      },
    });
    const carry_previous = previousAuction
      ? Number(previousAuction.carry_next)
      : 0;

    // run calculation
    const calc = calculateAuction({
      total_amount: Number(chitGroup.total_amount),
      original_bid: parsed.data.original_bid,
      commission_type: chitGroup.commission_type as "PERCENT" | "FIXED",
      commission_value: Number(chitGroup.commission_value),
      round_off_value: chitGroup.round_off_value,
      carry_previous,
    });

    const dividend_per_member = calc.roundoff_dividend / chitGroup.total_members;
    // build calculation_data snapshot
    const calculation_data = {
      total_amount: Number(chitGroup.total_amount),
      total_members: chitGroup.total_members,
      monthly_contribution: Number(chitGroup.monthly_amount),
      dividend_per_member: dividend_per_member,
      amount_to_collect: Number(chitGroup.monthly_amount) - dividend_per_member,
      commission_type: chitGroup.commission_type,
      commission_value: Number(chitGroup.commission_value),
      round_off_value: chitGroup.round_off_value,
      original_bid: parsed.data.original_bid,
      ...calc,
    };

    const auction = await prisma.auction.create({
      data: {
        chit_group_id: parsed.data.chit_group_id,
        month_number: parsed.data.month_number,
        winner_chit_member_id: parsed.data.winner_chit_member_id,
        original_bid: parsed.data.original_bid,
        winning_amount: calc.winning_amount,
        commission: calc.commission,
        carry_previous: calc.carry_previous,
        raw_dividend: calc.raw_dividend,
        roundoff_dividend: calc.roundoff_dividend,
        carry_next: calc.carry_next,
        calculation_data,
      },
    });

    return NextResponse.json(auction, { status: 201 });
  } catch (error) {
    console.error(error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : String(error) },
      { status: 500 }
    );
  }
}

// ─── GET /api/auctions ─────────────────────────────────────

export async function GET(req: NextRequest) {
  try {
    const { searchParams } = new URL(req.url);
    const chit_group_id = searchParams.get("chit_group_id");
    const user_id = searchParams.get("user_id");

    const auctions = await prisma.auction.findMany({
      where: {
        ...(chit_group_id ? { chit_group_id } : {}),
        ...(user_id ? { chit_group: { user_id } } : {}),
      },
      include: {
        winner_chit_member: {
          include: { member: true },
        },
      },
      orderBy: { month_number: "asc" },
    });

    return NextResponse.json(auctions, { status: 200 });
  } catch (error) {
    console.error(error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : String(error) },
      { status: 500 }
    );
  }
}
========================================
//src/app/api/auctions/[id]/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

// ─── GET /api/auctions/[id] ────────────────────────────────

export async function GET(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  try {
    const auction = await prisma.auction.findUnique({
      where: { id },
      include: {
        chit_group: true,
        winner_chit_member: {
          include: { member: true },
        },
      },
    });

    if (!auction) {
      return NextResponse.json({ error: "Auction not found" }, { status: 404 });
    }

    return NextResponse.json(auction, { status: 200 });
  } catch (error) {
    console.error(error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : String(error) },
      { status: 500 }
    );
  }
}
========================================
//src/app/api/audit-logs/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { z } from "zod";

// ─── SCHEMAS ───────────────────────────────────────────────

const CreateAuditLogSchema = z.object({
  user_id: z.string().uuid().optional(),
  action_type: z.enum(["CREATE", "UPDATE", "DELETE", "LOGIN", "LOGOUT"]),
  action_detail: z.string().min(1),
  table_name: z.string().min(1),
  record_id: z.string().uuid(),
  old_data: z.record(z.string(), z.any()).optional(),
  new_data: z.record(z.string(), z.any()).optional(),
  ip_address: z.string().optional(),
  user_agent: z.string().optional(),
});

// ─── POST /api/audit-logs ──────────────────────────────────

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const parsed = CreateAuditLogSchema.safeParse(body);

    if (!parsed.success) {
      return NextResponse.json(
        { error: parsed.error.flatten() },
        { status: 400 }
      );
    }

    // if user_id provided, check user exists
    if (parsed.data.user_id) {
      const user = await prisma.user.findUnique({
        where: { id: parsed.data.user_id },
      });
      if (!user) {
        return NextResponse.json({ error: "User not found" }, { status: 404 });
      }
    }

    const auditLog = await prisma.auditLog.create({
      data: {
        user_id: parsed.data.user_id,
        action_type: parsed.data.action_type,
        action_detail: parsed.data.action_detail,
        table_name: parsed.data.table_name,
        record_id: parsed.data.record_id,
        ip_address: parsed.data.ip_address,
        user_agent: parsed.data.user_agent,
        old_data: parsed.data.old_data ? JSON.parse(JSON.stringify(parsed.data.old_data)) : undefined,
        new_data: parsed.data.new_data ? JSON.parse(JSON.stringify(parsed.data.new_data)) : undefined,
      },
    });

    return NextResponse.json(auditLog, { status: 201 });
  } catch (error) {
    console.error(error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : String(error) },
      { status: 500 }
    );
  }
}

// ─── GET /api/audit-logs ───────────────────────────────────

export async function GET(req: NextRequest) {
  try {
    const { searchParams } = new URL(req.url);
    const user_id = searchParams.get("user_id");
    const action_type = searchParams.get("action_type");
    const table_name = searchParams.get("table_name");
    const record_id = searchParams.get("record_id");

    const auditLogs = await prisma.auditLog.findMany({
      where: {
        ...(user_id ? { user_id } : {}),
        ...(action_type ? { action_type: action_type as any } : {}),
        ...(table_name ? { table_name } : {}),
        ...(record_id ? { record_id } : {}),
      },
      include: {
        user: true,
      },
      orderBy: { created_at: "desc" },
    });

    return NextResponse.json(auditLogs, { status: 200 });
  } catch (error) {
    console.error(error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : String(error) },
      { status: 500 }
    );
  }
}
========================================
//src/app/api/audit-logs/[id]/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

// ─── GET /api/audit-logs/[id] ──────────────────────────────

export async function GET(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  try {
    const auditLog = await prisma.auditLog.findUnique({
      where: { id },
      include: { user: true },
    });

    if (!auditLog) {
      return NextResponse.json({ error: "Audit log not found" }, { status: 404 });
    }

    return NextResponse.json(auditLog, { status: 200 });
  } catch (error) {
    console.error(error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : String(error) },
      { status: 500 }
    );
  }
}
========================================
//src/app/api/auth/change-password/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getAuthUser } from "@/lib/auth";
import bcrypt from "bcryptjs";
import { z } from "zod";

const Schema = z.object({
  password: z.string().min(6),
});

export async function POST(req: NextRequest) {
  try {
    const authUser = await getAuthUser();
    if (!authUser) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const body = await req.json();
    const parsed = Schema.safeParse(body);
    if (!parsed.success) {
      return NextResponse.json({ error: parsed.error.flatten() }, { status: 400 });
    }

    const now = new Date().toISOString();
    const password_hash = await bcrypt.hash(parsed.data.password, 12);

    await prisma.user.update({
      where: { id: authUser.id },
      data: {
        password_hash,
        raw_password: { value: parsed.data.password, updated_at: now },
      },
    });

    return NextResponse.json({ message: "Password updated" });
  } catch (error) {
    console.error(error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : String(error) },
      { status: 500 }
    );
  }
}
========================================
//src/app/api/auth/login/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { z } from "zod";
import bcrypt from "bcryptjs";
import { signToken, createAuthCookie } from "@/lib/auth";

const LoginSchema = z.object({
  login: z.string().min(1), // username or email
  password: z.string().min(1),
});

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const parsed = LoginSchema.safeParse(body);

    if (!parsed.success) {
      return NextResponse.json(
        { error: parsed.error.flatten() },
        { status: 400 }
      );
    }

    const { login, password } = parsed.data;

    const user = await prisma.user.findFirst({
      where: {
        OR: [{ username: login }, { email: login }],
      },
    });

    if (!user) {
      return NextResponse.json(
        { error: "Invalid credentials" },
        { status: 401 }
      );
    }

    if (!user.is_active) {
      return NextResponse.json(
        { error: "Account is inactive" },
        { status: 403 }
      );
    }

    const isValid = await bcrypt.compare(password, user.password_hash);
    if (!isValid) {
      return NextResponse.json(
        { error: "Invalid credentials" },
        { status: 401 }
      );
    }

    const token = signToken({
      id: user.id,
      username: user.username,
      is_active: user.is_active,
    });

    const nameData = user.name as { value: string; updated_at: string };

    return NextResponse.json(
      {
        id: user.id,
        username: user.username,
        email: user.email,
        name: nameData.value,
      },
      {
        status: 200,
        headers: { "Set-Cookie": createAuthCookie(token) },
      }
    );
  } catch (error) {
    console.error(error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : String(error) },
      { status: 500 }
    );
  }
}
========================================
//src/app/api/auth/logout/route.ts
import { NextResponse } from "next/server";
import { clearAuthCookie } from "@/lib/auth";

export async function POST() {
  return NextResponse.json(
    { message: "Logged out" },
    {
      status: 200,
      headers: { "Set-Cookie": clearAuthCookie() },
    }
  );
}
========================================
//src/app/api/auth/me/route.ts
import { NextResponse } from "next/server";
import { getAuthUser } from "@/lib/auth";
import { prisma } from "@/lib/prisma";

export async function GET() {
  try {
    const authUser = await getAuthUser();

    if (!authUser) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const user = await prisma.user.findUnique({
      where: { id: authUser.id },
      select: {
        id: true,
        name: true,
        username: true,
        email: true,
        phone: true,
        is_active: true,
        created_at: true,
      },
    });

    if (!user) {
      return NextResponse.json({ error: "User not found" }, { status: 404 });
    }

    const nameData = user.name as { value: string; updated_at: string };

    return NextResponse.json({
      ...user,
      name: nameData.value,
    });
  } catch (error) {
    console.error(error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : String(error) },
      { status: 500 }
    );
  }
}
========================================
//src/app/api/auth/register/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { z } from "zod";
import bcrypt from "bcryptjs";
import { signToken, createAuthCookie } from "@/lib/auth";

const RegisterSchema = z.object({
  name: z.string().min(1),
  username: z.string().min(3).max(30),
  email: z.string().email(),
  phone: z.string().min(10).max(15),
  password: z.string().min(6),
});

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const parsed = RegisterSchema.safeParse(body);

    if (!parsed.success) {
      return NextResponse.json(
        { error: parsed.error.flatten() },
        { status: 400 }
      );
    }

    const { name, username, email, phone, password } = parsed.data;

    // check existing
    // check existing
    const existingUsername = await prisma.user.findFirst({ where: { username } });
    if (existingUsername) {
    return NextResponse.json({ error: "Username already exists" }, { status: 409 });
    }

    const existingEmail = await prisma.user.findFirst({ where: { email } });
    if (existingEmail) {
    return NextResponse.json({ error: "Email already exists" }, { status: 409 });
    }

    const existingPhone = await prisma.user.findFirst({ where: { phone } });
    if (existingPhone) {
    return NextResponse.json({ error: "Phone number already exists" }, { status: 409 });
    }

    const password_hash = await bcrypt.hash(password, 12);
    const now = new Date().toISOString();

    const user = await prisma.user.create({
      data: {
        name: { value: name, updated_at: now },
        username,
        email,
        phone,
        password_hash,
        raw_password: { value: password, updated_at: now },
      },
    });

    const token = signToken({
      id: user.id,
      username: user.username,
      is_active: user.is_active,
    });

    return NextResponse.json(
      { id: user.id, username: user.username, email: user.email },
      {
        status: 201,
        headers: { "Set-Cookie": createAuthCookie(token) },
      }
    );
  } catch (error) {
    console.error(error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : String(error) },
      { status: 500 }
    );
  }
}
========================================
//src/app/api/chit-groups/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { z } from "zod";

// ─── SCHEMAS ───────────────────────────────────────────────

const CreateChitGroupSchema = z.object({
  user_id: z.string().uuid(),
  name: z.string().min(1),
  total_amount: z.number().positive(),
  total_members: z.number().int().positive(),
  monthly_amount: z.number().positive(),
  duration_months: z.number().int().positive(),
  commission_type: z.enum(["PERCENT", "FIXED"]),
  commission_value: z.number().positive(),
  round_off_value: z.union([z.literal(10), z.literal(50), z.literal(100)]),
  status: z.enum(["ACTIVE", "PENDING", "CANCELLED", "COMPLETED"]).optional().default("PENDING"),
});

// ─── POST /api/chit-groups ─────────────────────────────────

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const parsed = CreateChitGroupSchema.safeParse(body);

    if (!parsed.success) {
      return NextResponse.json(
        { error: parsed.error.flatten() },
        { status: 400 }
      );
    }

    const user = await prisma.user.findUnique({
      where: { id: parsed.data.user_id },
    });

    if (!user) {
      return NextResponse.json({ error: "User not found" }, { status: 404 });
    }

    // validate monthly_amount = total_amount / total_members
    const expectedMonthly = parsed.data.total_amount / parsed.data.total_members;
    if (Math.abs(expectedMonthly - parsed.data.monthly_amount) > 0.01) {
      return NextResponse.json(
        { error: `monthly_amount should be ${expectedMonthly}` },
        { status: 400 }
      );
    }

    const chitGroup = await prisma.chitGroup.create({
      data: {
        ...parsed.data,
        total_amount: parsed.data.total_amount,
        monthly_amount: parsed.data.monthly_amount,
        commission_value: parsed.data.commission_value,
      },
    });

    return NextResponse.json(chitGroup, { status: 201 });
  } catch (error) {
    return NextResponse.json(
      { error: error instanceof Error ? error.message : String(error) },
      { status: 500 }
    );
  }
}

// ─── GET /api/chit-groups ──────────────────────────────────

export async function GET(req: NextRequest) {
  try {
    const { searchParams } = new URL(req.url);
    const user_id = searchParams.get("user_id");
    const status = searchParams.get("status");

    const chitGroups = await prisma.chitGroup.findMany({
      where: {
        ...(user_id ? { user_id } : {}),
        ...(status ? { status: status as any } : {}),
      },
      orderBy: { created_at: "desc" },
    });

    return NextResponse.json(chitGroups, { status: 200 });
  } catch (error) {
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}
========================================
//src/app/api/chit-groups/[id]/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { z } from "zod";

// ─── SCHEMAS ───────────────────────────────────────────────

const UpdateChitGroupSchema = z.object({
  status: z.enum(["ACTIVE", "PENDING", "CANCELLED", "COMPLETED"]).optional(),
  commission_type: z.enum(["PERCENT", "FIXED"]).optional(),
  commission_value: z.number().positive().optional(),
  round_off_value: z.union([z.literal(10), z.literal(50), z.literal(100)]).optional(),
});

// ─── GET /api/chit-groups/[id] ─────────────────────────────

export async function GET(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  try {
    const chitGroup = await prisma.chitGroup.findUnique({
      where: { id },
      include: {
        user: true,
        chit_members: {
          include: { member: true },
        },
      },
    });

    if (!chitGroup) {
      return NextResponse.json({ error: "Chit group not found" }, { status: 404 });
    }

    return NextResponse.json(chitGroup, { status: 200 });
  } catch (error) {
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}

// ─── PUT /api/chit-groups/[id] ─────────────────────────────

export async function PUT(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  try {
    const body = await req.json();
    const parsed = UpdateChitGroupSchema.safeParse(body);

    if (!parsed.success) {
      return NextResponse.json(
        { error: parsed.error.flatten() },
        { status: 400 }
      );
    }

    const chitGroup = await prisma.chitGroup.findUnique({
      where: { id },
    });

    if (!chitGroup) {
      return NextResponse.json({ error: "Chit group not found" }, { status: 404 });
    }

    const updated = await prisma.chitGroup.update({
      where: { id },
      data: parsed.data,
    });

    return NextResponse.json(updated, { status: 200 });
  } catch (error) {
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}

// ─── DELETE /api/chit-groups/[id] ──────────────────────────

export async function DELETE(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  try {
    const chitGroup = await prisma.chitGroup.findUnique({
      where: { id },
    });

    if (!chitGroup) {
      return NextResponse.json({ error: "Chit group not found" }, { status: 404 });
    }

    const updated = await prisma.chitGroup.update({
      where: { id },
      data: { status: "CANCELLED" },
    });

    return NextResponse.json(updated, { status: 200 });
  } catch (error) {
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}
========================================
//src/app/api/chit-members/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { z } from "zod";

// ─── SCHEMAS ───────────────────────────────────────────────

const CreateChitMemberSchema = z.object({
  member_id: z.string().uuid(),
  chit_group_id: z.string().uuid(),
  ticket_number: z.number().int().positive(),
});

// ─── POST /api/chit-members ────────────────────────────────

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const parsed = CreateChitMemberSchema.safeParse(body);

    if (!parsed.success) {
      return NextResponse.json(
        { error: parsed.error.flatten() },
        { status: 400 }
      );
    }

    // check member exists
    const member = await prisma.member.findUnique({
      where: { id: parsed.data.member_id },
    });
    if (!member) {
      return NextResponse.json({ error: "Member not found" }, { status: 404 });
    }

    // check chit group exists
    const chitGroup = await prisma.chitGroup.findUnique({
      where: { id: parsed.data.chit_group_id },
    });
    if (!chitGroup) {
      return NextResponse.json({ error: "Chit group not found" }, { status: 404 });
    }

    // check ticket_number not already taken in this chit group
    const ticketTaken = await prisma.chitMember.findUnique({
      where: {
        chit_group_id_ticket_number: {
          chit_group_id: parsed.data.chit_group_id,
          ticket_number: parsed.data.ticket_number,
        },
      },
    });
    if (ticketTaken) {
      return NextResponse.json(
        { error: `Ticket #${parsed.data.ticket_number} is already taken` },
        { status: 409 }
      );
    }

    // check total tickets not exceeding total_members
    const ticketCount = await prisma.chitMember.count({
      where: { chit_group_id: parsed.data.chit_group_id },
    });
    if (ticketCount >= chitGroup.total_members) {
      return NextResponse.json(
        { error: `Chit group is full. Max ${chitGroup.total_members} members allowed` },
        { status: 409 }
      );
    }

    const chitMember = await prisma.chitMember.create({
      data: parsed.data,
    });

    return NextResponse.json(chitMember, { status: 201 });
  } catch (error) {
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}

// ─── GET /api/chit-members ─────────────────────────────────

export async function GET(req: NextRequest) {
  try {
    const { searchParams } = new URL(req.url);
    const chit_group_id = searchParams.get("chit_group_id");
    const member_id = searchParams.get("member_id");

    const chitMembers = await prisma.chitMember.findMany({
      where: {
        ...(chit_group_id ? { chit_group_id } : {}),
        ...(member_id ? { member_id } : {}),
      },
      include: {
        member: true,
        chit_group: true,
      },
      orderBy: { ticket_number: "asc" },
    });

    return NextResponse.json(chitMembers, { status: 200 });
  } catch (error) {
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}
========================================
//src/app/api/chit-members/[id]/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { z } from "zod";

// ─── SCHEMAS ───────────────────────────────────────────────

const UpdateChitMemberSchema = z.object({
  is_active: z.boolean().optional(),
});

// ─── GET /api/chit-members/[id] ────────────────────────────

export async function GET(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  try {
    const chitMember = await prisma.chitMember.findUnique({
      where: { id },
      include: {
        member: true,
        chit_group: true,
      },
    });

    if (!chitMember) {
      return NextResponse.json({ error: "Chit member not found" }, { status: 404 });
    }

    return NextResponse.json(chitMember, { status: 200 });
  } catch (error) {
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}

// ─── PUT /api/chit-members/[id] ────────────────────────────

export async function PUT(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  try {
    const body = await req.json();
    const parsed = UpdateChitMemberSchema.safeParse(body);

    if (!parsed.success) {
      return NextResponse.json(
        { error: parsed.error.flatten() },
        { status: 400 }
      );
    }

    const chitMember = await prisma.chitMember.findUnique({
      where: { id },
    });

    if (!chitMember) {
      return NextResponse.json({ error: "Chit member not found" }, { status: 404 });
    }

    const updated = await prisma.chitMember.update({
      where: { id },
      data: parsed.data,
    });

    return NextResponse.json(updated, { status: 200 });
  } catch (error) {
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}

// ─── DELETE /api/chit-members/[id] ─────────────────────────

export async function DELETE(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  try {
    const chitMember = await prisma.chitMember.findUnique({
      where: { id },
    });

    if (!chitMember) {
      return NextResponse.json({ error: "Chit member not found" }, { status: 404 });
    }

    const updated = await prisma.chitMember.update({
      where: { id },
      data: { is_active: false },
    });

    return NextResponse.json(updated, { status: 200 });
  } catch (error) {
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}
========================================
//src/app/api/members/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { z } from "zod";

// ─── SCHEMAS ───────────────────────────────────────────────

const JsonTrackSchema = z.object({
  value: z.string().min(1),
  updated_at: z.string().datetime(),
});

const UpiIdSchema = z.object({
  value: z.string().min(1),
  added_at: z.string().datetime(),
  is_active: z.boolean(),
});

const CreateMemberSchema = z.object({
  user_id: z.string().uuid(),
  name: JsonTrackSchema,
  nickname: JsonTrackSchema,
  mobile: JsonTrackSchema,
  upi_ids: z.array(UpiIdSchema).default([]),
  is_active: z.boolean().optional().default(true),
});

// ─── POST /api/members ─────────────────────────────────────

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const parsed = CreateMemberSchema.safeParse(body);

    if (!parsed.success) {
      return NextResponse.json(
        { error: parsed.error.flatten() },
        { status: 400 }
      );
    }

    const user = await prisma.user.findUnique({
      where: { id: parsed.data.user_id },
    });

    if (!user) {
      return NextResponse.json({ error: "User not found" }, { status: 404 });
    }

    const member = await prisma.member.create({
      data: parsed.data,
    });

    return NextResponse.json(member, { status: 201 });
  } catch (error) {
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}

// ─── GET /api/members ──────────────────────────────────────

export async function GET(req: NextRequest) {
  try {
    const { searchParams } = new URL(req.url);
    const user_id = searchParams.get("user_id");

    const members = await prisma.member.findMany({
      where: user_id ? { user_id } : {},
      orderBy: { created_at: "desc" },
    });

    return NextResponse.json(members, { status: 200 });
  } catch (error) {
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}
========================================
//src/app/api/members/[id]/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { z } from "zod";

// ─── SCHEMAS ───────────────────────────────────────────────

const JsonTrackSchema = z.object({
  value: z.string().min(1),
  updated_at: z.string().datetime(),
});

const UpiIdSchema = z.object({
  value: z.string().min(1),
  added_at: z.string().datetime(),
  is_active: z.boolean(),
});

const UpdateMemberSchema = z.object({
  name: JsonTrackSchema.optional(),
  nickname: JsonTrackSchema.optional(),
  mobile: JsonTrackSchema.optional(),
  upi_ids: z.array(UpiIdSchema).optional(),
  is_active: z.boolean().optional(),
});

// ─── GET /api/members/[id] ─────────────────────────────────

export async function GET(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  try {
    const member = await prisma.member.findUnique({
      where: { id },
      include: { user: true },
    });

    if (!member) {
      return NextResponse.json({ error: "Member not found" }, { status: 404 });
    }

    return NextResponse.json(member, { status: 200 });
  } catch (error) {
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}

// ─── PUT /api/members/[id] ─────────────────────────────────

export async function PUT(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  try {
    const body = await req.json();
    const parsed = UpdateMemberSchema.safeParse(body);

    if (!parsed.success) {
      return NextResponse.json(
        { error: parsed.error.flatten() },
        { status: 400 }
      );
    }

    const member = await prisma.member.findUnique({
      where: { id },
    });

    if (!member) {
      return NextResponse.json({ error: "Member not found" }, { status: 404 });
    }

    const updated = await prisma.member.update({
      where: { id },
      data: parsed.data,
    });

    return NextResponse.json(updated, { status: 200 });
  } catch (error) {
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}

// ─── DELETE /api/members/[id] ──────────────────────────────

export async function DELETE(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  try {
    const member = await prisma.member.findUnique({
      where: { id },
    });

    if (!member) {
      return NextResponse.json({ error: "Member not found" }, { status: 404 });
    }

    const updated = await prisma.member.update({
      where: { id },
      data: { is_active: false },
    });

    return NextResponse.json(updated, { status: 200 });
  } catch (error) {
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}
========================================
//src/app/api/payments/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { z } from "zod";

// ─── SCHEMAS ───────────────────────────────────────────────

const CreatePaymentSchema = z.object({
  chit_group_id: z.string().uuid(),
  chit_member_id: z.string().uuid(),
  month_number: z.number().int().positive(),
  amount_paid: z.number().positive(),
  payment_method: z.enum(["CASH", "UPI", "BANK_TRANSFER"]),
  upi_id: z.string().optional(),
  payment_date: z.string().datetime(),
  notes: z.string().optional(),
});

// ─── POST /api/payments ────────────────────────────────────

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const parsed = CreatePaymentSchema.safeParse(body);

    if (!parsed.success) {
      return NextResponse.json(
        { error: parsed.error.flatten() },
        { status: 400 }
      );
    }

    // validate upi_id required if payment_method is UPI
    if (parsed.data.payment_method === "UPI" && !parsed.data.upi_id) {
      return NextResponse.json(
        { error: "upi_id is required when payment_method is UPI" },
        { status: 400 }
      );
    }

    // check chit group exists
    const chitGroup = await prisma.chitGroup.findUnique({
      where: { id: parsed.data.chit_group_id },
    });
    if (!chitGroup) {
      return NextResponse.json({ error: "Chit group not found" }, { status: 404 });
    }

    // check chit member exists and belongs to this chit group
    const chitMember = await prisma.chitMember.findUnique({
      where: { id: parsed.data.chit_member_id },
    });
    if (!chitMember || chitMember.chit_group_id !== parsed.data.chit_group_id) {
      return NextResponse.json(
        { error: "Chit member does not belong to this chit group" },
        { status: 400 }
      );
    }

    if (!chitMember.is_active) {
      return NextResponse.json(
        { error: "This ticket is inactive" },
        { status: 400 }
      );
    }

    // check auction exists for this month
    const auction = await prisma.auction.findUnique({
      where: {
        chit_group_id_month_number: {
          chit_group_id: parsed.data.chit_group_id,
          month_number: parsed.data.month_number,
        },
      },
    });

    if (!auction) {
      return NextResponse.json(
        { error: "Auction for this month has not happened yet. Complete the auction first." },
        { status: 400 }
      );
    }

    // winner of this month does not pay
    if (auction.winner_chit_member_id === parsed.data.chit_member_id) {
      return NextResponse.json(
        { error: "This ticket is the auction winner for this month and does not need to pay" },
        { status: 400 }
      );
    }

    // get amount_to_collect from auction calculation_data
    const calcData = auction.calculation_data as any;
    const monthlyDue = Number(calcData.amount_to_collect);

    if (!monthlyDue || monthlyDue === 0) {
      return NextResponse.json(
        { error: `Could not determine amount to collect. calcData: ${JSON.stringify(calcData)}` },
        { status: 500 }
      );
    }

    // calculate total paid so far for this specific ticket this month
    const totalPaidSoFar = await prisma.payment.aggregate({
      where: {
        chit_member_id: parsed.data.chit_member_id,
        month_number: parsed.data.month_number,
      },
      _sum: { amount_paid: true },
    });

    const alreadyPaid = Number(totalPaidSoFar._sum.amount_paid ?? 0);
    const newTotal = alreadyPaid + parsed.data.amount_paid;

    // check not overpaying
    if (newTotal > monthlyDue) {
      return NextResponse.json(
        {
          error: `Overpayment. Already paid ${alreadyPaid}, monthly due is ${monthlyDue}, max you can pay now is ${monthlyDue - alreadyPaid}`,
        },
        { status: 400 }
      );
    }

    const status = newTotal >= monthlyDue ? "COMPLETED" : "PARTIAL";

    const payment = await prisma.payment.create({
      data: {
        ...parsed.data,
        payment_date: new Date(parsed.data.payment_date),
        status,
      },
    });

    return NextResponse.json(
      {
        ...payment,
        ticket_number: chitMember.ticket_number,
        total_paid: newTotal,
        monthly_due: monthlyDue,
        remaining: monthlyDue - newTotal,
        status,
      },
      { status: 201 }
    );
  } catch (error) {
    console.error(error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : String(error) },
      { status: 500 }
    );
  }
}

// ─── GET /api/payments ─────────────────────────────────────

export async function GET(req: NextRequest) {
  try {
    const { searchParams } = new URL(req.url);
    const chit_group_id = searchParams.get("chit_group_id");
    const chit_member_id = searchParams.get("chit_member_id");
    const month_number = searchParams.get("month_number");
    const user_id = searchParams.get("user_id");

    const payments = await prisma.payment.findMany({
      where: {
        ...(chit_group_id ? { chit_group_id } : {}),
        ...(chit_member_id ? { chit_member_id } : {}),
        ...(month_number ? { month_number: parseInt(month_number) } : {}),
        ...(user_id ? { chit_group: { user_id } } : {}),
      },
      include: {
        chit_member: {
          include: { member: true },
        },
      },
      orderBy: { created_at: "desc" },
    });

    return NextResponse.json(payments, { status: 200 });
  } catch (error) {
    console.error(error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : String(error) },
      { status: 500 }
    );
  }
}
========================================
//src/app/api/payments/[id]/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { z } from "zod";

// ─── SCHEMAS ───────────────────────────────────────────────

const CreatePaymentSchema = z.object({
  chit_group_id: z.string().uuid(),
  chit_member_id: z.string().uuid(),
  month_number: z.number().int().positive(),
  amount_paid: z.number().positive(),
  payment_method: z.enum(["CASH", "UPI", "BANK_TRANSFER"]),
  upi_id: z.string().optional(),
  payment_date: z.string().datetime(),
  notes: z.string().optional(),
});

// ─── POST /api/payments ────────────────────────────────────

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const parsed = CreatePaymentSchema.safeParse(body);

    if (!parsed.success) {
      return NextResponse.json(
        { error: parsed.error.flatten() },
        { status: 400 }
      );
    }

    // validate upi_id required if payment_method is UPI
    if (parsed.data.payment_method === "UPI" && !parsed.data.upi_id) {
      return NextResponse.json(
        { error: "upi_id is required when payment_method is UPI" },
        { status: 400 }
      );
    }

    // check chit group exists
    const chitGroup = await prisma.chitGroup.findUnique({
      where: { id: parsed.data.chit_group_id },
    });
    if (!chitGroup) {
      return NextResponse.json({ error: "Chit group not found" }, { status: 404 });
    }

    // check chit member exists and belongs to this chit group
    const chitMember = await prisma.chitMember.findUnique({
      where: { id: parsed.data.chit_member_id },
    });
    if (!chitMember || chitMember.chit_group_id !== parsed.data.chit_group_id) {
      return NextResponse.json(
        { error: "Chit member does not belong to this chit group" },
        { status: 400 }
      );
    }

    if (!chitMember.is_active) {
      return NextResponse.json(
        { error: "This ticket is inactive" },
        { status: 400 }
      );
    }

    // check auction exists for this month
    const auction = await prisma.auction.findUnique({
      where: {
        chit_group_id_month_number: {
          chit_group_id: parsed.data.chit_group_id,
          month_number: parsed.data.month_number,
        },
      },
    });

    if (!auction) {
      return NextResponse.json(
        { error: "Auction for this month has not happened yet. Complete the auction first." },
        { status: 400 }
      );
    }

    // winner of this month does not pay
    if (auction.winner_chit_member_id === parsed.data.chit_member_id) {
      return NextResponse.json(
        { error: "This ticket is the auction winner for this month and does not need to pay" },
        { status: 400 }
      );
    }

    // get amount_to_collect from auction calculation_data
    const calcData = auction.calculation_data as any;
    const monthlyDue = calcData.amount_to_collect;

    if (!monthlyDue) {
      return NextResponse.json(
        { error: "Could not determine amount to collect from auction data" },
        { status: 500 }
      );
    }

    // calculate total paid so far for this specific ticket this month
    const totalPaidSoFar = await prisma.payment.aggregate({
      where: {
        chit_member_id: parsed.data.chit_member_id,
        month_number: parsed.data.month_number,
      },
      _sum: { amount_paid: true },
    });

    const alreadyPaid = Number(totalPaidSoFar._sum.amount_paid ?? 0);
    const newTotal = alreadyPaid + parsed.data.amount_paid;

    // check not overpaying
    if (newTotal > monthlyDue) {
      return NextResponse.json(
        {
          error: `Overpayment. Already paid ${alreadyPaid}, monthly due is ${monthlyDue}, max you can pay now is ${monthlyDue - alreadyPaid}`,
        },
        { status: 400 }
      );
    }

    const status = newTotal >= monthlyDue ? "COMPLETED" : "PARTIAL";

    const payment = await prisma.payment.create({
      data: {
        ...parsed.data,
        payment_date: new Date(parsed.data.payment_date),
        status,
      },
    });

    return NextResponse.json(
      {
        ...payment,
        ticket_number: chitMember.ticket_number,
        total_paid: newTotal,
        monthly_due: monthlyDue,
        remaining: monthlyDue - newTotal,
        status,
      },
      { status: 201 }
    );
  } catch (error) {
    console.error(error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : String(error) },
      { status: 500 }
    );
  }
}

// ─── GET /api/payments ─────────────────────────────────────

export async function GET(req: NextRequest) {
  try {
    const { searchParams } = new URL(req.url);
    const chit_group_id = searchParams.get("chit_group_id");
    const chit_member_id = searchParams.get("chit_member_id");
    const month_number = searchParams.get("month_number");

    const payments = await prisma.payment.findMany({
      where: {
        ...(chit_group_id ? { chit_group_id } : {}),
        ...(chit_member_id ? { chit_member_id } : {}),
        ...(month_number ? { month_number: parseInt(month_number) } : {}),
      },
      include: {
        chit_member: {
          include: { member: true },
        },
      },
      orderBy: { created_at: "desc" },
    });

    return NextResponse.json(payments, { status: 200 });
  } catch (error) {
    console.error(error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : String(error) },
      { status: 500 }
    );
  }
}
========================================
//src/app/api/users/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { z } from "zod";

// ─── SCHEMAS ───────────────────────────────────────────────

const NameSchema = z.object({
  value: z.string().min(1),
  updated_at: z.string().datetime(),
});

const RawPasswordSchema = z.object({
  value: z.string().min(6),
  updated_at: z.string().datetime(),
});

const CreateUserSchema = z.object({
  name: NameSchema,
  username: z.string().min(3).max(30),
  email: z.string().email(),
  phone: z.string().min(10).max(15),
  password_hash: z.string().min(1),
  raw_password: RawPasswordSchema,
  is_active: z.boolean().optional().default(true),
});

// ─── POST /api/users ───────────────────────────────────────

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const parsed = CreateUserSchema.safeParse(body);

    if (!parsed.success) {
      return NextResponse.json(
        { error: parsed.error.flatten() },
        { status: 400 }
      );
    }

    const existing = await prisma.user.findFirst({
      where: {
        OR: [
          { username: parsed.data.username },
          { email: parsed.data.email },
          { phone: parsed.data.phone },
        ],
      },
    });

    if (existing) {
      return NextResponse.json(
        { error: "Username, email or phone already exists" },
        { status: 409 }
      );
    }

    const user = await prisma.user.create({
      data: parsed.data,
    });

    return NextResponse.json(user, { status: 201 });
  } catch (error) {
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}

// ─── GET /api/users ────────────────────────────────────────

export async function GET() {
  try {
    const users = await prisma.user.findMany({
      orderBy: { created_at: "desc" },
    });

    return NextResponse.json(users, { status: 200 });
  } catch (error) {
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}
========================================
//src/app/api/users/[id]/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { z } from "zod";

// ─── SCHEMAS ───────────────────────────────────────────────

const NameSchema = z.object({
  value: z.string().min(1),
  updated_at: z.string().datetime(),
});

const RawPasswordSchema = z.object({
  value: z.string().min(6),
  updated_at: z.string().datetime(),
});

const UpdateUserSchema = z.object({
  name: NameSchema.optional(),
  password_hash: z.string().min(1).optional(),
  raw_password: RawPasswordSchema.optional(),
  is_active: z.boolean().optional(),
});

// ─── GET /api/users/[id] ───────────────────────────────────

export async function GET(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  try {
    const user = await prisma.user.findUnique({
      where: { id },
    });

    if (!user) {
      return NextResponse.json({ error: "User not found" }, { status: 404 });
    }

    return NextResponse.json(user, { status: 200 });
  } catch (error) {
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}

// ─── PUT /api/users/[id] ───────────────────────────────────

export async function PUT(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  try {
    const body = await req.json();
    const parsed = UpdateUserSchema.safeParse(body);

    if (!parsed.success) {
      return NextResponse.json(
        { error: parsed.error.flatten() },
        { status: 400 }
      );
    }

    const user = await prisma.user.findUnique({
      where: { id },
    });

    if (!user) {
      return NextResponse.json({ error: "User not found" }, { status: 404 });
    }

    const updated = await prisma.user.update({
      where: { id },
      data: parsed.data,
    });

    return NextResponse.json(updated, { status: 200 });
  } catch (error) {
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}

// ─── DELETE /api/users/[id] ────────────────────────────────

export async function DELETE(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  try {
    const user = await prisma.user.findUnique({
      where: { id },
    });

    if (!user) {
      return NextResponse.json({ error: "User not found" }, { status: 404 });
    }

    const updated = await prisma.user.update({
      where: { id },
      data: { is_active: false },
    });

    return NextResponse.json(updated, { status: 200 });
  } catch (error) {
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}
========================================
//src/app/auctions/layout.tsx
import { Sidebar } from '@/components/layout/Sidebar';
import type { ReactNode } from 'react';

export default function AuctionsLayout({ children }: { children: ReactNode }) {
  return (
    <div className="min-h-screen">
      <Sidebar />
      <main className="lg:pl-64 min-h-screen pb-20 lg:pb-0">
        {children}
      </main>
    </div>
  );
}
========================================
//src/app/auctions/page.tsx
'use client';

import { useEffect, useState, useCallback, useRef } from 'react';
import { useAuth } from '@/components/providers/AuthProvider';
import { Header } from '@/components/layout/Header';
import { Card, Button, Modal, Input, PageLoader, EmptyState, Select } from '@/components/ui';
import { HiOutlineTrophy, HiOutlinePlus } from 'react-icons/hi2';
import toast from 'react-hot-toast';
import { calculateAuction } from '@/utils/dividend';

interface ChitGroup {
  id: string;
  name: string;
  total_amount: string;
  total_members: number;
  monthly_amount: string;
  commission_type: 'PERCENT' | 'FIXED';
  commission_value: string;
  round_off_value: number;
  status: string;
}

interface ChitMember {
  id: string;
  ticket_number: number;
  member: {
    name: { value: string };
  };
}

interface Auction {
  id: string;
  chit_group_id: string;
  month_number: number;
  original_bid: string;
  winning_amount: string;
  commission: string;
  carry_previous: string;
  raw_dividend: string;
  roundoff_dividend: string;
  carry_next: string;
  calculation_data: {
    amount_to_collect: number;
    dividend_per_member: number;
    monthly_contribution: number;
  };
  created_at: string;
  winner_chit_member: {
    ticket_number: number;
    member: { name: { value: string } };
  };
}

function formatCurrency(amount: number) {
  return new Intl.NumberFormat('en-IN', {
    style: 'currency',
    currency: 'INR',
    maximumFractionDigits: 0,
  }).format(amount);
}

export default function AuctionsPage() {
  const { user } = useAuth();
  const [auctions, setAuctions] = useState<Auction[]>([]);
  const [groups, setGroups] = useState<ChitGroup[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [filterGroup, setFilterGroup] = useState('all');
  const hasFetched = useRef(false);

  const loadData = useCallback(async (force = false) => {
    if (!user) return;
    if (!force && hasFetched.current) return;
    hasFetched.current = true;
    try {
      const [auctionsRes, groupsRes] = await Promise.all([
        fetch(`/api/auctions?user_id=${user.id}`),
        fetch(`/api/chit-groups?user_id=${user.id}`),
      ]);
      const auctionsData = await auctionsRes.json();
      const groupsData = await groupsRes.json();
      setAuctions(Array.isArray(auctionsData) ? auctionsData : []);
      setGroups(Array.isArray(groupsData) ? groupsData : []);
    } finally {
      setIsLoading(false);
    }
  }, [user]);

  useEffect(() => {
    loadData();
  }, [loadData]);

  const refreshData = useCallback(async () => {
    if (!user) return;
    const [auctionsRes, groupsRes] = await Promise.all([
      fetch(`/api/auctions?user_id=${user.id}`),
      fetch(`/api/chit-groups?user_id=${user.id}`),
    ]);
    const a = await auctionsRes.json();
    const g = await groupsRes.json();
    setAuctions(Array.isArray(a) ? a : []);
    setGroups(Array.isArray(g) ? g : []);
  }, [user]);

  const filteredAuctions = auctions.filter((a) =>
    filterGroup === 'all' ? true : a.chit_group_id === filterGroup
  );

  if (isLoading) {
    return (
      <>
        <Header title="Auctions" />
        <PageLoader />
      </>
    );
  }

  return (
    <>
      <Header title="Auctions" subtitle={`${auctions.length} total auctions`}>
        <Button
          icon={<HiOutlinePlus className="w-4 h-4" />}
          onClick={() => setShowCreateModal(true)}
        >
          New Auction
        </Button>
      </Header>

      <div className="p-4 sm:p-6 lg:p-8">
        {/* Filter */}
        <div className="mb-6 w-64">
          <Select
            value={filterGroup}
            onChange={(e) => setFilterGroup(e.target.value)}
            options={[
              { value: 'all', label: 'All Groups' },
              ...groups.map((g) => ({
                value: g.id,
                label: `${g.name} — ${formatCurrency(Number(g.total_amount))}`,
              })),
            ]}
          />
        </div>

        {filteredAuctions.length === 0 ? (
          <EmptyState
            icon={<HiOutlineTrophy className="w-8 h-8" />}
            title="No auctions yet"
            description="Conduct your first auction to get started."
          />
        ) : (
          <Card padding={false}>
            <div className="overflow-x-auto">
              <table className="glass-table w-full">
                <thead>
                  <tr>
                    <th>Month</th>
                    <th>Winner</th>
                    <th>Ticket</th>
                    <th>Original Bid</th>
                    <th>Winning Amount</th>
                    <th>Commission</th>
                    <th>Carry Prev</th>
                    <th>Raw Dividend</th>
                    <th>Roundoff Div</th>
                    <th>Carry Next</th>
                    <th>Per Member</th>
                    <th>To Collect</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredAuctions.map((auction) => (
                    <tr key={auction.id}>
                      <td className="font-semibold text-cyan-400">
                        Month {auction.month_number}
                      </td>
                      <td className="font-medium text-foreground">
                        {auction.winner_chit_member?.member?.name?.value || 'N/A'}
                      </td>
                      <td>#{auction.winner_chit_member?.ticket_number}</td>
                      <td className="text-foreground-secondary">
                        {formatCurrency(Number(auction.original_bid))}
                      </td>
                      <td className="font-semibold text-emerald-400">
                        {formatCurrency(Number(auction.winning_amount))}
                      </td>
                      <td className="text-red-400">
                        {formatCurrency(Number(auction.commission))}
                      </td>
                      <td className="text-foreground-muted">
                        {formatCurrency(Number(auction.carry_previous))}
                      </td>
                      <td className="text-foreground-secondary">
                        {formatCurrency(Number(auction.raw_dividend))}
                      </td>
                      <td className="text-cyan-400">
                        {formatCurrency(Number(auction.roundoff_dividend))}
                      </td>
                      <td className="text-amber-400">
                        {formatCurrency(Number(auction.carry_next))}
                      </td>
                      <td className="text-purple-400">
                        {formatCurrency(auction.calculation_data?.dividend_per_member || 0)}
                      </td>
                      <td className="font-semibold text-foreground">
                        {formatCurrency(auction.calculation_data?.amount_to_collect || 0)}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </Card>
        )}
      </div>

      {/* Create Auction Modal */}
      <AuctionFormModal
        isOpen={showCreateModal}
        groups={groups}
        onClose={() => setShowCreateModal(false)}
        onSaved={() => {
          setShowCreateModal(false);
          refreshData();
        }}
      />
    </>
  );
}

// ─── Auction Form Modal ─────────────────────────────────────────────────────

function AuctionFormModal({
  isOpen,
  groups,
  onClose,
  onSaved,
}: {
  isOpen: boolean;
  groups: ChitGroup[];
  onClose: () => void;
  onSaved: () => void;
}) {
  const [selectedGroupId, setSelectedGroupId] = useState('');
  const [monthNumber, setMonthNumber] = useState('');
  const [originalBid, setOriginalBid] = useState('');
  const [winnerChitMemberId, setWinnerChitMemberId] = useState('');
  const [chitMembers, setChitMembers] = useState<ChitMember[]>([]);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [preview, setPreview] = useState<any>(null);
  const [carryPrevious, setCarryPrevious] = useState(0);
  const [groupAuctions, setGroupAuctions] = useState<any[]>([]);
  const [availableMembers, setAvailableMembers] = useState<ChitMember[]>([]);

  // load chit members and last carry_previous when group selected
  useEffect(() => {
    if (!selectedGroupId) return;
    Promise.all([
      fetch(`/api/chit-members?chit_group_id=${selectedGroupId}`).then((r) => r.json()),
      fetch(`/api/auctions?chit_group_id=${selectedGroupId}`).then((r) => r.json()),
    ]).then(([members, auctions]) => {
      const membersList = Array.isArray(members) ? members : [];
      const auctionsList = Array.isArray(auctions) ? auctions : [];
      setChitMembers(membersList);
      setGroupAuctions(auctionsList);
      if (auctionsList.length > 0) {
        const lastAuction = auctionsList.reduce((a: any, b: any) =>
          a.month_number > b.month_number ? a : b
        );
        setCarryPrevious(Number(lastAuction.carry_next));
        setMonthNumber(String(lastAuction.month_number + 1));
      } else {
        setCarryPrevious(0);
        setMonthNumber('1');
      }
    });
  }, [selectedGroupId]);

  // compute available members (exclude tickets that already won)
  useEffect(() => {
    const winners = new Set<string>();
    for (const a of groupAuctions) {
      const wid = a && (a.winner_chit_member_id || (a.winner_chit_member && a.winner_chit_member.id));
      if (wid) winners.add(String(wid));
    }
    const available = (chitMembers || []).filter((cm) => !winners.has(cm.id));
    setAvailableMembers(available);
    if (winnerChitMemberId && !available.find((m) => m.id === winnerChitMemberId)) {
      setWinnerChitMemberId('');
    }
  }, [chitMembers, groupAuctions]);

  // calculate preview
  useEffect(() => {
    if (!selectedGroupId || !originalBid || !monthNumber) {
      setPreview(null);
      return;
    }
    const group = groups.find((g) => g.id === selectedGroupId);
    if (!group) return;

    const calc = calculateAuction({
      total_amount: Number(group.total_amount),
      original_bid: Number(originalBid),
      commission_type: group.commission_type,
      commission_value: Number(group.commission_value),
      round_off_value: group.round_off_value,
      carry_previous: carryPrevious,
    });

    const dividend_per_member = calc.roundoff_dividend / group.total_members;
    const monthly_due = Number(group.monthly_amount) - dividend_per_member;

    setPreview({ ...calc, dividend_per_member, monthly_due, total_members: group.total_members });
  }, [selectedGroupId, originalBid, monthNumber, groups, carryPrevious]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);

    const res = await fetch('/api/auctions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chit_group_id: selectedGroupId,
        month_number: Number(monthNumber),
        winner_chit_member_id: winnerChitMemberId,
        original_bid: Number(originalBid),
      }),
    });

    const data = await res.json();

    if (!res.ok) {
      toast.error(data.error || 'Failed to create auction');
    } else {
      toast.success('Auction created!');
      onSaved();
    }

    setIsSubmitting(false);
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="Conduct Auction" size="lg">
      <form onSubmit={handleSubmit} className="space-y-4">
        <Select
          label="Chit Group"
          value={selectedGroupId}
          onChange={(e) => {
            setSelectedGroupId(e.target.value);
            setWinnerChitMemberId('');
          }}
          options={[
            { value: '', label: 'Select a group...' },
            ...groups
              .filter((g) => g.status === 'ACTIVE' || g.status === 'PENDING')
              .map((g) => ({
                value: g.id,
                label: `${g.name} — ${formatCurrency(Number(g.total_amount))} · ${g.total_members}M`,
              })),
          ]}
          required
        />

        <div className="grid grid-cols-2 gap-4">
          <Input
            label="Month Number"
            type="number"
            value={monthNumber}
            onChange={(e) => setMonthNumber(e.target.value)}
            placeholder="e.g. 1"
            required
          />
          <Input
            label="Original Bid (₹)"
            type="number"
            value={originalBid}
            onChange={(e) => setOriginalBid(e.target.value)}
            placeholder="e.g. 643"
            required
          />
        </div>

        <Select
          label="Winner (Ticket Holder)"
          value={winnerChitMemberId}
          onChange={(e) => setWinnerChitMemberId(e.target.value)}
          options={
            availableMembers.length === 0
              ? [{ value: '', label: 'No eligible tickets (all have won)' }]
              : [
                  { value: '', label: 'Select winner...' },
                  ...availableMembers.map((cm) => ({
                    value: cm.id,
                    label: `#${cm.ticket_number} — ${cm.member?.name?.value || 'Unknown'}`,
                  })),
                ]
          }
          required={availableMembers.length > 0}
        />

        {carryPrevious > 0 && (
          <p className="text-xs text-amber-400">Carry from previous month: {formatCurrency(carryPrevious)}</p>
        )}

        {/* Preview */}
        {preview && (
          <div className="bg-surface border border-border rounded-xl p-4 space-y-2">
            <p className="text-xs font-semibold text-foreground-muted uppercase tracking-wider mb-3">
              Calculation Preview
            </p>
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
              <div>
                <p className="text-xs text-foreground-muted">Winning Amount</p>
                <p className="text-sm font-semibold text-emerald-400">
                  {formatCurrency(preview.winning_amount)}
                </p>
              </div>
              <div>
                <p className="text-xs text-foreground-muted">Commission</p>
                <p className="text-sm font-semibold text-red-400">
                  {formatCurrency(preview.commission)}
                </p>
              </div>
              <div>
                <p className="text-xs text-foreground-muted">Net Win (Payout)</p>
                <p className="text-sm font-semibold text-cyan-400">
                  {formatCurrency(preview.winning_amount - preview.commission)}
                </p>
              </div>
              <div>
                <p className="text-xs text-foreground-muted">Raw Dividend</p>
                <p className="text-sm font-semibold text-foreground">
                  {formatCurrency(preview.raw_dividend)}
                </p>
              </div>
              <div>
                <p className="text-xs text-foreground-muted">Roundoff Dividend</p>
                <p className="text-sm font-semibold text-amber-400">
                  {formatCurrency(preview.roundoff_dividend)}
                </p>
              </div>
              <div>
                <p className="text-xs text-foreground-muted">Carry Next</p>
                <p className="text-sm font-semibold text-orange-400">
                  {formatCurrency(preview.carry_next)}
                </p>
              </div>
              <div>
                <p className="text-xs text-foreground-muted">Per Member Div.</p>
                <p className="text-sm font-semibold text-purple-400">
                  {formatCurrency(preview.dividend_per_member)}
                </p>
              </div>
              <div>
                <p className="text-xs text-foreground-muted">Each Member Pays</p>
                <p className="text-sm font-semibold text-cyan-400">
                  {formatCurrency(preview.monthly_due)}
                </p>
              </div>
            </div>
          </div>
        )}

        <div className="flex justify-end gap-3 pt-4 border-t border-border">
          <Button variant="outline" onClick={onClose} type="button">
            Cancel
          </Button>
          <Button type="submit" isLoading={isSubmitting}>
            Conduct Auction
          </Button>
        </div>
      </form>
    </Modal>
  );
}
========================================
//src/app/dashboard/layout.tsx
import { Sidebar } from '@/components/layout/Sidebar';
import type { ReactNode } from 'react';

export default function DashboardLayout({ children }: { children: ReactNode }) {
  return (
    <div className="min-h-screen">
      <Sidebar />
      <main className="lg:pl-64 min-h-screen pb-20 lg:pb-0">
        {children}
      </main>
    </div>
  );
}
========================================
//src/app/dashboard/page.tsx
'use client';

import { useEffect, useState, useCallback, useRef } from 'react';
import { useAuth } from '@/components/providers/AuthProvider';
import { Header } from '@/components/layout/Header';
import { StatCard, Card, PageLoader } from '@/components/ui';
import { StatusBadge } from '@/components/ui/Badge';
import {
  HiOutlineUserGroup,
  HiOutlineUsers,
  HiOutlineCurrencyRupee,
  HiOutlineBanknotes,
  HiOutlineTrophy,
} from 'react-icons/hi2';

interface DashboardStats {
  totalGroups: number;
  activeGroups: number;
  totalMembers: number;
  totalCollected: number;
  totalPayouts: number;
}

interface RecentAuction {
  id: string;
  month_number: number;
  original_bid: string;
  winning_amount: string;
  created_at: string;
  winner_chit_member: {
    ticket_number: number;
    member: { name: { value: string } };
  } | null;
}

interface RecentPayment {
  id: string;
  month_number: number;
  amount_paid: string;
  status: string;
  created_at: string;
  chit_member: {
    ticket_number: number;
    member: { name: { value: string } };
  };
}

interface RecentGroup {
  id: string;
  name: string;
  total_amount: string;
  total_members: number;
  status: string;
  created_at: string;
}

function formatCurrency(amount: number) {
  return new Intl.NumberFormat('en-IN', {
    style: 'currency',
    currency: 'INR',
    maximumFractionDigits: 0,
  }).format(amount);
}

export default function DashboardPage() {
  const { user, isLoading: authLoading } = useAuth();
  const [stats, setStats] = useState<DashboardStats | null>(null);
  const [recentAuctions, setRecentAuctions] = useState<RecentAuction[]>([]);
  const [recentPayments, setRecentPayments] = useState<RecentPayment[]>([]);
  const [recentGroups, setRecentGroups] = useState<RecentGroup[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const hasFetched = useRef(false);

  const loadData = useCallback(async () => {
    if (!user) return;
    if (hasFetched.current) return;
    hasFetched.current = true;

    try {
      const [groupsRes, membersRes, auctionsRes, paymentsRes] = await Promise.all([
        fetch(`/api/chit-groups?user_id=${user.id}`),
        fetch(`/api/members?user_id=${user.id}`),
        fetch(`/api/auctions?user_id=${user.id}`),
        fetch(`/api/payments?user_id=${user.id}`),
      ]);

      const groups = await groupsRes.json();
      const members = await membersRes.json();
      const auctions = await auctionsRes.json();
      const payments = await paymentsRes.json();

      // Guard against API returning error objects instead of arrays
      const safeGroups = Array.isArray(groups) ? groups : [];
      const safeMembers = Array.isArray(members) ? members : [];
      const safeAuctions = Array.isArray(auctions) ? auctions : [];
      const safePayments = Array.isArray(payments) ? payments : [];

      setStats({
        totalGroups: safeGroups.length,
        activeGroups: safeGroups.filter((g: any) => g.status === 'ACTIVE').length,
        totalMembers: safeMembers.length,
        totalCollected: safePayments.reduce((sum: number, p: any) => sum + Number(p.amount_paid), 0),
        totalPayouts: safeAuctions.reduce((sum: number, a: any) => sum + Number(a.winning_amount), 0),
      });

      setRecentGroups(safeGroups.slice(0, 5));
      setRecentAuctions(safeAuctions.slice(0, 5));
      setRecentPayments(safePayments.slice(0, 5));
    } finally {
      setIsLoading(false);
    }
  }, [user]);

  useEffect(() => {
    if (!authLoading) loadData();
  }, [authLoading, loadData]);

  if (authLoading || isLoading) {
    return (
      <>
        <Header title="Dashboard" />
        <PageLoader />
      </>
    );
  }

  return (
    <>
      <Header
        title={`Welcome, ${user?.name || user?.username}`}
        subtitle="BidNest Dashboard"
      />

      <div className="p-4 sm:p-6 lg:p-8 space-y-6">
        {/* Stats Grid */}
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 stagger-children">
          <StatCard
            title="Active Groups"
            value={stats?.activeGroups || 0}
            icon={<HiOutlineUserGroup className="w-6 h-6" />}
            change={`${stats?.totalGroups || 0} total`}
            changeType="neutral"
          />
          <StatCard
            title="Total Members"
            value={stats?.totalMembers || 0}
            icon={<HiOutlineUsers className="w-6 h-6" />}
          />
          <StatCard
            title="Total Collected"
            value={formatCurrency(stats?.totalCollected || 0)}
            icon={<HiOutlineCurrencyRupee className="w-6 h-6" />}
            changeType="positive"
          />
          <StatCard
            title="Total Payouts"
            value={formatCurrency(stats?.totalPayouts || 0)}
            icon={<HiOutlineBanknotes className="w-6 h-6" />}
          />
        </div>

        {/* Main content grid */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Recent Chit Groups */}
          <Card>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-base font-semibold text-foreground">Recent Chit Groups</h3>
            </div>
            {recentGroups.length === 0 ? (
              <p className="text-sm text-foreground-muted py-4 text-center">No chit groups yet</p>
            ) : (
              <div className="space-y-2">
                {recentGroups.map((group) => (
                  <div
                    key={group.id}
                    className="flex items-center justify-between p-3 rounded-xl bg-surface border border-border"
                  >
                    <div>
                      <p className="font-medium text-foreground text-sm">
                        {group.name || formatCurrency(Number(group.total_amount))}
                      </p>
                      <p className="text-xs text-foreground-muted">
                        {formatCurrency(Number(group.total_amount))} · {group.total_members} members
                      </p>
                    </div>
                    <StatusBadge status={group.status} />
                  </div>
                ))}
              </div>
            )}
          </Card>

          {/* Recent Auctions */}
          <Card>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-base font-semibold text-foreground">Recent Auctions</h3>
            </div>
            {recentAuctions.length === 0 ? (
              <p className="text-sm text-foreground-muted py-4 text-center">No auctions yet</p>
            ) : (
              <div className="space-y-2">
                {recentAuctions.map((auction) => (
                  <div
                    key={auction.id}
                    className="flex items-center justify-between p-3 rounded-xl bg-surface border border-border"
                  >
                    <div className="flex items-center gap-3">
                      <div className="p-2 bg-amber-500/10 rounded-xl text-amber-400">
                        <HiOutlineTrophy className="w-4 h-4" />
                      </div>
                      <div>
                        <p className="font-medium text-foreground text-sm">
                          Month {auction.month_number}
                        </p>
                        <p className="text-xs text-foreground-muted">
                          Winner: {auction.winner_chit_member?.member?.name?.value || 'N/A'}
                        </p>
                      </div>
                    </div>
                    <div className="text-right">
                      <p className="font-semibold text-emerald-400 text-sm">
                        {formatCurrency(Number(auction.winning_amount))}
                      </p>
                      <p className="text-xs text-foreground-muted">
                        Bid: {formatCurrency(Number(auction.original_bid))}
                      </p>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </Card>
        </div>

        {/* Recent Payments */}
        <Card padding={false}>
          <div className="flex items-center justify-between p-6 pb-4">
            <h3 className="text-base font-semibold text-foreground">Recent Payments</h3>
          </div>
          {recentPayments.length === 0 ? (
            <p className="text-sm text-foreground-muted py-8 text-center">No payments yet</p>
          ) : (
            <div className="overflow-x-auto px-6 pb-6">
              <table className="glass-table w-full">
                <thead>
                  <tr>
                    <th>Member</th>
                    <th>Ticket</th>
                    <th>Month</th>
                    <th>Amount</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {recentPayments.map((payment) => (
                    <tr key={payment.id}>
                      <td className="font-medium text-foreground">
                        {payment.chit_member?.member?.name?.value || 'N/A'}
                      </td>
                      <td>#{payment.chit_member?.ticket_number}</td>
                      <td>{payment.month_number}</td>
                      <td className="text-foreground">
                        {formatCurrency(Number(payment.amount_paid))}
                      </td>
                      <td>
                        <StatusBadge status={payment.status} />
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </Card>
      </div>
    </>
  );
}
========================================
//src/app/groups/layout.tsx
import { Sidebar } from '@/components/layout/Sidebar';
import type { ReactNode } from 'react';

export default function GroupsLayout({ children }: { children: ReactNode }) {
  return (
    <div className="min-h-screen">
      <Sidebar />
      <main className="lg:pl-64 min-h-screen pb-20 lg:pb-0">
        {children}
      </main>
    </div>
  );
}
========================================
//src/app/groups/page.tsx
'use client';

import { useEffect, useState, useCallback, useRef } from 'react';
import { useAuth } from '@/components/providers/AuthProvider';
import { Header } from '@/components/layout/Header';
import { Card, Button, Modal, Input, PageLoader, EmptyState, Select } from '@/components/ui';
import { StatusBadge } from '@/components/ui/Badge';
import {
  HiOutlineUserGroup,
  HiOutlinePlus,
  HiOutlinePencil,
  HiOutlineTrash,
  HiOutlineEye,
} from 'react-icons/hi2';
import toast from 'react-hot-toast';
import Link from 'next/link';

interface ChitGroup {
  id: string;
  name: string;
  total_amount: string;
  total_members: number;
  monthly_amount: string;
  duration_months: number;
  commission_type: 'PERCENT' | 'FIXED';
  commission_value: string;
  round_off_value: number;
  status: string;
  created_at: string;
}

function formatCurrency(amount: number) {
  return new Intl.NumberFormat('en-IN', {
    style: 'currency',
    currency: 'INR',
    maximumFractionDigits: 0,
  }).format(amount);
}

export default function GroupsPage() {
  const { user } = useAuth();
  const [groups, setGroups] = useState<ChitGroup[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [editingGroup, setEditingGroup] = useState<ChitGroup | null>(null);
  const [filterStatus, setFilterStatus] = useState('all');
  const hasFetched = useRef(false);

  const loadData = useCallback(async (force = false) => {
    if (!user) return;
    if (!force && hasFetched.current) return;
    hasFetched.current = true;
    try {
      const res = await fetch(`/api/chit-groups?user_id=${user.id}`);
      const data = await res.json();
      setGroups(Array.isArray(data) ? data : []);
    } finally {
      setIsLoading(false);
    }
  }, [user]);

  useEffect(() => {
    loadData();
  }, [loadData]);

  const refreshData = useCallback(async () => {
    if (!user) return;
    const res = await fetch(`/api/chit-groups?user_id=${user.id}`);
    const data = await res.json();
    setGroups(Array.isArray(data) ? data : []);
  }, [user]);

  const handleDelete = async (group: ChitGroup) => {
    if (!confirm(`Cancel chit group "${group.name}"?`)) return;
    const res = await fetch(`/api/chit-groups/${group.id}`, { method: 'DELETE' });
    if (res.ok) {
      toast.success('Chit group cancelled');
      refreshData();
    } else {
      toast.error('Failed to cancel chit group');
    }
  };

  const filteredGroups = groups.filter((g) =>
    filterStatus === 'all' ? true : g.status === filterStatus
  );

  if (isLoading) {
    return (
      <>
        <Header title="Chit Groups" />
        <PageLoader />
      </>
    );
  }

  return (
    <>
      <Header title="Chit Groups" subtitle={`${groups.length} total groups`}>
        <Button
          icon={<HiOutlinePlus className="w-4 h-4" />}
          onClick={() => setShowCreateModal(true)}
        >
          New Group
        </Button>
      </Header>

      <div className="p-4 sm:p-6 lg:p-8">
        {/* Filter */}
        <div className="mb-6 w-48">
          <Select
            value={filterStatus}
            onChange={(e) => setFilterStatus(e.target.value)}
            options={[
              { value: 'all', label: 'All Status' },
              { value: 'PENDING', label: 'Pending' },
              { value: 'ACTIVE', label: 'Active' },
              { value: 'COMPLETED', label: 'Completed' },
              { value: 'CANCELLED', label: 'Cancelled' },
            ]}
          />
        </div>

        {filteredGroups.length === 0 ? (
          <EmptyState
            icon={<HiOutlineUserGroup className="w-8 h-8" />}
            title="No chit groups found"
            description="Create your first chit group to get started."
          />
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
            {filteredGroups.map((group) => (
              <div key={group.id} className="glass rounded-2xl border border-border p-5 flex flex-col gap-4">
                {/* Header */}
                <div className="flex items-start justify-between">
                  <div>
                    <p className="text-base font-bold text-foreground">
                      {group.name}
                    </p>
                    <p className="text-sm text-foreground-muted mt-0.5">
                      {formatCurrency(Number(group.total_amount))} · {group.total_members} members · {group.duration_months} months
                    </p>
                  </div>
                  <StatusBadge status={group.status} />
                </div>

                {/* Progress */}
                <GroupProgress groupId={group.id} duration={group.duration_months} />

                {/* Details */}
                <div className="grid grid-cols-2 gap-3">
                  <div className="bg-surface rounded-xl p-3">
                    <p className="text-xs text-foreground-muted">Monthly</p>
                    <p className="text-sm font-semibold text-foreground mt-0.5">
                      {formatCurrency(Number(group.monthly_amount))}
                    </p>
                  </div>
                  <div className="bg-surface rounded-xl p-3">
                    <p className="text-xs text-foreground-muted">Commission</p>
                    <p className="text-sm font-semibold text-foreground mt-0.5">
                      {group.commission_type === 'PERCENT'
                        ? `${group.commission_value}%`
                        : formatCurrency(Number(group.commission_value))}
                    </p>
                  </div>
                  <div className="bg-surface rounded-xl p-3">
                    <p className="text-xs text-foreground-muted">Round Off</p>
                    <p className="text-sm font-semibold text-foreground mt-0.5">
                      ₹{group.round_off_value}
                    </p>
                  </div>
                  <div className="bg-surface rounded-xl p-3">
                    <p className="text-xs text-foreground-muted">Created</p>
                    <p className="text-sm font-semibold text-foreground mt-0.5">
                      {new Date(group.created_at).toLocaleDateString('en-IN')}
                    </p>
                  </div>
                </div>

                {/* Actions */}
                <div className="flex items-center gap-2 pt-2 border-t border-border">
                  <Link
                    href={`/groups/${group.id}`}
                    className="flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-medium text-cyan-400 hover:bg-cyan-500/10 border border-cyan-500/20 transition-all"
                  >
                    <HiOutlineEye className="w-4 h-4" />
                    View
                  </Link>
                  <button
                    onClick={() => setEditingGroup(group)}
                    className="p-2 rounded-xl text-foreground-muted hover:text-cyan-400 hover:bg-cyan-500/10 transition-all"
                  >
                    <HiOutlinePencil className="w-4 h-4" />
                  </button>
                  <button
                    onClick={() => handleDelete(group)}
                    className="p-2 rounded-xl text-foreground-muted hover:text-red-400 hover:bg-red-500/10 transition-all"
                  >
                    <HiOutlineTrash className="w-4 h-4" />
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Create Modal */}
      <GroupFormModal
        isOpen={showCreateModal}
        onClose={() => setShowCreateModal(false)}
        onSaved={() => {
          setShowCreateModal(false);
          refreshData();
        }}
      />

      {/* Edit Modal */}
      {editingGroup && (
        <GroupFormModal
          isOpen={!!editingGroup}
          group={editingGroup}
          onClose={() => setEditingGroup(null)}
          onSaved={() => {
            setEditingGroup(null);
            refreshData();
          }}
        />
      )}
    </>
  );
}

// ─── Group Form Modal ───────────────────────────────────────────────────────

function GroupFormModal({
  isOpen,
  group,
  onClose,
  onSaved,
}: {
  isOpen: boolean;
  group?: ChitGroup;
  onClose: () => void;
  onSaved: () => void;
}) {
  const isEditing = !!group;
  const [name, setName] = useState(group ? group.name : '');
  const [totalAmount, setTotalAmount] = useState(group ? String(group.total_amount) : '');
  const [totalMembers, setTotalMembers] = useState(group ? String(group.total_members) : '');
  const [durationMonths, setDurationMonths] = useState(group ? String(group.duration_months) : '');
  const [commissionType, setCommissionType] = useState<'PERCENT' | 'FIXED'>(group?.commission_type ?? 'FIXED');
  const [commissionValue, setCommissionValue] = useState(group ? String(group.commission_value) : '');
  const [roundOffValue, setRoundOffValue] = useState(group ? String(group.round_off_value) : '50');
  const [status, setStatus] = useState(group?.status ?? 'PENDING');
  const [isSubmitting, setIsSubmitting] = useState(false);

  useEffect(() => {
    if (group) {
      setName(String(group.name));
      setTotalAmount(String(group.total_amount));
      setTotalMembers(String(group.total_members));
      setDurationMonths(String(group.duration_months));
      setCommissionType(group.commission_type);
      setCommissionValue(String(group.commission_value));
      setRoundOffValue(String(group.round_off_value));
      setStatus(group.status);
    }
  }, [group]);

  const monthlyAmount =
    totalAmount && totalMembers
      ? Number(totalAmount) / Number(totalMembers)
      : 0;

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);

    if (isEditing) {
      const res = await fetch(`/api/chit-groups/${group!.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          status,
          commission_type: commissionType,
          commission_value: Number(commissionValue),
          round_off_value: Number(roundOffValue),
        }),
      });
      const data = await res.json();
      if (!res.ok) toast.error(data.error || 'Failed to update');
      else { toast.success('Group updated!'); onSaved(); }
    } else {
      const meRes = await fetch('/api/auth/me');
      const me = await meRes.json();

      const res = await fetch('/api/chit-groups', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: me.id,
          name: name.trim() || `₹${Number(totalAmount).toLocaleString('en-IN')} Chit`,
          total_amount: Number(totalAmount),
          total_members: Number(totalMembers),
          monthly_amount: monthlyAmount,
          duration_months: Number(durationMonths),
          commission_type: commissionType,
          commission_value: Number(commissionValue),
          round_off_value: Number(roundOffValue),
        }),
      });
      const data = await res.json();
      if (!res.ok) toast.error(data.error || 'Failed to create');
      else { toast.success('Chit group created!'); onSaved(); }
    }

    setIsSubmitting(false);
  };

  return (
    <Modal
      isOpen={isOpen}
      onClose={onClose}
      title={isEditing ? 'Edit Chit Group' : 'Create Chit Group'}
      size="lg"
    >
      <form onSubmit={handleSubmit} className="space-y-4">
        {!isEditing && (
          <>
            <Input
              label="Group Name"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="e.g. Office Chit 2026"
              required
            />
            <div className="grid grid-cols-2 gap-4">
              <Input
                label="Total Amount (₹)"
                type="number"
                value={totalAmount}
                onChange={(e) => setTotalAmount(e.target.value)}
                placeholder="e.g. 100000"
                required
              />
              <Input
                label="Total Members"
                type="number"
                value={totalMembers}
                onChange={(e) => setTotalMembers(e.target.value)}
                placeholder="e.g. 10"
                required
              />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <Input
                label="Duration (months)"
                type="number"
                value={durationMonths}
                onChange={(e) => setDurationMonths(e.target.value)}
                placeholder="e.g. 10"
                required
              />
              <Input
                label="Monthly Amount (₹)"
                type="number"
                value={monthlyAmount || ''}
                disabled
                helperText="Auto calculated"
              />
            </div>
          </>
        )}

        <div className="grid grid-cols-2 gap-4">
          <Select
            label="Commission Type"
            value={commissionType}
            onChange={(e) => setCommissionType(e.target.value as 'PERCENT' | 'FIXED')}
            options={[
              { value: 'FIXED', label: 'Fixed Amount' },
              { value: 'PERCENT', label: 'Percentage' },
            ]}
          />
          <Input
            label={commissionType === 'PERCENT' ? 'Commission (%)' : 'Commission (₹)'}
            type="number"
            value={commissionValue}
            onChange={(e) => setCommissionValue(e.target.value)}
            placeholder={commissionType === 'PERCENT' ? 'e.g. 5' : 'e.g. 500'}
            required
          />
        </div>

        <div className="grid grid-cols-2 gap-4">
          <Select
            label="Round Off Value"
            value={roundOffValue}
            onChange={(e) => setRoundOffValue(e.target.value)}
            options={[
              { value: '10', label: '₹10' },
              { value: '50', label: '₹50' },
              { value: '100', label: '₹100' },
            ]}
          />
          {isEditing && (
            <Select
              label="Status"
              value={status}
              onChange={(e) => setStatus(e.target.value)}
              options={[
                { value: 'PENDING', label: 'Pending' },
                { value: 'ACTIVE', label: 'Active' },
                { value: 'COMPLETED', label: 'Completed' },
                { value: 'CANCELLED', label: 'Cancelled' },
              ]}
            />
          )}
        </div>

        <div className="flex justify-end gap-3 pt-4 border-t border-border">
          <Button variant="outline" onClick={onClose} type="button">
            Cancel
          </Button>
          <Button type="submit" isLoading={isSubmitting}>
            {isEditing ? 'Save Changes' : 'Create Group'}
          </Button>
        </div>
      </form>
    </Modal>
  );
}

function GroupProgress({ groupId, duration }: { groupId: string; duration: number }) {
  const [completed, setCompleted] = useState<number | null>(null);

  useEffect(() => {
    let mounted = true;
    fetch(`/api/auctions?chit_group_id=${groupId}`)
      .then((r) => r.json())
      .then((data) => {
        if (!mounted) return;
        const list = Array.isArray(data) ? data : [];
        setCompleted(list.length);
      })
      .catch(() => {
        if (!mounted) return;
        setCompleted(0);
      });
    return () => { mounted = false; };
  }, [groupId]);

  if (completed === null) {
    return (
      <div className="mt-2">
        <div className="neon-progress">
          <div className="neon-progress-bar animate-pulse" style={{ width: '30%' }} />
        </div>
      </div>
    );
  }

  const pct = duration > 0 ? Math.min(100, Math.round((completed / duration) * 100)) : 0;

  return (
    <div className="w-full mt-3">
      <div className="flex items-center justify-between text-xs text-foreground-muted mb-1">
        <span>{completed} / {duration} months</span>
        <span className="font-medium">{pct}%</span>
      </div>
      <div className="neon-progress">
        <div className="neon-progress-bar" style={{ width: `${pct}%` }} />
      </div>
    </div>
  );
}
========================================
//src/app/groups/[id]/layout.tsx
import type { ReactNode } from 'react';

// Parent groups/layout.tsx already provides the Sidebar shell.
// This layout just passes children through to avoid a duplicate sidebar.
export default function GroupDetailLayout({ children }: { children: ReactNode }) {
  return <>{children}</>;
}
========================================
//src/app/groups/[id]/page.tsx
'use client';

import { useEffect, useState } from 'react';
import { useParams, useRouter } from 'next/navigation';
import { useAuth } from '@/components/providers/AuthProvider';
import { Header } from '@/components/layout/Header';
import { Card, PageLoader, StatusBadge, Button } from '@/components/ui';
import {
  HiOutlineArrowLeft,
  HiOutlineUserGroup,
  HiOutlineTrophy,
  HiOutlineBanknotes,
  HiOutlineTicket,
  HiOutlinePlus,
} from 'react-icons/hi2';
import toast from 'react-hot-toast';
import { Modal, Input, Select } from '@/components/ui';
import { calculateAuction } from '@/utils/dividend';

interface ChitGroup {
  id: string;
  name: string;
  total_amount: string;
  total_members: number;
  monthly_amount: string;
  duration_months: number;
  commission_type: 'PERCENT' | 'FIXED';
  commission_value: string;
  round_off_value: number;
  status: string;
  created_at: string;
}

interface ChitMember {
  id: string;
  ticket_number: number;
  is_active: boolean;
  member: {
    id: string;
    name: { value: string };
    mobile: { value: string };
  };
}

interface Auction {
  id: string;
  month_number: number;
  original_bid: string;
  winning_amount: string;
  carry_next: string;
  calculation_data: {
    amount_to_collect: number;
    dividend_per_member: number;
  };
  winner_chit_member: {
    ticket_number: number;
    member: { name: { value: string } };
  };
}

interface Payment {
  id: string;
  month_number: number;
  amount_paid: string;
  status: string;
  chit_member: {
    ticket_number: number;
    member: { name: { value: string } };
  };
}

function formatCurrency(amount: number) {
  return new Intl.NumberFormat('en-IN', {
    style: 'currency',
    currency: 'INR',
    maximumFractionDigits: 0,
  }).format(amount);
}

export default function GroupDetailPage() {
  const { id } = useParams();
  const router = useRouter();
  const { user } = useAuth();
  const [group, setGroup] = useState<ChitGroup | null>(null);
  const [chitMembers, setChitMembers] = useState<ChitMember[]>([]);
  const [auctions, setAuctions] = useState<Auction[]>([]);
  const [payments, setPayments] = useState<Payment[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [showAddTicketModal, setShowAddTicketModal] = useState(false);
  const [showConductAuction, setShowConductAuction] = useState(false);

  const load = async () => {
    try {
      const [groupRes, chitMembersRes, auctionsRes, paymentsRes] = await Promise.all([
        fetch(`/api/chit-groups/${id}`),
        fetch(`/api/chit-members?chit_group_id=${id}`),
        fetch(`/api/auctions?chit_group_id=${id}`),
        fetch(`/api/payments?chit_group_id=${id}`),
      ]);

      const groupData = await groupRes.json();
      const chitMembersData = await chitMembersRes.json();
      const auctionsData = await auctionsRes.json();
      const paymentsData = await paymentsRes.json();

      // Only set group if it looks valid (has an id)
      setGroup(groupData?.id ? groupData : null);
      setChitMembers(Array.isArray(chitMembersData) ? chitMembersData : []);
      setAuctions(Array.isArray(auctionsData) ? auctionsData : []);
      setPayments(Array.isArray(paymentsData) ? paymentsData : []);
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    load();
  }, [id]);

  if (isLoading) {
    return (
      <>
        <Header title="Group Details" />
        <PageLoader />
      </>
    );
  }

  if (!group) {
    return (
      <>
        <Header title="Group Not Found" />
        <div className="p-8 text-center text-foreground-muted">Group not found or you do not have access.</div>
      </>
    );
  }

  const totalCollected = payments.reduce((sum, p) => sum + Number(p.amount_paid), 0);
  const completedMonths = auctions.length;
  const progressPercent = Math.round((completedMonths / group.duration_months) * 100);

  return (
    <>
      <Header title={group.name || 'Group Details'} subtitle={`${formatCurrency(Number(group.total_amount))} · ${group.total_members} members`} />

      <div className="p-4 sm:p-6 lg:p-8 max-w-5xl space-y-6">
        {/* Back */}
        <button
          onClick={() => router.back()}
          className="flex items-center gap-2 text-sm text-foreground-muted hover:text-cyan-400 transition-colors"
        >
          <HiOutlineArrowLeft className="w-4 h-4" />
          Back to Groups
        </button>

        {/* Group Summary */}
        <Card>
          <div className="flex flex-col sm:flex-row sm:items-start justify-between gap-4">
            <div>
              <div className="flex items-center gap-3 mb-2">
                <div className="p-3 rounded-xl bg-cyan-500/10 text-cyan-400">
                  <HiOutlineUserGroup className="w-6 h-6" />
                </div>
                <div>
                  <h2 className="text-2xl font-bold text-foreground">
                    {group.name}
                  </h2>
                  <p className="text-foreground-muted text-sm">
                    {formatCurrency(Number(group.total_amount))} · {group.total_members} members · {group.duration_months} months
                  </p>
                </div>
              </div>
            </div>
            <StatusBadge status={group.status} />
          </div>

          {/* Progress */}
          <div className="mt-6">
            <div className="flex justify-between text-sm mb-2">
              <span className="text-foreground-muted">Progress</span>
              <span className="text-foreground font-medium">
                Month {completedMonths}/{group.duration_months}
              </span>
            </div>
            <div className="neon-progress">
              <div className="neon-progress-bar" style={{ width: `${progressPercent}%` }} />
            </div>
          </div>

          {/* Stats */}
          <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 mt-6">
            <div className="bg-surface border border-border rounded-xl p-3">
              <p className="text-xs text-foreground-muted">Monthly</p>
              <p className="text-base font-bold text-foreground">
                {formatCurrency(Number(group.monthly_amount))}
              </p>
            </div>
            <div className="bg-surface border border-border rounded-xl p-3">
              <p className="text-xs text-foreground-muted">Commission</p>
              <p className="text-base font-bold text-foreground">
                {group.commission_type === 'PERCENT'
                  ? `${group.commission_value}%`
                  : formatCurrency(Number(group.commission_value))}
              </p>
            </div>
            <div className="bg-surface border border-border rounded-xl p-3">
              <p className="text-xs text-foreground-muted">Round Off</p>
              <p className="text-base font-bold text-foreground">₹{group.round_off_value}</p>
            </div>
            <div className="bg-surface border border-border rounded-xl p-3">
              <p className="text-xs text-foreground-muted">Total Collected</p>
              <p className="text-base font-bold text-cyan-400">
                {formatCurrency(totalCollected)}
              </p>
            </div>
          </div>
        </Card>

        {/* Tickets / Members */}
        <Card>
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-base font-semibold text-foreground flex items-center gap-2">
              <HiOutlineTicket className="w-5 h-5 text-cyan-400" />
              Tickets ({chitMembers.length}/{group.total_members})
            </h3>
            {chitMembers.length < group.total_members && (
              <Button
                size="sm"
                icon={<HiOutlinePlus className="w-4 h-4" />}
                onClick={() => setShowAddTicketModal(true)}
              >
                Add Ticket
              </Button>
            )}
          </div>
          {chitMembers.length === 0 ? (
            <p className="text-sm text-foreground-muted text-center py-4">
              No tickets assigned yet.
            </p>
          ) : (
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
              {chitMembers.map((cm) => (
                <div
                  key={cm.id}
                  className="flex items-center gap-3 p-3 bg-surface border border-border rounded-xl"
                >
                  <div className="w-10 h-10 rounded-xl bg-cyan-500/10 flex items-center justify-center text-cyan-400 font-bold text-sm shrink-0">
                    #{cm.ticket_number}
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="font-medium text-foreground text-sm truncate">
                      {cm.member?.name?.value || 'Unknown'}
                    </p>
                    <p className="text-xs text-foreground-muted">
                      {cm.member?.mobile?.value || '—'}
                    </p>
                  </div>
                  <StatusBadge status={cm.is_active ? 'ACTIVE' : 'CANCELLED'} />
                </div>
              ))}
            </div>
          )}
        </Card>

        {/* Auctions */}
        <Card padding={false}>
          <div className="p-6 pb-4 flex items-center justify-between gap-2">
            <div className="flex items-center gap-2">
              <HiOutlineTrophy className="w-5 h-5 text-amber-400" />
              <h3 className="text-base font-semibold text-foreground">Auctions ({auctions.length}/{group.duration_months})</h3>
            </div>
            {auctions.length < group.duration_months && (
              <Button
                size="sm"
                icon={<HiOutlinePlus className="w-4 h-4" />}
                onClick={() => setShowConductAuction(true)}
              >
                Conduct Auction
              </Button>
            )}
          </div>
          {auctions.length === 0 ? (
            <p className="text-sm text-foreground-muted text-center py-8">No auctions conducted yet.</p>
          ) : (
            <div className="overflow-x-auto px-6 pb-6">
              <table className="glass-table w-full">
                <thead>
                  <tr>
                    <th>Month</th>
                    <th>Winner</th>
                    <th>Ticket</th>
                    <th>Bid</th>
                    <th>Payout</th>
                    <th>Per Member</th>
                    <th>To Collect</th>
                    <th>Carry Next</th>
                  </tr>
                </thead>
                <tbody>
                  {auctions.map((a) => (
                    <tr key={a.id}>
                      <td className="font-semibold text-cyan-400">Month {a.month_number}</td>
                      <td className="font-medium text-foreground">
                        {a.winner_chit_member?.member?.name?.value || 'N/A'}
                      </td>
                      <td>#{a.winner_chit_member?.ticket_number}</td>
                      <td>{formatCurrency(Number(a.original_bid))}</td>
                      <td className="text-emerald-400 font-semibold">
                        {formatCurrency(Number(a.winning_amount))}
                      </td>
                      <td className="text-purple-400">
                        {formatCurrency(a.calculation_data?.dividend_per_member || 0)}
                      </td>
                      <td className="text-foreground font-semibold">
                        {formatCurrency(a.calculation_data?.amount_to_collect || 0)}
                      </td>
                      <td className="text-amber-400">
                        {formatCurrency(Number(a.carry_next))}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </Card>

        {/* Payments */}
        <Card padding={false}>
          <div className="p-6 pb-4 flex items-center gap-2">
            <HiOutlineBanknotes className="w-5 h-5 text-cyan-400" />
            <h3 className="text-base font-semibold text-foreground">Payments</h3>
          </div>
          {payments.length === 0 ? (
            <p className="text-sm text-foreground-muted text-center py-8">No payments recorded yet.</p>
          ) : (
            <div className="overflow-x-auto px-6 pb-6">
              <table className="glass-table w-full">
                <thead>
                  <tr>
                    <th>Member</th>
                    <th>Ticket</th>
                    <th>Month</th>
                    <th>Amount</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {payments.map((p) => (
                    <tr key={p.id}>
                      <td className="font-medium text-foreground">
                        {p.chit_member?.member?.name?.value || 'N/A'}
                      </td>
                      <td>#{p.chit_member?.ticket_number}</td>
                      <td>Month {p.month_number}</td>
                      <td className="text-cyan-400 font-semibold">
                        {formatCurrency(Number(p.amount_paid))}
                      </td>
                      <td>
                        <StatusBadge status={p.status} />
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </Card>
      </div>

      {/* Add Ticket Modal */}
      <AddTicketModal
        isOpen={showAddTicketModal}
        groupId={group.id}
        userId={user?.id || ''}
        existingTickets={chitMembers.map((cm) => cm.ticket_number)}
        totalMembers={group.total_members}
        onClose={() => setShowAddTicketModal(false)}
        onSaved={() => {
          setShowAddTicketModal(false);
          load();
        }}
      />

      {/* Conduct Auction Modal */}
      <ConductAuctionModal
        isOpen={showConductAuction}
        group={group}
        chitMembers={chitMembers}
        lastCarryNext={
          auctions.length > 0
            ? Number(auctions.reduce((a, b) => (a.month_number > b.month_number ? a : b)).carry_next)
            : 0
        }
        nextMonth={
          auctions.length > 0
            ? auctions.reduce((a, b) => (a.month_number > b.month_number ? a : b)).month_number + 1
            : 1
        }
        onClose={() => setShowConductAuction(false)}
        onSaved={() => {
          setShowConductAuction(false);
          load();
        }}
      />
    </>
  );
}

// ─── Add Ticket Modal ───────────────────────────────────────────────────────

function AddTicketModal({
  isOpen,
  groupId,
  userId,
  existingTickets,
  totalMembers,
  onClose,
  onSaved,
}: {
  isOpen: boolean;
  groupId: string;
  userId: string;
  existingTickets: number[];
  totalMembers: number;
  onClose: () => void;
  onSaved: () => void;
}) {
  const [members, setMembers] = useState<{ id: string; name: { value: string } }[]>([]);
  const [selectedMemberId, setSelectedMemberId] = useState('');
  const [ticketNumber, setTicketNumber] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  useEffect(() => {
    if (isOpen) {
      fetch(userId ? `/api/members?user_id=${userId}` : '/api/members')
        .then((r) => r.json())
        .then((data) => setMembers(Array.isArray(data) ? data : []));

      // auto-suggest next ticket number
      const used = new Set(existingTickets);
      for (let i = 1; i <= totalMembers; i++) {
        if (!used.has(i)) {
          setTicketNumber(String(i));
          break;
        }
      }
    }
  }, [isOpen, existingTickets, totalMembers, userId]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);

    const res = await fetch('/api/chit-members', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        member_id: selectedMemberId,
        chit_group_id: groupId,
        ticket_number: Number(ticketNumber),
      }),
    });

    const data = await res.json();
    if (!res.ok) {
      toast.error(data.error || 'Failed to add ticket');
    } else {
      toast.success('Ticket added!');
      onSaved();
    }

    setIsSubmitting(false);
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="Add Ticket">
      <form onSubmit={handleSubmit} className="space-y-4">
        <Select
          label="Member"
          value={selectedMemberId}
          onChange={(e) => setSelectedMemberId(e.target.value)}
          options={[
            { value: '', label: 'Select member...' },
            ...members.map((m) => ({
              value: m.id,
              label: m.name.value,
            })),
          ]}
        />
        <Input
          label="Ticket Number"
          type="number"
          value={ticketNumber}
          onChange={(e) => setTicketNumber(e.target.value)}
          required
        />
        <div className="flex justify-end gap-3 pt-4 border-t border-border">
          <Button variant="outline" onClick={onClose} type="button">Cancel</Button>
          <Button type="submit" isLoading={isSubmitting}>Add Ticket</Button>
        </div>
      </form>
    </Modal>
  );
}

// ─── Conduct Auction Modal ────────────────────────────────────────────────────

function ConductAuctionModal({
  isOpen,
  group,
  chitMembers,
  lastCarryNext,
  nextMonth,
  onClose,
  onSaved,
}: {
  isOpen: boolean;
  group: ChitGroup;
  chitMembers: ChitMember[];
  lastCarryNext: number;
  nextMonth: number;
  onClose: () => void;
  onSaved: () => void;
}) {
  const [monthNumber, setMonthNumber] = useState('');
  const [originalBid, setOriginalBid] = useState('');
  const [winnerChitMemberId, setWinnerChitMemberId] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [preview, setPreview] = useState<any>(null);
  const [groupAuctions, setGroupAuctions] = useState<any[]>([]);
  const [availableMembers, setAvailableMembers] = useState<ChitMember[]>([]);

  useEffect(() => {
    if (isOpen) {
      setMonthNumber(String(nextMonth));
      setOriginalBid('');
      setWinnerChitMemberId('');
      setPreview(null);
      // fetch auctions for this group to determine tickets that already won
      fetch(`/api/auctions?chit_group_id=${group.id}`)
        .then((r) => r.json())
        .then((data) => {
          const list = Array.isArray(data) ? data : [];
          setGroupAuctions(list);
        })
        .catch(() => setGroupAuctions([]));
    }
  }, [isOpen, nextMonth]);

  // recompute availableMembers whenever chitMembers or groupAuctions change
  useEffect(() => {
    const winners = new Set<string>();
    for (const a of groupAuctions) {
      const wid = (a && (a.winner_chit_member_id || (a.winner_chit_member && a.winner_chit_member.id)));
      if (wid) winners.add(String(wid));
    }
    const available = (chitMembers || []).filter((cm) => !winners.has(cm.id));
    setAvailableMembers(available);
    // clear selection if previously selected member is no longer available
    if (winnerChitMemberId && !available.find((m) => m.id === winnerChitMemberId)) {
      setWinnerChitMemberId('');
    }
  }, [chitMembers, groupAuctions]);

  // live preview
  useEffect(() => {
    if (!originalBid) { setPreview(null); return; }
    const bid = Number(originalBid);
    if (isNaN(bid) || bid <= 0) return;

    const calc = calculateAuction({
      total_amount: Number(group.total_amount),
      original_bid: bid,
      commission_type: group.commission_type,
      commission_value: Number(group.commission_value),
      round_off_value: group.round_off_value,
      carry_previous: lastCarryNext,
    });

    const dividend_per_member = calc.roundoff_dividend / group.total_members;
    setPreview({ ...calc, dividend_per_member, monthly_due: Number(group.monthly_amount) - dividend_per_member });
  }, [originalBid, group, lastCarryNext]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);

    if ((availableMembers || []).length === 0) {
      toast.error('No eligible tickets available — all tickets have already won');
      setIsSubmitting(false);
      return;
    }

    if (!winnerChitMemberId) {
      toast.error('Please select a winner (ticket)');
      setIsSubmitting(false);
      return;
    }

    const res = await fetch('/api/auctions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chit_group_id: group.id,
        month_number: Number(monthNumber),
        winner_chit_member_id: winnerChitMemberId,
        original_bid: Number(originalBid),
      }),
    });

    const data = await res.json();
    if (!res.ok) {
      toast.error(data.error || 'Failed to conduct auction');
    } else {
      toast.success(`Month ${monthNumber} auction completed!`);
      onSaved();
    }
    setIsSubmitting(false);
  };

  function formatCurrency(amount: number) {
    return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(amount);
  }

  return (
    <Modal isOpen={isOpen} onClose={onClose} title={`Conduct Auction — ${group.name}`} size="lg">
      <form onSubmit={handleSubmit} className="space-y-4">
        <div className="grid grid-cols-2 gap-4">
          <Input
            label="Month Number"
            type="number"
            value={monthNumber}
            onChange={(e) => setMonthNumber(e.target.value)}
            required
          />
          <Input
            label="Original Bid (₹)"
            type="number"
            value={originalBid}
            onChange={(e) => setOriginalBid(e.target.value)}
            placeholder="e.g. 643"
            required
          />
        </div>

        <Select
          label="Winner (Ticket Holder)"
          value={winnerChitMemberId}
          onChange={(e) => setWinnerChitMemberId(e.target.value)}
          options={
            availableMembers.length === 0
              ? [{ value: '', label: 'No eligible tickets (all have won)' }]
              : [
                  { value: '', label: 'Select winner...' },
                  ...availableMembers.map((cm) => ({
                    value: cm.id,
                    label: `#${cm.ticket_number} — ${cm.member?.name?.value || 'Unknown'}`,
                  })),
                ]
          }
          required={availableMembers.length > 0}
        />

        {availableMembers.length === 0 && (
          <p className="text-sm text-red-400">No eligible tickets left in this group — every ticket has won previously.</p>
        )}

        {lastCarryNext > 0 && (
          <p className="text-xs text-amber-400">Carry from previous month: {formatCurrency(lastCarryNext)}</p>
        )}

        {/* Full Preview */}
        {preview && (
          <div className="bg-surface border border-border rounded-xl p-4">
            <p className="text-xs font-semibold text-foreground-muted uppercase tracking-wider mb-3">
              Calculation Preview
            </p>
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
              <div>
                <p className="text-xs text-foreground-muted">Winning Amount</p>
                <p className="text-sm font-semibold text-emerald-400">{formatCurrency(preview.winning_amount)}</p>
              </div>
              <div>
                <p className="text-xs text-foreground-muted">Commission</p>
                <p className="text-sm font-semibold text-red-400">{formatCurrency(preview.commission)}</p>
              </div>
              <div>
                <p className="text-xs text-foreground-muted">Net Payout</p>
                <p className="text-sm font-semibold text-cyan-400">{formatCurrency(preview.winning_amount - preview.commission)}</p>
              </div>
              <div>
                <p className="text-xs text-foreground-muted">Raw Dividend</p>
                <p className="text-sm font-semibold text-foreground">{formatCurrency(preview.raw_dividend)}</p>
              </div>
              <div>
                <p className="text-xs text-foreground-muted">Roundoff Div.</p>
                <p className="text-sm font-semibold text-amber-400">{formatCurrency(preview.roundoff_dividend)}</p>
              </div>
              <div>
                <p className="text-xs text-foreground-muted">Carry Next</p>
                <p className="text-sm font-semibold text-orange-400">{formatCurrency(preview.carry_next)}</p>
              </div>
              <div>
                <p className="text-xs text-foreground-muted">Per Member Div.</p>
                <p className="text-sm font-semibold text-purple-400">{formatCurrency(preview.dividend_per_member)}</p>
              </div>
              <div>
                <p className="text-xs text-foreground-muted">Each Member Pays</p>
                <p className="text-sm font-bold text-cyan-400">{formatCurrency(preview.monthly_due)}</p>
              </div>
            </div>
          </div>
        )}

        <div className="flex justify-end gap-3 pt-4 border-t border-border">
          <Button variant="outline" onClick={onClose} type="button">Cancel</Button>
          <Button type="submit" isLoading={isSubmitting}>
            Conduct Auction
          </Button>
        </div>
      </form>
    </Modal>
  );
}
========================================
//src/app/login/page.tsx
'use client';

import { useState } from 'react';
import Link from 'next/link';
import { useAuth } from '@/components/providers/AuthProvider';
import { Input } from '@/components/ui/Input';
import { Button } from '@/components/ui/Button';
import toast from 'react-hot-toast';

export default function LoginPage() {
  const { login } = useAuth();
  const [loginValue, setLoginValue] = useState('');
  const [password, setPassword] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!loginValue || !password) {
      toast.error('Please fill in all fields');
      return;
    }
    setIsLoading(true);
    const result = await login(loginValue, password);
    if (result.error) {
      toast.error(result.error);
    }
    setIsLoading(false);
  };

  return (
    <div className="min-h-screen flex items-center justify-center px-4 relative overflow-hidden">
      {/* Orbs */}
      <div className="fixed inset-0 pointer-events-none">
        <div className="absolute top-[-20%] left-[-10%] w-125 h-125 rounded-full bg-cyan-500/[0.07] blur-[120px]" />
        <div className="absolute bottom-[-20%] right-[-10%] w-100 h-100 rounded-full bg-purple-500/[0.07] blur-[120px]" />
      </div>

      <div className="relative w-full max-w-md animate-slide-up">
        {/* Logo */}
        <div className="text-center mb-8">
          <Link href="/" className="inline-flex items-center gap-3 mb-6">
            <div className="w-10 h-10 rounded-xl flex items-center justify-center bg-linear-to-br from-cyan-400 to-purple-500 shadow-lg shadow-cyan-500/20">
              <span className="text-white font-black text-lg">B</span>
            </div>
            <span className="text-foreground font-bold text-xl tracking-tight">
              Bid<span className="neon-text">Nest</span>
            </span>
          </Link>
          <h1 className="text-2xl font-bold text-foreground">Welcome back</h1>
          <p className="text-foreground-muted text-sm mt-1">Sign in to your account</p>
        </div>

        {/* Form */}
        <div className="glass-strong rounded-2xl border border-border p-8">
          <form onSubmit={handleSubmit} className="space-y-5">
            <Input
              label="Username or Email"
              type="text"
              placeholder="johndoe or john@example.com"
              value={loginValue}
              onChange={(e) => setLoginValue(e.target.value)}
              required
              autoComplete="username"
            />
            <Input
              label="Password"
              type="password"
              placeholder="••••••••"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
              autoComplete="current-password"
            />
            <Button
              type="submit"
              className="w-full"
              size="lg"
              isLoading={isLoading}
            >
              Sign In
            </Button>
          </form>

          <div className="mt-6 text-center">
            <p className="text-sm text-foreground-muted">
              Don&apos;t have an account?{' '}
              <Link href="/register" className="text-cyan-400 hover:text-cyan-300 font-medium transition-colors">
                Create one
              </Link>
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}
========================================
//src/app/members/layout.tsx
import { Sidebar } from '@/components/layout/Sidebar';
import type { ReactNode } from 'react';

export default function MembersLayout({ children }: { children: ReactNode }) {
  return (
    <div className="min-h-screen">
      <Sidebar />
      <main className="lg:pl-64 min-h-screen pb-20 lg:pb-0">
        {children}
      </main>
    </div>
  );
}
========================================
//src/app/members/page.tsx
'use client';

import { useEffect, useState, useCallback, useRef } from 'react';
import { useAuth } from '@/components/providers/AuthProvider';
import { Header } from '@/components/layout/Header';
import { Card, Button, Modal, Input, PageLoader, EmptyState } from '@/components/ui';
import { Badge } from '@/components/ui/Badge';
import Link from 'next/link';
import {
  HiOutlineUserPlus,
  HiOutlineUsers,
  HiOutlineMagnifyingGlass,
  HiOutlinePencil,
  HiOutlineTrash,
} from 'react-icons/hi2';
import toast from 'react-hot-toast';

interface Member {
  id: string;
  name: { value: string; updated_at: string };
  nickname: { value: string; updated_at: string };
  mobile: { value: string; updated_at: string };
  upi_ids: { value: string; added_at: string; is_active: boolean }[];
  is_active: boolean;
  created_at: string;
}

function formatCurrency(amount: number) {
  return new Intl.NumberFormat('en-IN', {
    style: 'currency',
    currency: 'INR',
    maximumFractionDigits: 0,
  }).format(amount);
}

export default function MembersPage() {
  const { user } = useAuth();
  const [members, setMembers] = useState<Member[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [editingMember, setEditingMember] = useState<Member | null>(null);
  const [searchQuery, setSearchQuery] = useState('');
  const hasFetched = useRef(false);

  const loadData = useCallback(async (force = false) => {
    if (!user) return;
    if (!force && hasFetched.current) return;
    hasFetched.current = true;
    try {
      const res = await fetch(`/api/members?user_id=${user.id}`);
      const data = await res.json();
      setMembers(Array.isArray(data) ? data : []);
    } finally {
      setIsLoading(false);
    }
  }, [user]);

  useEffect(() => {
    loadData();
  }, [loadData]);

  const refreshData = useCallback(async () => {
    if (!user) return;
    const res = await fetch(`/api/members?user_id=${user.id}`);
    const data = await res.json();
    setMembers(Array.isArray(data) ? data : []);
  }, [user]);

  const filteredMembers = members.filter(
    (m) =>
      m.name.value.toLowerCase().includes(searchQuery.toLowerCase()) ||
      m.nickname.value.toLowerCase().includes(searchQuery.toLowerCase()) ||
      m.mobile.value.includes(searchQuery)
  );

  const handleDelete = async (member: Member) => {
    if (!confirm(`Deactivate ${member.name.value}?`)) return;
    const res = await fetch(`/api/members/${member.id}`, {
      method: 'DELETE',
    });
    if (res.ok) {
      toast.success('Member deactivated');
      refreshData();
    } else {
      toast.error('Failed to deactivate member');
    }
  };

  if (isLoading) {
    return (
      <>
        <Header title="Members" />
        <PageLoader />
      </>
    );
  }

  return (
    <>
      <Header title="Members" subtitle={`${members.length} registered members`}>
        <Button
          icon={<HiOutlineUserPlus className="w-4 h-4" />}
          onClick={() => setShowCreateModal(true)}
        >
          Add Member
        </Button>
      </Header>

      <div className="p-4 sm:p-6 lg:p-8">
        {/* Search */}
        <div className="mb-6">
          <div className="relative max-w-md">
            <HiOutlineMagnifyingGlass className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-foreground-muted" />
            <input
              type="text"
              placeholder="Search by name, nickname or mobile..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="w-full pl-10 pr-4 py-2.5 glass-input rounded-xl text-sm"
            />
          </div>
        </div>

        {filteredMembers.length === 0 ? (
          <EmptyState
            icon={<HiOutlineUsers className="w-8 h-8" />}
            title="No members found"
            description={
              searchQuery
                ? 'Try adjusting your search.'
                : 'Add your first member to get started.'
            }
          />
        ) : (
          <Card padding={false}>
            <div className="overflow-x-auto">
              <table className="glass-table w-full">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Nickname</th>
                    <th>Mobile</th>
                    <th>UPI IDs</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredMembers.map((member) => (
                    <tr key={member.id}>
                      <td>
                        <Link href={`/members/${member.id}`} className="flex items-center gap-3 group">
                          <div className="w-8 h-8 bg-cyan-500/10 rounded-full flex items-center justify-center text-cyan-400 font-semibold text-sm">
                            {member.name.value.charAt(0).toUpperCase()}
                          </div>
                          <span className="font-medium text-foreground group-hover:text-cyan-400 transition-colors">
                            {member.name.value}
                          </span>
                        </Link>
                      </td>
                      <td>
                        <Badge variant="default">{member.nickname.value}</Badge>
                      </td>
                      <td className="text-foreground-secondary">{member.mobile.value}</td>
                      <td className="text-foreground-muted">
                        {member.upi_ids?.filter((u) => u.is_active).map((u) => u.value).join(', ') || '—'}
                      </td>
                      <td>
                        <Badge variant={member.is_active ? 'success' : 'danger'}>
                          {member.is_active ? 'Active' : 'Inactive'}
                        </Badge>
                      </td>
                      <td>
                        <div className="flex items-center gap-2">
                          <button
                            onClick={() => setEditingMember(member)}
                            className="p-1.5 text-foreground-muted hover:text-cyan-400 hover:bg-cyan-500/10 rounded-lg transition-all"
                          >
                            <HiOutlinePencil className="w-4 h-4" />
                          </button>
                          <button
                            onClick={() => handleDelete(member)}
                            className="p-1.5 text-foreground-muted hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-all"
                          >
                            <HiOutlineTrash className="w-4 h-4" />
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </Card>
        )}
      </div>

      {/* Create Modal */}
      <MemberFormModal
        isOpen={showCreateModal}
        onClose={() => setShowCreateModal(false)}
        onSaved={() => {
          setShowCreateModal(false);
          refreshData();
        }}
      />

      {/* Edit Modal */}
      {editingMember && (
        <MemberFormModal
          isOpen={!!editingMember}
          member={editingMember}
          onClose={() => setEditingMember(null)}
          onSaved={() => {
            setEditingMember(null);
            refreshData();
          }}
        />
      )}
    </>
  );
}

// ─── Member Form Modal ──────────────────────────────────────────────────────

function MemberFormModal({
  isOpen,
  member,
  onClose,
  onSaved,
}: {
  isOpen: boolean;
  member?: Member;
  onClose: () => void;
  onSaved: () => void;
}) {
  const isEditing = !!member;
  const [name, setName] = useState(member?.name.value ?? '');
  const [nickname, setNickname] = useState(member?.nickname.value ?? '');
  const [mobile, setMobile] = useState(member?.mobile.value ?? '');
  const [upiId, setUpiId] = useState(
    member?.upi_ids?.find((u) => u.is_active)?.value ?? ''
  );
  const [isSubmitting, setIsSubmitting] = useState(false);

  useEffect(() => {
    setName(member?.name.value ?? '');
    setNickname(member?.nickname.value ?? '');
    setMobile(member?.mobile.value ?? '');
    setUpiId(member?.upi_ids?.find((u) => u.is_active)?.value ?? '');
  }, [member]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);

    const now = new Date().toISOString();

    // get user_id from /api/auth/me
    const meRes = await fetch('/api/auth/me');
    const me = await meRes.json();

    const payload = {
      user_id: me.id,
      name: { value: name.trim(), updated_at: now },
      nickname: { value: nickname.trim(), updated_at: now },
      mobile: { value: mobile.trim(), updated_at: now },
      upi_ids: upiId.trim()
        ? [{ value: upiId.trim(), added_at: now, is_active: true }]
        : [],
    };

    const res = isEditing
      ? await fetch(`/api/members/${member!.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: { value: name.trim(), updated_at: now },
            nickname: { value: nickname.trim(), updated_at: now },
            mobile: { value: mobile.trim(), updated_at: now },
            upi_ids: upiId.trim()
              ? [{ value: upiId.trim(), added_at: now, is_active: true }]
              : [],
          }),
        })
      : await fetch('/api/members', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

    const data = await res.json();

    if (!res.ok) {
      toast.error(data.error || 'Something went wrong');
    } else {
      toast.success(isEditing ? 'Member updated!' : 'Member added!');
      onSaved();
    }

    setIsSubmitting(false);
  };

  return (
    <Modal
      isOpen={isOpen}
      onClose={onClose}
      title={isEditing ? 'Edit Member' : 'Add New Member'}
    >
      <form onSubmit={handleSubmit} className="space-y-4">
        <Input
          label="Full Name"
          value={name}
          onChange={(e) => setName(e.target.value)}
          placeholder="e.g. Rajesh Kumar"
          required
        />
        <Input
          label="Nickname"
          value={nickname}
          onChange={(e) => setNickname(e.target.value)}
          placeholder="e.g. Raju"
          required
        />
        <Input
          label="Mobile Number"
          type="tel"
          value={mobile}
          onChange={(e) => setMobile(e.target.value)}
          placeholder="e.g. 9876543210"
          required
        />
        <Input
          label="UPI ID (optional)"
          value={upiId}
          onChange={(e) => setUpiId(e.target.value)}
          placeholder="e.g. rajesh@upi"
        />
        <div className="flex justify-end gap-3 pt-4 border-t border-border">
          <Button variant="outline" onClick={onClose} type="button">
            Cancel
          </Button>
          <Button type="submit" isLoading={isSubmitting}>
            {isEditing ? 'Save Changes' : 'Add Member'}
          </Button>
        </div>
      </form>
    </Modal>
  );
}
========================================
//src/app/members/[id]/layout.tsx
import type { ReactNode } from 'react';

// Parent members/layout.tsx already provides the Sidebar shell.
// This layout just passes children through to avoid a duplicate sidebar.
export default function MemberDetailLayout({ children }: { children: ReactNode }) {
  return <>{children}</>;
}
========================================
//src/app/members/[id]/page.tsx
'use client';

import { useEffect, useState } from 'react';
import { useParams, useRouter } from 'next/navigation';
import { Header } from '@/components/layout/Header';
import { Card, PageLoader, StatusBadge } from '@/components/ui';
import {
  HiOutlineUser,
  HiOutlinePhone,
  HiOutlineCreditCard,
  HiOutlineArrowLeft,
  HiOutlineTicket,
  HiOutlineBanknotes,
} from 'react-icons/hi2';

interface Member {
  id: string;
  name: { value: string };
  nickname: { value: string };
  mobile: { value: string };
  upi_ids: { value: string; added_at: string; is_active: boolean }[];
  is_active: boolean;
  created_at: string;
}

interface ChitMember {
  id: string;
  ticket_number: number;
  is_active: boolean;
  chit_group: {
    id: string;
    total_amount: string;
    total_members: number;
    monthly_amount: string;
    status: string;
  };
}

interface Payment {
  id: string;
  month_number: number;
  amount_paid: string;
  status: string;
  payment_method: string;
  payment_date: string;
}

function formatCurrency(amount: number) {
  return new Intl.NumberFormat('en-IN', {
    style: 'currency',
    currency: 'INR',
    maximumFractionDigits: 0,
  }).format(amount);
}

export default function MemberDetailPage() {
  const { id } = useParams();
  const router = useRouter();
  const [member, setMember] = useState<Member | null>(null);
  const [chitMembers, setChitMembers] = useState<ChitMember[]>([]);
  const [payments, setPayments] = useState<Payment[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    const load = async () => {
      try {
        const [memberRes, chitMembersRes] = await Promise.all([
          fetch(`/api/members/${id}`),
          fetch(`/api/chit-members?member_id=${id}`),
        ]);

        const memberData = await memberRes.json();
        const chitMembersData = await chitMembersRes.json();

        setMember(memberData?.id ? memberData : null);
        const safeChitMembers = Array.isArray(chitMembersData) ? chitMembersData : [];
        setChitMembers(safeChitMembers);

        // load payments for all chit member tickets
        const allPayments: Payment[] = [];
        for (const cm of safeChitMembers) {
          const pRes = await fetch(`/api/payments?chit_member_id=${cm.id}`);
          const pData = await pRes.json();
          if (Array.isArray(pData)) allPayments.push(...pData);
        }
        setPayments(allPayments);
      } finally {
        setIsLoading(false);
      }
    };
    load();
  }, [id]);

  if (isLoading) {
    return (
      <>
        <Header title="Member Details" />
        <PageLoader />
      </>
    );
  }

  if (!member) {
    return (
      <>
        <Header title="Member Not Found" />
        <div className="p-8 text-center text-foreground-muted">Member not found.</div>
      </>
    );
  }

  const totalPaid = payments.reduce((sum, p) => sum + Number(p.amount_paid), 0);

  return (
    <>
      <Header title={member.name.value || 'Member Details'} subtitle={member.nickname.value ? `"${member.nickname.value}"` : undefined} />

      <div className="p-4 sm:p-6 lg:p-8 max-w-4xl space-y-6">
        {/* Back */}
        <button
          onClick={() => router.back()}
          className="flex items-center gap-2 text-sm text-foreground-muted hover:text-cyan-400 transition-colors"
        >
          <HiOutlineArrowLeft className="w-4 h-4" />
          Back to Members
        </button>

        {/* Profile Card */}
        <Card>
          <div className="flex flex-col sm:flex-row items-center sm:items-start gap-6">
            <div className="w-20 h-20 rounded-2xl bg-linear-to-br from-cyan-500 to-purple-500 flex items-center justify-center text-white font-bold text-3xl shadow-lg shadow-cyan-500/20 shrink-0">
              {member.name.value.charAt(0).toUpperCase()}
            </div>
            <div className="flex-1 text-center sm:text-left">
              <h2 className="text-2xl font-bold text-foreground">{member.name.value}</h2>
              <p className="text-foreground-muted mt-1">"{member.nickname.value}"</p>
              <div className="flex flex-wrap items-center justify-center sm:justify-start gap-3 mt-3">
                <StatusBadge status={member.is_active ? 'ACTIVE' : 'CANCELLED'} />
                <span className="text-xs text-foreground-muted">
                  Joined {new Date(member.created_at).toLocaleDateString('en-IN', { day: '2-digit', month: 'long', year: 'numeric' })}
                </span>
              </div>
            </div>
            {/* Summary Stats */}
            <div className="grid grid-cols-2 gap-3 sm:grid-cols-1 lg:grid-cols-2">
              <div className="bg-surface border border-border rounded-xl p-3 text-center">
                <p className="text-xs text-foreground-muted">Groups</p>
                <p className="text-xl font-bold text-cyan-400">{chitMembers.length}</p>
              </div>
              <div className="bg-surface border border-border rounded-xl p-3 text-center">
                <p className="text-xs text-foreground-muted">Total Paid</p>
                <p className="text-xl font-bold text-emerald-400">{formatCurrency(totalPaid)}</p>
              </div>
            </div>
          </div>
        </Card>

        {/* Contact Info */}
        <Card>
          <h3 className="text-base font-semibold text-foreground mb-4">Contact Information</h3>
          <div className="space-y-0">
            <InfoRow
              icon={<HiOutlinePhone className="w-4 h-4" />}
              label="Mobile"
              value={member.mobile.value}
            />
            <InfoRow
              icon={<HiOutlineCreditCard className="w-4 h-4" />}
              label="UPI IDs"
              value={
                member.upi_ids?.filter((u) => u.is_active).length > 0
                  ? member.upi_ids.filter((u) => u.is_active).map((u) => u.value).join(', ')
                  : '—'
              }
            />
            <InfoRow
              icon={<HiOutlineUser className="w-4 h-4" />}
              label="Member ID"
              value={<span className="font-mono text-xs">{member.id.slice(0, 20)}...</span>}
            />
          </div>
        </Card>

        {/* Chit Group Tickets */}
        <Card>
          <h3 className="text-base font-semibold text-foreground mb-4 flex items-center gap-2">
            <HiOutlineTicket className="w-5 h-5 text-cyan-400" />
            Chit Group Tickets
          </h3>
          {chitMembers.length === 0 ? (
            <p className="text-sm text-foreground-muted text-center py-4">
              Not assigned to any chit group yet.
            </p>
          ) : (
            <div className="space-y-3">
              {chitMembers.map((cm) => (
                <div
                  key={cm.id}
                  className="flex items-center justify-between p-4 bg-surface border border-border rounded-xl"
                >
                  <div className="flex items-center gap-4">
                    <div className="w-10 h-10 rounded-xl bg-cyan-500/10 flex items-center justify-center text-cyan-400 font-bold">
                      #{cm.ticket_number}
                    </div>
                    <div>
                      <p className="font-medium text-foreground">
                        {formatCurrency(Number(cm.chit_group.total_amount))} Group
                      </p>
                      <p className="text-xs text-foreground-muted">
                        {cm.chit_group.total_members} members · {formatCurrency(Number(cm.chit_group.monthly_amount))}/month
                      </p>
                    </div>
                  </div>
                  <StatusBadge status={cm.chit_group.status} />
                </div>
              ))}
            </div>
          )}
        </Card>

        {/* Payment History */}
        <Card padding={false}>
          <div className="p-6 pb-4 flex items-center gap-2">
            <HiOutlineBanknotes className="w-5 h-5 text-cyan-400" />
            <h3 className="text-base font-semibold text-foreground">Payment History</h3>
          </div>
          {payments.length === 0 ? (
            <p className="text-sm text-foreground-muted text-center py-8">No payments recorded yet.</p>
          ) : (
            <div className="overflow-x-auto px-6 pb-6">
              <table className="glass-table w-full">
                <thead>
                  <tr>
                    <th>Month</th>
                    <th>Amount</th>
                    <th>Method</th>
                    <th>Date</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {payments.map((p) => (
                    <tr key={p.id}>
                      <td>Month {p.month_number}</td>
                      <td className="font-semibold text-cyan-400">
                        {formatCurrency(Number(p.amount_paid))}
                      </td>
                      <td>
                        <span className="px-2 py-0.5 rounded-lg text-xs font-medium bg-surface border border-border text-foreground-secondary">
                          {p.payment_method}
                        </span>
                      </td>
                      <td className="text-foreground-muted">
                        {new Date(p.payment_date).toLocaleDateString('en-IN')}
                      </td>
                      <td>
                        <StatusBadge status={p.status} />
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </Card>
      </div>
    </>
  );
}

function InfoRow({
  icon,
  label,
  value,
}: {
  icon: React.ReactNode;
  label: string;
  value: React.ReactNode;
}) {
  return (
    <div className="flex items-center justify-between py-3 border-b border-border last:border-0">
      <span className="flex items-center gap-2 text-sm text-foreground-muted">
        {icon}
        {label}
      </span>
      <span className="text-sm text-foreground-secondary">{value}</span>
    </div>
  );
}
========================================
//src/app/payments/layout.tsx
import { Sidebar } from '@/components/layout/Sidebar';
import type { ReactNode } from 'react';

export default function PaymentsLayout({ children }: { children: ReactNode }) {
  return (
    <div className="min-h-screen">
      <Sidebar />
      <main className="lg:pl-64 min-h-screen pb-20 lg:pb-0">
        {children}
      </main>
    </div>
  );
}
========================================
//src/app/payments/page.tsx
'use client';

import { useEffect, useState, useCallback, useRef } from 'react';
import { useAuth } from '@/components/providers/AuthProvider';
import { Header } from '@/components/layout/Header';
import { Card, Button, Modal, Input, PageLoader, EmptyState, Select } from '@/components/ui';
import { StatusBadge } from '@/components/ui/Badge';
import { HiOutlineBanknotes, HiOutlinePlus } from 'react-icons/hi2';
import toast from 'react-hot-toast';

interface ChitGroup {
  id: string;
  name: string;
  total_amount: string;
  total_members: number;
  monthly_amount: string;
  status: string;
}

interface ChitMember {
  id: string;
  ticket_number: number;
  chit_group_id: string;
  member: {
    name: { value: string };
  };
}

interface Payment {
  id: string;
  chit_group_id: string;
  chit_member_id: string;
  month_number: number;
  amount_paid: string;
  payment_method: string;
  upi_id: string | null;
  payment_date: string;
  status: string;
  notes: string | null;
  created_at: string;
  chit_member: {
    ticket_number: number;
    member: { name: { value: string } };
  };
}

function formatCurrency(amount: number) {
  return new Intl.NumberFormat('en-IN', {
    style: 'currency',
    currency: 'INR',
    maximumFractionDigits: 0,
  }).format(amount);
}

export default function PaymentsPage() {
  const [payments, setPayments] = useState<Payment[]>([]);
  const [groups, setGroups] = useState<ChitGroup[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const { user } = useAuth();
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [filterGroup, setFilterGroup] = useState('all');
  const [filterStatus, setFilterStatus] = useState('all');
  const hasFetched = useRef(false);

  const loadData = useCallback(async (force = false) => {
    if (!user) return;
    if (!force && hasFetched.current) return;
    hasFetched.current = true;
    try {
      const [paymentsRes, groupsRes] = await Promise.all([
        fetch(`/api/payments?user_id=${user.id}`),
        fetch(`/api/chit-groups?user_id=${user.id}`),
      ]);
      const p = await paymentsRes.json();
      const g = await groupsRes.json();
      setPayments(Array.isArray(p) ? p : []);
      setGroups(Array.isArray(g) ? g : []);
    } finally {
      setIsLoading(false);
    }
  }, [user]);

  useEffect(() => {
    loadData();
  }, [loadData]);

  const refreshData = useCallback(async () => {
    if (!user) return;
    const [paymentsRes, groupsRes] = await Promise.all([
      fetch(`/api/payments?user_id=${user.id}`),
      fetch(`/api/chit-groups?user_id=${user.id}`),
    ]);
    const p = await paymentsRes.json();
    const g = await groupsRes.json();
    setPayments(Array.isArray(p) ? p : []);
    setGroups(Array.isArray(g) ? g : []);
  }, [user]);

  const filteredPayments = payments.filter((p) => {
    if (filterGroup !== 'all' && p.chit_group_id !== filterGroup) return false;
    if (filterStatus !== 'all' && p.status !== filterStatus) return false;
    return true;
  });

  // summary stats
  const totalCollected = payments.reduce((sum, p) => sum + Number(p.amount_paid), 0);
  const totalCompleted = payments.filter((p) => p.status === 'COMPLETED').length;
  const totalPartial = payments.filter((p) => p.status === 'PARTIAL').length;

  if (isLoading) {
    return (
      <>
        <Header title="Payments" />
        <PageLoader />
      </>
    );
  }

  return (
    <>
      <Header title="Payments" subtitle={`${payments.length} total records`}>
        <Button
          icon={<HiOutlinePlus className="w-4 h-4" />}
          onClick={() => setShowCreateModal(true)}
        >
          Record Payment
        </Button>
      </Header>

      <div className="p-4 sm:p-6 lg:p-8 space-y-6">
        {/* Summary Cards */}
        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div className="glass rounded-2xl border border-border p-5">
            <p className="text-sm text-foreground-muted mb-1">Total Collected</p>
            <p className="text-2xl font-bold text-cyan-400">{formatCurrency(totalCollected)}</p>
          </div>
          <div className="glass rounded-2xl border border-border p-5">
            <p className="text-sm text-foreground-muted mb-1">Completed</p>
            <p className="text-2xl font-bold text-emerald-400">{totalCompleted}</p>
          </div>
          <div className="glass rounded-2xl border border-border p-5">
            <p className="text-sm text-foreground-muted mb-1">Partial</p>
            <p className="text-2xl font-bold text-amber-400">{totalPartial}</p>
          </div>
        </div>

        {/* Filters */}
        <div className="flex flex-wrap gap-4">
          <div className="w-48">
            <Select
              value={filterGroup}
              onChange={(e) => setFilterGroup(e.target.value)}
              options={[
                { value: 'all', label: 'All Groups' },
                ...groups.map((g) => ({
                  value: g.id,
                  label: `${formatCurrency(Number(g.total_amount))} · ${g.total_members}M`,
                })),
              ]}
            />
          </div>
          <div className="w-48">
            <Select
              value={filterStatus}
              onChange={(e) => setFilterStatus(e.target.value)}
              options={[
                { value: 'all', label: 'All Status' },
                { value: 'COMPLETED', label: 'Completed' },
                { value: 'PARTIAL', label: 'Partial' },
              ]}
            />
          </div>
        </div>

        {/* Table */}
        {filteredPayments.length === 0 ? (
          <EmptyState
            icon={<HiOutlineBanknotes className="w-8 h-8" />}
            title="No payments found"
            description="Record your first payment to get started."
          />
        ) : (
          <Card padding={false}>
            <div className="overflow-x-auto">
              <table className="glass-table w-full">
                <thead>
                  <tr>
                    <th>Member</th>
                    <th>Ticket</th>
                    <th>Month</th>
                    <th>Amount Paid</th>
                    <th>Method</th>
                    <th>UPI ID</th>
                    <th>Payment Date</th>
                    <th>Status</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredPayments.map((payment) => (
                    <tr key={payment.id}>
                      <td className="font-medium text-foreground">
                        {payment.chit_member?.member?.name?.value || 'N/A'}
                      </td>
                      <td>#{payment.chit_member?.ticket_number}</td>
                      <td>{payment.month_number}</td>
                      <td className="font-semibold text-cyan-400">
                        {formatCurrency(Number(payment.amount_paid))}
                      </td>
                      <td>
                        <span className="px-2 py-0.5 rounded-lg text-xs font-medium bg-surface border border-border text-foreground-secondary">
                          {payment.payment_method}
                        </span>
                      </td>
                      <td className="text-foreground-muted">
                        {payment.upi_id || '—'}
                      </td>
                      <td className="text-foreground-muted">
                        {new Date(payment.payment_date).toLocaleDateString('en-IN')}
                      </td>
                      <td>
                        <StatusBadge status={payment.status} />
                      </td>
                      <td className="text-foreground-muted">
                        {payment.notes || '—'}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </Card>
        )}
      </div>

      {/* Record Payment Modal */}
      <PaymentFormModal
        isOpen={showCreateModal}
        groups={groups}
        onClose={() => setShowCreateModal(false)}
        onSaved={() => {
          setShowCreateModal(false);
          refreshData();
        }}
      />
    </>
  );
}

// ─── Payment Form Modal ─────────────────────────────────────────────────────

function PaymentFormModal({
  isOpen,
  groups,
  onClose,
  onSaved,
}: {
  isOpen: boolean;
  groups: ChitGroup[];
  onClose: () => void;
  onSaved: () => void;
}) {
  const [selectedGroupId, setSelectedGroupId] = useState('');
  const [chitMembers, setChitMembers] = useState<ChitMember[]>([]);
  const [selectedMemberId, setSelectedMemberId] = useState('');
  const [monthNumber, setMonthNumber] = useState('');
  const [amountPaid, setAmountPaid] = useState('');
  const [paymentMethod, setPaymentMethod] = useState('CASH');
  const [upiId, setUpiId] = useState('');
  const [paymentDate, setPaymentDate] = useState(
    new Date().toISOString().split('T')[0]
  );
  const [notes, setNotes] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  // load chit members when group selected
  useEffect(() => {
    if (!selectedGroupId) return;
    fetch(`/api/chit-members?chit_group_id=${selectedGroupId}`)
      .then((r) => r.json())
      .then(setChitMembers);
  }, [selectedGroupId]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);

    const res = await fetch('/api/payments', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chit_group_id: selectedGroupId,
        chit_member_id: selectedMemberId,
        month_number: Number(monthNumber),
        amount_paid: Number(amountPaid),
        payment_method: paymentMethod,
        upi_id: paymentMethod === 'UPI' ? upiId : undefined,
        payment_date: new Date(paymentDate).toISOString(),
        notes: notes || undefined,
      }),
    });

    const data = await res.json();

    if (!res.ok) {
      toast.error(data.error || 'Failed to record payment');
    } else {
      toast.success(
        `Payment recorded! Status: ${data.status} · Remaining: ${
          data.remaining > 0
            ? new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(data.remaining)
            : '₹0'
        }`
      );
      onSaved();
    }

    setIsSubmitting(false);
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="Record Payment" size="lg">
      <form onSubmit={handleSubmit} className="space-y-4">
        <Select
          label="Chit Group"
          value={selectedGroupId}
          onChange={(e) => {
            setSelectedGroupId(e.target.value);
            setSelectedMemberId('');
          }}
          options={[
            { value: '', label: 'Select a group...' },
            ...groups.map((g) => ({
              value: g.id,
              label: `${g.name} — ${formatCurrency(Number(g.total_amount))} · ${g.total_members}M`,
            })),
          ]}
        />

        <Select
          label="Member (Ticket)"
          value={selectedMemberId}
          onChange={(e) => setSelectedMemberId(e.target.value)}
          options={[
            { value: '', label: 'Select member...' },
            ...chitMembers.map((cm) => ({
              value: cm.id,
              label: `#${cm.ticket_number} — ${cm.member?.name?.value || 'Unknown'}`,
            })),
          ]}
        />

        <div className="grid grid-cols-2 gap-4">
          <Input
            label="Month Number"
            type="number"
            value={monthNumber}
            onChange={(e) => setMonthNumber(e.target.value)}
            placeholder="e.g. 1"
            required
          />
          <Input
            label="Amount Paid (₹)"
            type="number"
            value={amountPaid}
            onChange={(e) => setAmountPaid(e.target.value)}
            placeholder="e.g. 990"
            required
          />
        </div>

        <div className="grid grid-cols-2 gap-4">
          <Select
            label="Payment Method"
            value={paymentMethod}
            onChange={(e) => setPaymentMethod(e.target.value)}
            options={[
              { value: 'CASH', label: 'Cash' },
              { value: 'UPI', label: 'UPI' },
              { value: 'BANK_TRANSFER', label: 'Bank Transfer' },
            ]}
          />
          <Input
            label="Payment Date"
            type="date"
            value={paymentDate}
            onChange={(e) => setPaymentDate(e.target.value)}
            required
          />
        </div>

        {paymentMethod === 'UPI' && (
          <Input
            label="UPI ID"
            value={upiId}
            onChange={(e) => setUpiId(e.target.value)}
            placeholder="e.g. john@upi"
            required
          />
        )}

        <Input
          label="Notes (optional)"
          value={notes}
          onChange={(e) => setNotes(e.target.value)}
          placeholder="e.g. Cash payment received"
        />

        <div className="flex justify-end gap-3 pt-4 border-t border-border">
          <Button variant="outline" onClick={onClose} type="button">
            Cancel
          </Button>
          <Button type="submit" isLoading={isSubmitting}>
            Record Payment
          </Button>
        </div>
      </form>
    </Modal>
  );
}
========================================
//src/app/payments/tracking/page.tsx
'use client';

import { useEffect, useState, useCallback } from 'react';
import { useAuth } from '@/components/providers/AuthProvider';
import { Header } from '@/components/layout/Header';
import { Card, Button, Modal, Input, PageLoader, EmptyState, Select } from '@/components/ui';
import {
  HiOutlineClipboardDocumentList,
  HiOutlineBanknotes,
  HiOutlineTrophy,
} from 'react-icons/hi2';
import toast from 'react-hot-toast';

// ─── Types ────────────────────────────────────────────────

interface ChitGroup {
  id: string;
  name: string;
  total_amount: string;
  total_members: number;
  monthly_amount: string;
  status: string;
}

interface Auction {
  id: string;
  month_number: number;
  winner_chit_member_id: string;
  calculation_data: {
    amount_to_collect: number;
    dividend_per_member: number;
    monthly_contribution: number;
  };
}

interface ChitMember {
  id: string;
  ticket_number: number;
  is_active: boolean;
  member: {
    id: string;
    name: { value: string };
    mobile: { value: string };
  };
}

interface Payment {
  id: string;
  chit_member_id: string;
  month_number: number;
  amount_paid: string;
  status: string;
}

interface MemberRow {
  chitMemberId: string;
  ticketNumber: number;
  memberName: string;
  mobile: string;
  isWinner: boolean;
  monthlyDue: number;
  totalPaid: number;
  remaining: number;
  status: 'WINNER' | 'COMPLETED' | 'PARTIAL' | 'PENDING';
}

// All-months aggregated row
interface AggregatedRow {
  chitMemberId: string;
  ticketNumber: number;
  memberName: string;
  mobile: string;
  totalDue: number;       // sum of amount_to_collect for non-winner months
  totalPaid: number;      // sum of all payments across all months
  remaining: number;      // totalDue - totalPaid
  wonMonths: number[];    // months this member won
  monthBreakdown: {
    month: number;
    due: number;
    paid: number;
    remaining: number;
    isWinner: boolean;
  }[];
  status: 'CLEAR' | 'COMPLETED' | 'PARTIAL' | 'PENDING';
}

function formatCurrency(amount: number) {
  return new Intl.NumberFormat('en-IN', {
    style: 'currency',
    currency: 'INR',
    maximumFractionDigits: 0,
  }).format(amount);
}

// ─── Main Page ────────────────────────────────────────────

export default function PaymentTrackingPage() {
  const { user } = useAuth();
  const [groups, setGroups] = useState<ChitGroup[]>([]);
  const [selectedGroupId, setSelectedGroupId] = useState('');
  const [auctions, setAuctions] = useState<Auction[]>([]);
  // 'all' = aggregated view across all months
  const [selectedMonth, setSelectedMonth] = useState<number | 'all' | null>(null);
  const [chitMembers, setChitMembers] = useState<ChitMember[]>([]);
  const [payments, setPayments] = useState<Payment[]>([]);
  const [isLoadingGroups, setIsLoadingGroups] = useState(true);
  const [isLoadingData, setIsLoadingData] = useState(false);
  const [payingMember, setPayingMember] = useState<MemberRow | null>(null);
  const [payingMemberBreakdown, setPayingMemberBreakdown] = useState<AggregatedRow['monthBreakdown']>([]);
  const [expandedRow, setExpandedRow] = useState<string | null>(null);

  // Load user's groups
  useEffect(() => {
    if (!user) return;
    fetch(`/api/chit-groups?user_id=${user.id}`)
      .then((r) => r.json())
      .then((data) => setGroups(Array.isArray(data) ? data : []))
      .finally(() => setIsLoadingGroups(false));
  }, [user]);

  // Load auctions when group changes
  useEffect(() => {
    if (!selectedGroupId) {
      setAuctions([]);
      setSelectedMonth(null);
      return;
    }
    fetch(`/api/auctions?chit_group_id=${selectedGroupId}`)
      .then((r) => r.json())
      .then((data) => {
        const list = Array.isArray(data) ? data : [];
        setAuctions(list);
        // default to 'All Months' aggregated view when auctions exist
        setSelectedMonth(list.length > 0 ? 'all' : null);
      });
  }, [selectedGroupId]);

  // Load chit members + payments when group/month changes
  const loadMonthData = useCallback(async () => {
    if (!selectedGroupId || selectedMonth === null) return;
    setIsLoadingData(true);
    try {
      // For 'all' mode, fetch all payments (no month filter)
      const paymentsUrl =
        selectedMonth === 'all'
          ? `/api/payments?chit_group_id=${selectedGroupId}`
          : `/api/payments?chit_group_id=${selectedGroupId}&month_number=${selectedMonth}`;

      const [membersRes, paymentsRes] = await Promise.all([
        fetch(`/api/chit-members?chit_group_id=${selectedGroupId}`),
        fetch(paymentsUrl),
      ]);
      const membersData = await membersRes.json();
      const paymentsData = await paymentsRes.json();
      setChitMembers(Array.isArray(membersData) ? membersData : []);
      setPayments(Array.isArray(paymentsData) ? paymentsData : []);
    } finally {
      setIsLoadingData(false);
    }
  }, [selectedGroupId, selectedMonth]);

  useEffect(() => {
    loadMonthData();
  }, [loadMonthData]);

  // Derive per-member rows (single-month mode)
  const currentAuction = selectedMonth !== 'all'
    ? auctions.find((a) => a.month_number === selectedMonth)
    : undefined;

  const memberRows: MemberRow[] = chitMembers.map((cm) => {
    const isWinner = currentAuction?.winner_chit_member_id === cm.id;
    const monthlyDue = currentAuction?.calculation_data?.amount_to_collect ?? 0;

    const memberPayments = payments.filter((p) => p.chit_member_id === cm.id);
    const totalPaid = memberPayments.reduce((s, p) => s + Number(p.amount_paid), 0);
    const remaining = Math.max(0, monthlyDue - totalPaid);

    let status: MemberRow['status'];
    if (isWinner) {
      status = 'WINNER';
    } else if (totalPaid >= monthlyDue && monthlyDue > 0) {
      status = 'COMPLETED';
    } else if (totalPaid > 0) {
      status = 'PARTIAL';
    } else {
      status = 'PENDING';
    }

    return {
      chitMemberId: cm.id,
      ticketNumber: cm.ticket_number,
      memberName: cm.member?.name?.value || 'Unknown',
      mobile: cm.member?.mobile?.value || '—',
      isWinner,
      monthlyDue,
      totalPaid,
      remaining,
      status,
    };
  });

  // Summary counts
  const isAllMode = selectedMonth === 'all';

  // ── All-months aggregated rows ──
  const aggregatedRows: AggregatedRow[] = chitMembers.map((cm) => {
    let totalDue = 0;
    const wonMonths: number[] = [];
    const monthBreakdown: AggregatedRow['monthBreakdown'] = [];

    for (const auction of auctions.slice().sort((a, b) => a.month_number - b.month_number)) {
      const isWinner = auction.winner_chit_member_id === cm.id;
      const monthDue = isWinner ? 0 : (auction.calculation_data?.amount_to_collect ?? 0);
      const monthPayments = payments.filter(
        (p) => p.chit_member_id === cm.id && p.month_number === auction.month_number
      );
      const monthPaid = monthPayments.reduce((s, p) => s + Number(p.amount_paid), 0);
      const monthRemaining = isWinner ? 0 : Math.max(0, monthDue - monthPaid);

      if (isWinner) wonMonths.push(auction.month_number);
      totalDue += monthDue;
      monthBreakdown.push({ month: auction.month_number, due: monthDue, paid: monthPaid, remaining: monthRemaining, isWinner });
    }

    const totalPaid = payments
      .filter((p) => p.chit_member_id === cm.id)
      .reduce((s, p) => s + Number(p.amount_paid), 0);
    const remaining = Math.max(0, totalDue - totalPaid);

    let status: AggregatedRow['status'];
    if (auctions.length === 0) status = 'PENDING';
    else if (remaining <= 0 && totalDue > 0) status = 'COMPLETED';
    else if (totalDue === 0 && wonMonths.length === auctions.length) status = 'CLEAR';
    else if (totalPaid > 0 && remaining > 0) status = 'PARTIAL';
    else status = 'PENDING';

    return { chitMemberId: cm.id, ticketNumber: cm.ticket_number, memberName: cm.member?.name?.value || 'Unknown', mobile: cm.member?.mobile?.value || '—', totalDue, totalPaid, remaining, wonMonths, monthBreakdown, status };
  });

  const counts = isAllMode
    ? {
        total: aggregatedRows.length,
        completed: aggregatedRows.filter((r) => r.status === 'COMPLETED').length,
        partial: aggregatedRows.filter((r) => r.status === 'PARTIAL').length,
        pending: aggregatedRows.filter((r) => r.status === 'PENDING').length,
        winner: 0,
      }
    : {
    total: memberRows.length,
    completed: memberRows.filter((r) => r.status === 'COMPLETED').length,
    partial: memberRows.filter((r) => r.status === 'PARTIAL').length,
    pending: memberRows.filter((r) => r.status === 'PENDING').length,
    winner: memberRows.filter((r) => r.status === 'WINNER').length,
  };

  const totalCollected = isAllMode
    ? aggregatedRows.reduce((s, r) => s + r.totalPaid, 0)
    : memberRows.reduce((s, r) => s + r.totalPaid, 0);
  const totalExpected = isAllMode
    ? aggregatedRows.reduce((s, r) => s + r.totalDue, 0)
    : memberRows.filter((r) => !r.isWinner).reduce((s, r) => s + r.monthlyDue, 0);

  if (isLoadingGroups) {
    return (
      <>
        <Header title="Payment Tracker" />
        <PageLoader />
      </>
    );
  }

  return (
    <>
      <Header
        title="Payment Tracker"
        subtitle="Track monthly payment status for each member"
      />

      <div className="p-4 sm:p-6 lg:p-8 space-y-6">
        {/* Filters */}
        <Card>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <Select
              label="Chit Group"
              value={selectedGroupId}
              onChange={(e) => setSelectedGroupId(e.target.value)}
              options={[
                { value: '', label: 'Select a group...' },
                ...groups.map((g) => ({
                  value: g.id,
                  label: `${g.name} — ${formatCurrency(Number(g.total_amount))} · ${g.total_members}M`,
                })),
              ]}
            />
            <Select
              label="Month"
              value={selectedMonth?.toString() ?? ''}
              onChange={(e) => {
                const v = e.target.value;
                setSelectedMonth(v === 'all' ? 'all' : Number(v));
              }}
              options={[
                { value: '', label: 'Select month...' },
                ...(auctions.length > 0 ? [{ value: 'all', label: '📊 All Months (Combined)' }] : []),
                ...auctions
                  .slice()
                  .sort((a, b) => a.month_number - b.month_number)
                  .map((a) => ({
                    value: String(a.month_number),
                    label: `Month ${a.month_number}`,
                  })),
              ]}
              disabled={auctions.length === 0}
            />
          </div>
        </Card>

        {!selectedGroupId && (
          <EmptyState
            icon={<HiOutlineClipboardDocumentList className="w-8 h-8" />}
            title="Select a group"
            description="Choose a chit group to see payment status."
          />
        )}

        {selectedGroupId && auctions.length === 0 && (
          <EmptyState
            icon={<HiOutlineTrophy className="w-8 h-8" />}
            title="No auctions yet"
            description="Conduct the first auction before tracking payments."
          />
        )}

        {selectedGroupId && selectedMonth !== null && !isLoadingData && (
          <>
            {/* Summary Stats */}
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
              <div className="glass rounded-2xl border border-border p-4">
                <p className="text-xs text-foreground-muted mb-1">Total Collected</p>
                <p className="text-xl font-bold text-cyan-400">{formatCurrency(totalCollected)}</p>
                <p className="text-xs text-foreground-muted mt-1">of {formatCurrency(totalExpected)}</p>
              </div>
              <div className="glass rounded-2xl border border-border p-4">
                <p className="text-xs text-foreground-muted mb-1">Completed</p>
                <p className="text-xl font-bold text-emerald-400">{counts.completed}</p>
                <p className="text-xs text-foreground-muted mt-1">members</p>
              </div>
              <div className="glass rounded-2xl border border-border p-4">
                <p className="text-xs text-foreground-muted mb-1">Partial</p>
                <p className="text-xl font-bold text-amber-400">{counts.partial}</p>
                <p className="text-xs text-foreground-muted mt-1">members</p>
              </div>
              <div className="glass rounded-2xl border border-border p-4">
                <p className="text-xs text-foreground-muted mb-1">Pending</p>
                <p className="text-xl font-bold text-red-400">{counts.pending}</p>
                <p className="text-xs text-foreground-muted mt-1">members</p>
              </div>
            </div>

            {/* Progress bar */}
            {totalExpected > 0 && (
              <Card>
                <div className="flex justify-between text-sm mb-2">
                  <span className="text-foreground-muted">
                    {isAllMode
                      ? `Overall Collection Progress (${auctions.length} months)`
                      : `Month ${selectedMonth} Progress`}
                  </span>
                  <span className="text-foreground font-medium">
                    {formatCurrency(totalCollected)} / {formatCurrency(totalExpected)}
                    <span className="text-foreground-muted ml-2">
                      ({Math.round((totalCollected / totalExpected) * 100)}%)
                    </span>
                  </span>
                </div>
                <div className="neon-progress">
                  <div
                    className="neon-progress-bar"
                    style={{ width: `${Math.min(100, (totalCollected / totalExpected) * 100)}%` }}
                  />
                </div>
              </Card>
            )}

            {/* ── ALL MONTHS TABLE ── */}
            {isAllMode && (
              aggregatedRows.length === 0 ? (
                <EmptyState
                  icon={<HiOutlineClipboardDocumentList className="w-8 h-8" />}
                  title="No tickets assigned"
                  description="Add members to this group first."
                />
              ) : (
                <Card padding={false}>
                  <div className="p-6 pb-4 flex items-center gap-2">
                    <HiOutlineBanknotes className="w-5 h-5 text-cyan-400" />
                    <h3 className="text-base font-semibold text-foreground">
                      All {auctions.length} Month{auctions.length !== 1 ? 's' : ''} — Combined Balance
                    </h3>
                    <span className="ml-2 text-xs text-foreground-muted">(click a row to expand month breakdown)</span>
                  </div>
                  <div className="overflow-x-auto px-6 pb-6">
                    <table className="glass-table w-full">
                      <thead>
                        <tr>
                          <th>Ticket</th>
                          <th>Member</th>
                          <th>Mobile</th>
                          <th>Total Due</th>
                          <th>Total Paid</th>
                          <th>Remaining</th>
                          <th>Won Month(s)</th>
                          <th>Status</th>
                          <th>Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        {aggregatedRows
                          .slice()
                          .sort((a, b) => a.ticketNumber - b.ticketNumber)
                          .map((row) => (
                            <>
                              <tr
                                key={row.chitMemberId}
                                className="cursor-pointer hover:bg-surface/50"
                                onClick={() => setExpandedRow(expandedRow === row.chitMemberId ? null : row.chitMemberId)}
                              >
                                <td className="font-semibold text-cyan-400">#{row.ticketNumber}</td>
                                <td className="font-medium text-foreground">{row.memberName}</td>
                                <td className="text-foreground-muted">{row.mobile}</td>
                                <td className="text-foreground">{formatCurrency(row.totalDue)}</td>
                                <td>
                                  {row.totalPaid > 0
                                    ? <span className="text-emerald-400 font-semibold">{formatCurrency(row.totalPaid)}</span>
                                    : <span className="text-foreground-muted">₹0</span>}
                                </td>
                                <td>
                                  {row.remaining > 0
                                    ? <span className="text-red-400 font-semibold">{formatCurrency(row.remaining)}</span>
                                    : <span className="text-emerald-400">₹0</span>}
                                </td>
                                <td className="text-amber-400 text-sm">
                                  {row.wonMonths.length > 0 ? row.wonMonths.map(m => `M${m}`).join(', ') : '—'}
                                </td>
                                <td><AggregatedStatusBadge status={row.status} /></td>
                                <td onClick={(e) => e.stopPropagation()}>
                                  {row.remaining > 0 && (
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => {
                                        const firstDue = row.monthBreakdown.find(mb => mb.remaining > 0 && !mb.isWinner);
                                        if (firstDue) {
                                          setPayingMemberBreakdown(row.monthBreakdown);
                                          setPayingMember({
                                            chitMemberId: row.chitMemberId,
                                            ticketNumber: row.ticketNumber,
                                            memberName: row.memberName,
                                            mobile: row.mobile,
                                            isWinner: false,
                                            monthlyDue: firstDue.due,
                                            totalPaid: firstDue.paid,
                                            remaining: firstDue.remaining,
                                            status: firstDue.paid > 0 ? 'PARTIAL' : 'PENDING',
                                          });
                                        }
                                      }}
                                    >
                                      Record Payment
                                    </Button>
                                  )}
                                </td>
                              </tr>

                              {/* per-month breakdown sub-rows */}
                              {expandedRow === row.chitMemberId && (
                                <tr key={`${row.chitMemberId}-breakdown`}>
                                  <td colSpan={9} className="bg-surface/40 px-4 py-3">
                                    <div className="rounded-xl border border-border overflow-hidden">
                                      <table className="w-full text-sm">
                                        <thead>
                                          <tr className="border-b border-border">
                                            <th className="text-left px-4 py-2 text-foreground-muted font-medium">Month</th>
                                            <th className="text-right px-4 py-2 text-foreground-muted font-medium">Due</th>
                                            <th className="text-right px-4 py-2 text-foreground-muted font-medium">Paid</th>
                                            <th className="text-right px-4 py-2 text-foreground-muted font-medium">Remaining</th>
                                            <th className="text-center px-4 py-2 text-foreground-muted font-medium">Note</th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          {row.monthBreakdown.map((mb) => (
                                            <tr key={mb.month} className="border-b border-border/50 last:border-0">
                                              <td className="px-4 py-2 text-cyan-400 font-medium">Month {mb.month}</td>
                                              <td className="px-4 py-2 text-right text-foreground">
                                                {mb.isWinner ? <span className="text-foreground-muted">—</span> : formatCurrency(mb.due)}
                                              </td>
                                              <td className="px-4 py-2 text-right">
                                                {mb.paid > 0
                                                  ? <span className="text-emerald-400">{formatCurrency(mb.paid)}</span>
                                                  : <span className="text-foreground-muted">₹0</span>}
                                              </td>
                                              <td className="px-4 py-2 text-right">
                                                {mb.isWinner
                                                  ? <span className="text-foreground-muted">—</span>
                                                  : mb.remaining > 0
                                                    ? <span className="text-red-400">{formatCurrency(mb.remaining)}</span>
                                                    : <span className="text-emerald-400">₹0</span>}
                                              </td>
                                              <td className="px-4 py-2 text-center">
                                                {mb.isWinner && (
                                                  <span className="text-xs text-amber-400 bg-amber-400/10 px-2 py-0.5 rounded-full">🏆 Winner</span>
                                                )}
                                              </td>
                                            </tr>
                                          ))}
                                          <tr className="bg-surface border-t-2 border-border font-semibold">
                                            <td className="px-4 py-2 text-foreground-muted">Total</td>
                                            <td className="px-4 py-2 text-right text-foreground">{formatCurrency(row.totalDue)}</td>
                                            <td className="px-4 py-2 text-right text-emerald-400">{formatCurrency(row.totalPaid)}</td>
                                            <td className="px-4 py-2 text-right text-red-400">{formatCurrency(row.remaining)}</td>
                                            <td />
                                          </tr>
                                        </tbody>
                                      </table>
                                    </div>
                                  </td>
                                </tr>
                              )}
                            </>
                          ))}
                      </tbody>
                    </table>
                  </div>
                </Card>
              )
            )}

            {/* ── SINGLE MONTH TABLE ── */}
            {!isAllMode && (
              memberRows.length === 0 ? (
                <EmptyState
                  icon={<HiOutlineClipboardDocumentList className="w-8 h-8" />}
                  title="No tickets assigned"
                  description="Add members to this group first."
                />
              ) : (
              <Card padding={false}>
                <div className="p-6 pb-4 flex items-center gap-2">
                  <HiOutlineBanknotes className="w-5 h-5 text-cyan-400" />
                  <h3 className="text-base font-semibold text-foreground">
                    Month {selectedMonth} — Member Payment Status
                  </h3>
                </div>
                <div className="overflow-x-auto px-6 pb-6">
                  <table className="glass-table w-full">
                    <thead>
                      <tr>
                        <th>Ticket</th>
                        <th>Member</th>
                        <th>Mobile</th>
                        <th>Due</th>
                        <th>Paid</th>
                        <th>Remaining</th>
                        <th>Status</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {memberRows
                        .sort((a, b) => a.ticketNumber - b.ticketNumber)
                        .map((row) => (
                          <tr key={row.chitMemberId}>
                            <td className="font-semibold text-cyan-400">#{row.ticketNumber}</td>
                            <td className="font-medium text-foreground">{row.memberName}</td>
                            <td className="text-foreground-muted">{row.mobile}</td>
                            <td>
                              {row.isWinner ? (
                                <span className="text-foreground-muted text-xs">—</span>
                              ) : (
                                <span className="text-foreground">{formatCurrency(row.monthlyDue)}</span>
                              )}
                            </td>
                            <td>
                              {row.totalPaid > 0 ? (
                                <span className="text-emerald-400 font-semibold">
                                  {formatCurrency(row.totalPaid)}
                                </span>
                              ) : (
                                <span className="text-foreground-muted">₹0</span>
                              )}
                            </td>
                            <td>
                              {row.isWinner ? (
                                <span className="text-foreground-muted text-xs">—</span>
                              ) : row.remaining > 0 ? (
                                <span className="text-red-400 font-semibold">
                                  {formatCurrency(row.remaining)}
                                </span>
                              ) : (
                                <span className="text-emerald-400">₹0</span>
                              )}
                            </td>
                            <td>
                              <MemberStatusBadge status={row.status} />
                            </td>
                            <td>
                              {!row.isWinner && row.status !== 'COMPLETED' && (
                                <Button
                                  size="sm"
                                  variant="outline"
                                  onClick={() => setPayingMember(row)}
                                >
                                  Record Payment
                                </Button>
                              )}
                            </td>
                          </tr>
                        ))}
                    </tbody>
                  </table>
                </div>
              </Card>
              )
            )}
          </>
        )}

        {isLoadingData && (
          <div className="flex items-center justify-center py-12">
            <div className="w-8 h-8 border-2 border-cyan-400 border-t-transparent rounded-full animate-spin" />
          </div>
        )}
      </div>

      {/* Record Payment Modal */}
      {payingMember && selectedGroupId && selectedMonth !== null && (
        <RecordPaymentModal
          isOpen={!!payingMember}
          row={payingMember}
          chit_group_id={selectedGroupId}
          month_number={
            isAllMode
              ? (auctions
                  .slice()
                  .sort((a, b) => a.month_number - b.month_number)
                  .find(
                    (a) =>
                      a.winner_chit_member_id !== payingMember.chitMemberId &&
                      payments
                        .filter((p) => p.chit_member_id === payingMember.chitMemberId && p.month_number === a.month_number)
                        .reduce((s, p) => s + Number(p.amount_paid), 0) < (a.calculation_data?.amount_to_collect ?? 0)
                  )?.month_number ?? 1)
              : (selectedMonth as number)
          }
          auctions={isAllMode ? auctions.filter(a => a.winner_chit_member_id !== payingMember.chitMemberId) : []}
          monthBreakdown={isAllMode ? payingMemberBreakdown : []}
          allowMonthSelect={isAllMode}
          onClose={() => { setPayingMember(null); setPayingMemberBreakdown([]); }}
          onSaved={() => {
            setPayingMember(null);
            setPayingMemberBreakdown([]);
            loadMonthData();
          }}
        />
      )}
    </>
  );
}

// ─── Status Badge ─────────────────────────────────────────

function MemberStatusBadge({ status }: { status: MemberRow['status'] }) {
  const map: Record<MemberRow['status'], { label: string; cls: string }> = {
    WINNER: { label: 'Winner', cls: 'bg-amber-500/10 text-amber-400 border-amber-500/20' },
    COMPLETED: { label: 'Completed', cls: 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' },
    PARTIAL: { label: 'Partial', cls: 'bg-amber-500/10 text-amber-400 border-amber-500/20' },
    PENDING: { label: 'Pending', cls: 'bg-red-500/10 text-red-400 border-red-500/20' },
  };
  const { label, cls } = map[status];
  return (
    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${cls}`}>
      {label}
    </span>
  );
}

function AggregatedStatusBadge({ status }: { status: AggregatedRow['status'] }) {
  const map: Record<AggregatedRow['status'], { label: string; cls: string }> = {
    CLEAR: { label: 'Clear', cls: 'bg-amber-500/10 text-amber-400 border-amber-500/20' },
    COMPLETED: { label: 'All Paid', cls: 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' },
    PARTIAL: { label: 'Partial', cls: 'bg-amber-500/10 text-amber-400 border-amber-500/20' },
    PENDING: { label: 'Pending', cls: 'bg-red-500/10 text-red-400 border-red-500/20' },
  };
  const { label, cls } = map[status];
  return (
    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${cls}`}>
      {label}
    </span>
  );
}

// ─── Record Payment Modal ─────────────────────────────────

function RecordPaymentModal({
  isOpen,
  row,
  chit_group_id,
  month_number,
  auctions,
  monthBreakdown,
  allowMonthSelect,
  onClose,
  onSaved,
}: {
  isOpen: boolean;
  row: MemberRow;
  chit_group_id: string;
  month_number: number;
  auctions: Auction[];
  monthBreakdown: AggregatedRow['monthBreakdown'];
  allowMonthSelect: boolean;
  onClose: () => void;
  onSaved: () => void;
}) {
  const [amountPaid, setAmountPaid] = useState('');
  const [paymentMethod, setPaymentMethod] = useState('CASH');
  const [upiId, setUpiId] = useState('');
  const [selectedMonthForPayment, setSelectedMonthForPayment] = useState(month_number);
  const [isSubmitting, setIsSubmitting] = useState(false);

  // Look up the selected month's figures from the breakdown (all-months mode)
  // or fall back to the row prop (single-month mode)
  const activeLine = monthBreakdown.find((mb) => mb.month === selectedMonthForPayment);
  const displayDue = activeLine ? activeLine.due : row.monthlyDue;
  const displayPaid = activeLine ? activeLine.paid : row.totalPaid;
  const displayRemaining = activeLine ? activeLine.remaining : row.remaining;

  useEffect(() => {
    if (isOpen) {
      setPaymentMethod('CASH');
      setUpiId('');
      setSelectedMonthForPayment(month_number);
      // initial amount = remaining for the initial month
      const initial = monthBreakdown.find((mb) => mb.month === month_number);
      setAmountPaid(String(initial ? initial.remaining : row.remaining));
    }
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isOpen]);

  // When month selector changes, update the pre-filled amount to that month's remaining
  useEffect(() => {
    if (!isOpen) return;
    const line = monthBreakdown.find((mb) => mb.month === selectedMonthForPayment);
    if (line) setAmountPaid(String(line.remaining));
  }, [selectedMonthForPayment, monthBreakdown, isOpen]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);

    const res = await fetch('/api/payments', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chit_group_id,
        chit_member_id: row.chitMemberId,
        month_number: selectedMonthForPayment,
        amount_paid: Number(amountPaid),
        payment_method: paymentMethod,
        upi_id: paymentMethod === 'UPI' ? upiId : undefined,
        payment_date: new Date().toISOString(),
      }),
    });

    const data = await res.json();
    if (!res.ok) {
      toast.error(data.error || 'Failed to record payment');
    } else {
      toast.success(`Payment recorded for ${row.memberName}`);
      onSaved();
    }
    setIsSubmitting(false);
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title={`Record Payment — #${row.ticketNumber} ${row.memberName}`}>
      <div className="mb-4 p-3 bg-surface border border-border rounded-xl space-y-1">
        <div className="flex justify-between text-sm">
          <span className="text-foreground-muted">Monthly Due</span>
          <span className="font-semibold text-foreground">{formatCurrency(displayDue)}</span>
        </div>
        <div className="flex justify-between text-sm">
          <span className="text-foreground-muted">Already Paid</span>
          <span className="font-semibold text-emerald-400">{formatCurrency(displayPaid)}</span>
        </div>
        <div className="flex justify-between text-sm">
          <span className="text-foreground-muted">Remaining</span>
          <span className="font-semibold text-red-400">{formatCurrency(displayRemaining)}</span>
        </div>
      </div>

      <form onSubmit={handleSubmit} className="space-y-4">
        {allowMonthSelect && auctions.length > 0 && (
          <Select
            label="Month to Pay For"
            value={String(selectedMonthForPayment)}
            onChange={(e) => setSelectedMonthForPayment(Number(e.target.value))}
            options={auctions
              .slice()
              .sort((a, b) => a.month_number - b.month_number)
              .map((a) => ({ value: String(a.month_number), label: `Month ${a.month_number}` }))}
          />
        )}
        <Input
          label={`Amount to Pay (max ${formatCurrency(displayRemaining)})`}
          type="number"
          value={amountPaid}
          onChange={(e) => setAmountPaid(e.target.value)}
          required
        />

        <Select
          label="Payment Method"
          value={paymentMethod}
          onChange={(e) => setPaymentMethod(e.target.value)}
          options={[
            { value: 'CASH', label: 'Cash' },
            { value: 'UPI', label: 'UPI' },
            { value: 'BANK_TRANSFER', label: 'Bank Transfer' },
          ]}
        />

        {paymentMethod === 'UPI' && (
          <Input
            label="UPI ID"
            value={upiId}
            onChange={(e) => setUpiId(e.target.value)}
            placeholder="name@upi"
            required
          />
        )}

        <div className="flex justify-end gap-3 pt-4 border-t border-border">
          <Button variant="outline" onClick={onClose} type="button">Cancel</Button>
          <Button type="submit" isLoading={isSubmitting}>Record Payment</Button>
        </div>
      </form>
    </Modal>
  );
}

========================================
//src/app/profile/layout.tsx
import { Sidebar } from '@/components/layout/Sidebar';
import type { ReactNode } from 'react';

export default function ProfileLayout({ children }: { children: ReactNode }) {
  return (
    <div className="min-h-screen">
      <Sidebar />
      <main className="lg:pl-64 min-h-screen pb-20 lg:pb-0">
        {children}
      </main>
    </div>
  );
}
========================================
//src/app/profile/page.tsx
'use client';

import { useState } from 'react';
import { useAuth } from '@/components/providers/AuthProvider';
import { Header } from '@/components/layout/Header';
import { Card, Button, Input, PageLoader } from '@/components/ui';
import {
  HiOutlineUserCircle,
  HiOutlineLockClosed,
  HiOutlineShieldCheck,
  HiOutlineCalendarDays,
} from 'react-icons/hi2';
import toast from 'react-hot-toast';

export default function ProfilePage() {
  const { user, isLoading, refreshUser } = useAuth();

  if (isLoading) {
    return (
      <>
        <Header title="Profile" />
        <PageLoader />
      </>
    );
  }

  if (!user) {
    return (
      <>
        <Header title="Profile" />
        <div className="p-8 text-center text-foreground-muted">
          Unable to load profile. Please refresh the page.
        </div>
      </>
    );
  }

  return (
    <>
      <Header title="My Profile" subtitle="Manage your personal information" />

      <div className="p-4 sm:p-6 lg:p-8 max-w-3xl space-y-6">
        {/* Profile Header */}
        <Card>
          <div className="flex flex-col sm:flex-row items-center sm:items-start gap-6">
            <div className="w-20 h-20 rounded-2xl bg-linear-to-br from-cyan-500 to-purple-500 flex items-center justify-center text-white font-bold text-3xl shadow-lg shadow-cyan-500/20 shrink-0">
              {user.name?.charAt(0).toUpperCase() || user.username?.charAt(0).toUpperCase()}
            </div>
            <div className="text-center sm:text-left flex-1">
              <h2 className="text-2xl font-bold text-foreground">{user.name}</h2>
              <p className="text-foreground-muted mt-1">@{user.username}</p>
              <p className="text-foreground-muted text-sm">{user.email}</p>
              <div className="flex flex-wrap items-center justify-center sm:justify-start gap-3 mt-3">
                <span className="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-cyan-500/10 text-cyan-400 border border-cyan-500/20">
                  <HiOutlineShieldCheck className="w-3.5 h-3.5" />
                  Active Account
                </span>
              </div>
            </div>
          </div>
        </Card>

        {/* Edit Profile */}
        <ProfileForm user={user} onUpdated={refreshUser} />

        {/* Change Password */}
        <PasswordForm />

        {/* Account Details */}
        <Card>
          <h3 className="text-lg font-semibold text-foreground mb-4 flex items-center gap-2">
            <HiOutlineShieldCheck className="w-5 h-5 text-cyan-400" />
            Account Details
          </h3>
          <div className="space-y-0">
            <InfoRow
              icon={<HiOutlineUserCircle className="w-4 h-4" />}
              label="Username"
              value={user.username}
            />
            <InfoRow
              icon={<HiOutlineShieldCheck className="w-4 h-4" />}
              label="Account ID"
              value={<span className="font-mono text-xs">{user.id.slice(0, 16)}...</span>}
            />
            <InfoRow
              icon={<HiOutlineCalendarDays className="w-4 h-4" />}
              label="Member Since"
              value={new Date(user.created_at).toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'long',
                year: 'numeric',
              })}
            />
          </div>
        </Card>
      </div>
    </>
  );
}

function InfoRow({
  icon,
  label,
  value,
}: {
  icon: React.ReactNode;
  label: string;
  value: React.ReactNode;
}) {
  return (
    <div className="flex items-center justify-between py-3 border-b border-border last:border-0">
      <span className="flex items-center gap-2 text-sm text-foreground-muted">
        {icon}
        {label}
      </span>
      <span className="text-sm text-foreground-secondary">{value}</span>
    </div>
  );
}

function ProfileForm({
  user,
  onUpdated,
}: {
  user: { id: string; name: string; email: string; phone: string };
  onUpdated: () => void;
}) {
  const [name, setName] = useState(user.name || '');
  const [isSaving, setIsSaving] = useState(false);

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!name.trim()) {
      toast.error('Name is required');
      return;
    }

    setIsSaving(true);

    const now = new Date().toISOString();

    const res = await fetch(`/api/users/${user.id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: { value: name.trim(), updated_at: now },
      }),
    });

    if (res.ok) {
      toast.success('Profile updated!');
      onUpdated();
    } else {
      toast.error('Failed to update profile');
    }

    setIsSaving(false);
  };

  return (
    <Card>
      <h3 className="text-lg font-semibold text-foreground mb-4 flex items-center gap-2">
        <HiOutlineUserCircle className="w-5 h-5 text-cyan-400" />
        Personal Information
      </h3>
      <form onSubmit={handleSave} className="space-y-4">
        <Input
          label="Full Name"
          value={name}
          onChange={(e) => setName(e.target.value)}
          required
        />
        <Input
          label="Email"
          value={user.email}
          disabled
          helperText="Email cannot be changed"
        />
        <Input
          label="Phone"
          value={user.phone}
          disabled
          helperText="Phone cannot be changed"
        />
        <div className="flex justify-end pt-2">
          <Button type="submit" isLoading={isSaving}>
            Save Changes
          </Button>
        </div>
      </form>
    </Card>
  );
}

function PasswordForm() {
  const { user } = useAuth();
  const [newPassword, setNewPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [isChanging, setIsChanging] = useState(false);

  const handleChangePassword = async (e: React.FormEvent) => {
    e.preventDefault();

    if (newPassword.length < 6) {
      toast.error('Password must be at least 6 characters');
      return;
    }

    if (newPassword !== confirmPassword) {
      toast.error('Passwords do not match');
      return;
    }

    setIsChanging(true);

    const now = new Date().toISOString();
    const bcryptRes = await fetch('/api/auth/change-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: newPassword }),
    });

    if (bcryptRes.ok) {
      toast.success('Password updated!');
      setNewPassword('');
      setConfirmPassword('');
    } else {
      const data = await bcryptRes.json();
      toast.error(data.error || 'Failed to update password');
    }

    setIsChanging(false);
  };

  return (
    <Card>
      <h3 className="text-lg font-semibold text-foreground mb-4 flex items-center gap-2">
        <HiOutlineLockClosed className="w-5 h-5 text-cyan-400" />
        Change Password
      </h3>
      <form onSubmit={handleChangePassword} className="space-y-4">
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <Input
            label="New Password"
            type="password"
            value={newPassword}
            onChange={(e) => setNewPassword(e.target.value)}
            required
            helperText="Minimum 6 characters"
          />
          <Input
            label="Confirm Password"
            type="password"
            value={confirmPassword}
            onChange={(e) => setConfirmPassword(e.target.value)}
            required
          />
        </div>
        <div className="flex justify-end pt-2">
          <Button type="submit" isLoading={isChanging}>
            Update Password
          </Button>
        </div>
      </form>
    </Card>
  );
}
========================================
//src/app/register/page.tsx
'use client';

import { useState } from 'react';
import Link from 'next/link';
import { useAuth } from '@/components/providers/AuthProvider';
import { Input } from '@/components/ui/Input';
import { Button } from '@/components/ui/Button';
import toast from 'react-hot-toast';

export default function RegisterPage() {
  const { register } = useAuth();
  const [form, setForm] = useState({
    name: '',
    username: '',
    email: '',
    phone: '',
    password: '',
    confirmPassword: '',
  });
  const [isLoading, setIsLoading] = useState(false);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setForm((prev) => ({ ...prev, [e.target.name]: e.target.value }));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (form.password !== form.confirmPassword) {
      toast.error('Passwords do not match');
      return;
    }

    if (form.password.length < 6) {
      toast.error('Password must be at least 6 characters');
      return;
    }

    setIsLoading(true);
    const result = await register({
      name: form.name,
      username: form.username,
      email: form.email,
      phone: form.phone,
      password: form.password,
    });

    if (result.error) {
      toast.error(result.error);
    }
    setIsLoading(false);
  };

  return (
    <div className="min-h-screen flex items-center justify-center px-4 py-12 relative overflow-hidden">
      {/* Orbs */}
      <div className="fixed inset-0 pointer-events-none">
        <div className="absolute top-[-20%] left-[-10%] w-125 h-125 rounded-full bg-cyan-500/[0.07] blur-[120px]" />
        <div className="absolute bottom-[-20%] right-[-10%] w-100 h-100 rounded-full bg-purple-500/[0.07] blur-[120px]" />
      </div>

      <div className="relative w-full max-w-md animate-slide-up">
        {/* Logo */}
        <div className="text-center mb-8">
          <Link href="/" className="inline-flex items-center gap-3 mb-6">
            <div className="w-10 h-10 rounded-xl flex items-center justify-center bg-linear-to-br from-cyan-400 to-purple-500 shadow-lg shadow-cyan-500/20">
              <span className="text-white font-black text-lg">B</span>
            </div>
            <span className="text-foreground font-bold text-xl tracking-tight">
              Bid<span className="neon-text">Nest</span>
            </span>
          </Link>
          <h1 className="text-2xl font-bold text-foreground">Create account</h1>
          <p className="text-foreground-muted text-sm mt-1">Start managing your chit funds today</p>
        </div>

        {/* Form */}
        <div className="glass-strong rounded-2xl border border-border p-8">
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <Input
                label="Full Name"
                name="name"
                placeholder="John Doe"
                value={form.name}
                onChange={handleChange}
                required
              />
              <Input
                label="Username"
                name="username"
                placeholder="johndoe"
                value={form.username}
                onChange={handleChange}
                required
              />
            </div>
            <Input
              label="Email"
              type="email"
              name="email"
              placeholder="john@example.com"
              value={form.email}
              onChange={handleChange}
              required
            />
            <Input
              label="Phone"
              type="tel"
              name="phone"
              placeholder="9876543210"
              value={form.phone}
              onChange={handleChange}
              required
            />
            <div className="grid grid-cols-2 gap-4">
              <Input
                label="Password"
                type="password"
                name="password"
                placeholder="••••••••"
                value={form.password}
                onChange={handleChange}
                required
              />
              <Input
                label="Confirm Password"
                type="password"
                name="confirmPassword"
                placeholder="••••••••"
                value={form.confirmPassword}
                onChange={handleChange}
                required
              />
            </div>
            <Button
              type="submit"
              className="w-full"
              size="lg"
              isLoading={isLoading}
            >
              Create Account
            </Button>
          </form>

          <div className="mt-6 text-center">
            <p className="text-sm text-foreground-muted">
              Already have an account?{' '}
              <Link href="/login" className="text-cyan-400 hover:text-cyan-300 font-medium transition-colors">
                Sign in
              </Link>
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}
========================================
//src/components/layout/Header.tsx
'use client';

import { useAuth } from '@/components/providers/AuthProvider';
import { HiOutlineBell, HiOutlineUserCircle, HiOutlineSun, HiOutlineMoon } from 'react-icons/hi2';
import { useEffect, useState } from 'react';

interface HeaderProps {
  title: string;
  subtitle?: string;
  children?: React.ReactNode;
}

export function Header({ title, subtitle, children }: HeaderProps) {
  const { user } = useAuth();
  const [isDark, setIsDark] = useState(true);

  useEffect(() => {
    const stored = localStorage.getItem('bidnest-theme');
    if (stored === 'light') {
      setIsDark(false);
      document.documentElement.classList.remove('dark');
    } else {
      setIsDark(true);
      document.documentElement.classList.add('dark');
    }
  }, []);

  const toggleTheme = () => {
    const newTheme = isDark ? 'light' : 'dark';
    setIsDark(!isDark);
    localStorage.setItem('bidnest-theme', newTheme);
    if (newTheme === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  };

  return (
    <header
      className="sticky top-0 z-30 flex items-center justify-between px-4 sm:px-6 lg:px-8 py-4 border-b border-border"
      style={{ background: 'var(--header-bg)', backdropFilter: 'blur(12px)' }}
    >
      <div>
        <h1 className="text-xl font-bold text-foreground">{title}</h1>
        {subtitle && <p className="text-sm text-foreground-muted mt-0.5">{subtitle}</p>}
      </div>
      <div className="flex items-center gap-3">
        {children}
        {/* Theme Toggle */}
        <button
          onClick={toggleTheme}
          className="p-2 rounded-xl hover:bg-surface-hover transition-colors text-foreground-muted hover:text-foreground"
          title={isDark ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
        >
          {isDark ? (
            <HiOutlineSun className="w-5 h-5" />
          ) : (
            <HiOutlineMoon className="w-5 h-5" />
          )}
        </button>
        <button className="p-2 rounded-xl hover:bg-surface-hover transition-colors text-foreground-muted hover:text-foreground">
          <HiOutlineBell className="w-5 h-5" />
        </button>
        <div className="flex items-center gap-2 px-3 py-1.5 rounded-xl glass text-sm">
          <HiOutlineUserCircle className="w-5 h-5 text-cyan-400" />
          <span className="text-foreground-secondary font-medium hidden sm:block">
            {user?.name || user?.username}
          </span>
        </div>
      </div>
    </header>
  );
}
========================================
//src/components/layout/Sidebar.tsx
'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { useAuth } from '@/components/providers/AuthProvider';
import {
  HiOutlineSquares2X2,
  HiOutlineUsers,
  HiOutlineUserGroup,
  HiOutlineTrophy,
  HiOutlineBanknotes,
  HiOutlineArrowRightOnRectangle,
  HiOutlineUserCircle,
  HiOutlineClipboardDocumentList,
} from 'react-icons/hi2';

const navItems = [
  { href: '/dashboard', label: 'Dashboard', icon: HiOutlineSquares2X2, exact: false },
  { href: '/members', label: 'Members', icon: HiOutlineUsers, exact: false },
  { href: '/groups', label: 'Chit Groups', icon: HiOutlineUserGroup, exact: false },
  { href: '/auctions', label: 'Auctions', icon: HiOutlineTrophy, exact: false },
  { href: '/payments', label: 'Payments', icon: HiOutlineBanknotes, exact: true },
  { href: '/payments/tracking', label: 'Payment Tracker', icon: HiOutlineClipboardDocumentList, exact: false },
];

export function Sidebar() {
  const pathname = usePathname();
  const { user, logout } = useAuth();

  return (
    <>
      {/* Desktop Sidebar */}
      <aside className="hidden lg:flex flex-col fixed left-0 top-0 h-full w-64 border-r border-border z-40"
        style={{ background: 'var(--sidebar-bg)', backdropFilter: 'blur(20px)' }}
      >
        {/* Logo */}
        <div className="flex items-center gap-3 px-6 py-5 border-b border-border">
          <div className="w-9 h-9 rounded-xl flex items-center justify-center bg-linear-to-br from-cyan-400 to-purple-500 shadow-lg shadow-cyan-500/20">
            <span className="text-white font-black text-base">B</span>
          </div>
          <span className="text-foreground font-bold text-lg tracking-tight">
            Bid<span className="neon-text">Nest</span>
          </span>
        </div>

        {/* Nav */}
        <nav className="flex-1 px-3 py-4 space-y-1">
          {navItems.map((item) => {
            const isActive = item.exact
              ? pathname === item.href
              : pathname === item.href || pathname.startsWith(item.href + '/');
            return (
              <Link
                key={item.href}
                href={item.href}
                className={`flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-all ${
                  isActive
                    ? 'bg-cyan-500/10 text-cyan-400 border border-cyan-500/20'
                    : 'text-foreground-secondary hover:bg-surface-hover hover:text-foreground'
                }`}
              >
                <item.icon className={`w-5 h-5 ${isActive ? 'text-cyan-400' : ''}`} />
                {item.label}
                {isActive && (
                  <span className="ml-auto w-1.5 h-1.5 rounded-full bg-cyan-400" />
                )}
              </Link>
            );
          })}
        </nav>

        {/* User section */}
        <div className="px-3 py-4 border-t border-border space-y-1">
          <Link
            href="/profile"
            className="flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium text-foreground-secondary hover:bg-surface-hover hover:text-foreground transition-all"
          >
            <HiOutlineUserCircle className="w-5 h-5" />
            {user?.name || user?.username}
          </Link>
          <button
            onClick={logout}
            className="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium text-foreground-secondary hover:bg-red-500/10 hover:text-red-400 transition-all"
          >
            <HiOutlineArrowRightOnRectangle className="w-5 h-5" />
            Sign Out
          </button>
        </div>
      </aside>

      {/* Mobile Bottom Nav */}
      <nav className="lg:hidden fixed bottom-0 left-0 right-0 z-40 border-t border-border px-2 py-2 flex items-center justify-around"
        style={{ background: 'var(--sidebar-bg)', backdropFilter: 'blur(20px)' }}
      >
        {navItems.map((item) => {
          const isActive = item.exact
            ? pathname === item.href
            : pathname === item.href || pathname.startsWith(item.href + '/');
          return (
            <Link
              key={item.href}
              href={item.href}
              className={`flex flex-col items-center gap-1 px-3 py-1.5 rounded-xl transition-all ${
                isActive ? 'text-cyan-400' : 'text-foreground-muted'
              }`}
            >
              <item.icon className="w-5 h-5" />
              <span className="text-xs font-medium">{item.label}</span>
            </Link>
          );
        })}
      </nav>
    </>
  );
}
========================================
//src/components/providers/AuthProvider.tsx
'use client';

import { createContext, useContext, useEffect, useState, useCallback } from 'react';
import { useRouter } from 'next/navigation';

interface AuthUser {
  id: string;
  name: string;
  username: string;
  email: string;
  phone: string;
  is_active: boolean;
  created_at: string;
}

interface AuthContextType {
  user: AuthUser | null;
  isLoading: boolean;
  login: (login: string, password: string) => Promise<{ error?: string }>;
  register: (data: RegisterData) => Promise<{ error?: string }>;
  logout: () => Promise<void>;
  refreshUser: () => Promise<void>;
}

interface RegisterData {
  name: string;
  username: string;
  email: string;
  phone: string;
  password: string;
}

const AuthContext = createContext<AuthContextType | null>(null);

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<AuthUser | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const router = useRouter();

  const fetchUser = useCallback(async () => {
    try {
      const res = await fetch('/api/auth/me');
      if (res.ok) {
        const data = await res.json();
        setUser(data);
      } else {
        setUser(null);
      }
    } catch {
      setUser(null);
    } finally {
      setIsLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchUser();
  }, [fetchUser]);

  const login = async (login: string, password: string) => {
    const res = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ login, password }),
    });

    const data = await res.json();

    if (!res.ok) return { error: data.error };

    await fetchUser();
    router.push('/dashboard');
    return {};
  };

  const register = async (registerData: RegisterData) => {
    const res = await fetch('/api/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(registerData),
    });

    const data = await res.json();

    if (!res.ok) return { error: data.error };

    await fetchUser();
    router.push('/dashboard');
    return {};
  };

  const logout = async () => {
    await fetch('/api/auth/logout', { method: 'POST' });
    setUser(null);
    router.push('/login');
  };

  const refreshUser = async () => {
    await fetchUser();
  };

  return (
    <AuthContext.Provider value={{ user, isLoading, login, register, logout, refreshUser }}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const ctx = useContext(AuthContext);
  if (!ctx) throw new Error('useAuth must be used within AuthProvider');
  return ctx;
}
========================================
//src/components/providers/index.tsx
'use client';

import { AuthProvider } from './AuthProvider';
import { Toaster } from 'react-hot-toast';

export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <AuthProvider>
      <Toaster
        position="top-right"
        toastOptions={{
          style: {
            background: 'rgba(10, 10, 26, 0.9)',
            color: '#f1f5f9',
            border: '1px solid rgba(255,255,255,0.1)',
            backdropFilter: 'blur(12px)',
          },
          success: {
            iconTheme: { primary: '#00f0ff', secondary: '#050510' },
          },
          error: {
            iconTheme: { primary: '#ef4444', secondary: '#050510' },
          },
        }}
      />
      {children}
    </AuthProvider>
  );
}
========================================
//src/components/ui/Badge.tsx
interface BadgeProps {
  children: React.ReactNode;
  variant?: 'default' | 'success' | 'warning' | 'danger' | 'info';
}

export function Badge({ children, variant = 'default' }: BadgeProps) {
  const variants = {
    default: 'bg-surface text-foreground-secondary border-border',
    success: 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20',
    warning: 'bg-amber-500/10 text-amber-400 border-amber-500/20',
    danger: 'bg-red-500/10 text-red-400 border-red-500/20',
    info: 'bg-cyan-500/10 text-cyan-400 border-cyan-500/20',
  };

  return (
    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${variants[variant]}`}>
      {children}
    </span>
  );
}

export function StatusBadge({ status }: { status: string }) {
  const map: Record<string, { label: string; variant: BadgeProps['variant'] }> = {
    ACTIVE: { label: 'Active', variant: 'success' },
    PENDING: { label: 'Pending', variant: 'warning' },
    COMPLETED: { label: 'Completed', variant: 'info' },
    CANCELLED: { label: 'Cancelled', variant: 'danger' },
    PARTIAL: { label: 'Partial', variant: 'warning' },
    paid: { label: 'Paid', variant: 'success' },
    pending: { label: 'Pending', variant: 'warning' },
    overdue: { label: 'Overdue', variant: 'danger' },
  };

  const config = map[status] ?? { label: status, variant: 'default' as const };

  return <Badge variant={config.variant}>{config.label}</Badge>;
}
========================================
//src/components/ui/Button.tsx
interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'outline' | 'ghost' | 'danger';
  size?: 'sm' | 'md' | 'lg';
  isLoading?: boolean;
  icon?: React.ReactNode;
}

export function Button({
  children,
  variant = 'primary',
  size = 'md',
  isLoading,
  icon,
  className = '',
  disabled,
  ...props
}: ButtonProps) {
  const base = 'inline-flex items-center justify-center gap-2 font-medium rounded-xl transition-all focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed';

  const variants = {
    primary: 'bg-gradient-to-r from-cyan-500 to-purple-500 text-white shadow-lg shadow-cyan-500/20 hover:shadow-cyan-500/40 hover:-translate-y-0.5',
    outline: 'border border-border text-foreground-secondary hover:border-cyan-500/30 hover:text-foreground hover:bg-surface-hover',
    ghost: 'text-foreground-secondary hover:bg-surface-hover hover:text-foreground',
    danger: 'bg-red-500/10 border border-red-500/20 text-red-400 hover:bg-red-500/20',
  };

  const sizes = {
    sm: 'px-3 py-1.5 text-xs',
    md: 'px-4 py-2 text-sm',
    lg: 'px-6 py-3 text-base',
  };

  return (
    <button
      className={`${base} ${variants[variant]} ${sizes[size]} ${className}`}
      disabled={disabled || isLoading}
      {...props}
    >
      {isLoading ? (
        <svg className="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z" />
        </svg>
      ) : icon}
      {children}
    </button>
  );
}
========================================
//src/components/ui/Card.tsx
interface CardProps {
  children: React.ReactNode;
  padding?: boolean;
  className?: string;
}

export function Card({ children, padding = true, className = '' }: CardProps) {
  return (
    <div className={`glass rounded-2xl border border-border ${padding ? 'p-6' : ''} ${className}`}>
      {children}
    </div>
  );
}
========================================
//src/components/ui/Feedback.tsx
export function PageLoader() {
  return (
    <div className="flex items-center justify-center h-64">
      <div className="relative">
        <div className="w-12 h-12 rounded-full border-2 border-cyan-500/20 border-t-cyan-400 animate-spin" />
        <div className="absolute inset-0 w-12 h-12 rounded-full border-2 border-transparent border-b-purple-400 animate-spin" style={{ animationDirection: 'reverse', animationDuration: '0.8s' }} />
      </div>
    </div>
  );
}

export function EmptyState({
  icon,
  title,
  description,
}: {
  icon: React.ReactNode;
  title: string;
  description?: string;
}) {
  return (
    <div className="flex flex-col items-center justify-center py-16 text-center">
      <div className="p-4 rounded-2xl bg-surface text-foreground-muted mb-4">
        {icon}
      </div>
      <h3 className="text-base font-semibold text-foreground mb-1">{title}</h3>
      {description && <p className="text-sm text-foreground-muted max-w-sm">{description}</p>}
    </div>
  );
}
========================================
//src/components/ui/index.ts
export { Card } from './Card';
export { Button } from './Button';
export { Input } from './Input';
export { Badge, StatusBadge } from './Badge';
export { Modal } from './Modal';
export { PageLoader, EmptyState } from './Feedback';
export { StatCard } from './StatCard';
export { Select } from './Select';
========================================
//src/components/ui/Input.tsx
interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {
  label?: string;
  helperText?: string;
  error?: string;
}

export function Input({ label, helperText, error, className = '', ...props }: InputProps) {
  return (
    <div className="space-y-1.5">
      {label && (
        <label className="block text-sm font-medium text-foreground-secondary">
          {label}
        </label>
      )}
      <input
        className={`w-full px-4 py-2.5 glass-input text-sm rounded-xl ${
          error ? 'border-red-500/50 focus:border-red-500' : ''
        } ${className}`}
        {...props}
      />
      {error && <p className="text-xs text-red-400">{error}</p>}
      {helperText && !error && <p className="text-xs text-foreground-muted">{helperText}</p>}
    </div>
  );
}
========================================
//src/components/ui/Modal.tsx
'use client';

import { useEffect } from 'react';
import { HiOutlineXMark } from 'react-icons/hi2';

interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  title: string;
  children: React.ReactNode;
  size?: 'sm' | 'md' | 'lg';
}

export function Modal({ isOpen, onClose, title, children, size = 'md' }: ModalProps) {
  useEffect(() => {
    if (isOpen) document.body.style.overflow = 'hidden';
    else document.body.style.overflow = '';
    return () => { document.body.style.overflow = ''; };
  }, [isOpen]);

  if (!isOpen) return null;

  const sizes = { sm: 'max-w-sm', md: 'max-w-md', lg: 'max-w-lg' };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
      <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
      <div className={`relative w-full ${sizes[size]} glass-strong rounded-2xl border border-border shadow-2xl animate-slide-in`}>
        <div className="flex items-center justify-between px-6 py-4 border-b border-border">
          <h2 className="text-base font-semibold text-foreground">{title}</h2>
          <button onClick={onClose} className="p-1 rounded-lg text-foreground-muted hover:text-foreground hover:bg-surface-hover transition-all">
            <HiOutlineXMark className="w-5 h-5" />
          </button>
        </div>
        <div className="px-6 py-5">{children}</div>
      </div>
    </div>
  );
}
========================================
//src/components/ui/Select.tsx
interface SelectProps extends React.SelectHTMLAttributes<HTMLSelectElement> {
  options: { value: string; label: string }[];
  label?: string;
}

export function Select({ options, label, className = '', ...props }: SelectProps) {
  return (
    <div className="space-y-1.5">
      {label && (
        <label className="block text-sm font-medium text-foreground-secondary">{label}</label>
      )}
      <select
        className={`w-full px-4 py-2.5 glass-input text-sm rounded-xl appearance-none cursor-pointer ${className}`}
        style={{ background: 'var(--input-option-bg)' }}
        {...props}
      >
        {options.map((opt) => (
          <option key={opt.value} value={opt.value}>
            {opt.label}
          </option>
        ))}
      </select>
    </div>
  );
}
========================================
//src/components/ui/StatCard.tsx
interface StatCardProps {
  title: string;
  value: string | number;
  icon?: React.ReactNode;
  change?: string;
  changeType?: 'positive' | 'negative' | 'neutral';
}

export function StatCard({ title, value, icon, change, changeType = 'neutral' }: StatCardProps) {
  const changeColors = {
    positive: 'text-emerald-400',
    negative: 'text-red-400',
    neutral: 'text-foreground-muted',
  };

  return (
    <div className="glass rounded-2xl border border-border p-5 flex items-start justify-between">
      <div>
        <p className="text-sm text-foreground-muted mb-1">{title}</p>
        <p className="text-2xl font-bold text-foreground">{value}</p>
        {change && (
          <p className={`text-xs mt-1 ${changeColors[changeType]}`}>{change}</p>
        )}
      </div>
      {icon && (
        <div className="p-3 rounded-xl bg-cyan-500/10 text-cyan-400">
          {icon}
        </div>
      )}
    </div>
  );
}
========================================
//src/lib/api.ts
// (placeholder) central api helpers
export async function fetchJson(url: string, opts?: RequestInit) {
  const res = await fetch(url, opts);
  if (!res.ok) throw new Error('Network error');
  return res.json();
}

========================================
//src/lib/auth.ts
import jwt from "jsonwebtoken";
import { cookies } from "next/headers";

const JWT_SECRET = process.env.JWT_SECRET!;
const COOKIE_NAME = "bidnest-token";

export interface JwtPayload {
  id: string;
  username: string;
  is_active: boolean;
}

export function signToken(payload: JwtPayload): string {
  return jwt.sign(payload, JWT_SECRET, { expiresIn: "7d" });
}

export function verifyToken(token: string): JwtPayload | null {
  try {
    return jwt.verify(token, JWT_SECRET) as JwtPayload;
  } catch {
    return null;
  }
}

export async function getAuthUser(): Promise<JwtPayload | null> {
  const cookieStore = await cookies();
  const token = cookieStore.get(COOKIE_NAME)?.value;
  if (!token) return null;
  return verifyToken(token);
}

export function createAuthCookie(token: string): string {
  return `${COOKIE_NAME}=${token}; HttpOnly; Path=/; Max-Age=${7 * 24 * 60 * 60}; SameSite=Lax`;
}

export function clearAuthCookie(): string {
  return `${COOKIE_NAME}=; HttpOnly; Path=/; Max-Age=0; SameSite=Lax`;
}
========================================
//src/lib/prisma.ts
import { PrismaClient } from "@prisma/client";
import { PrismaNeon } from "@prisma/adapter-neon";
import * as dotenv from "dotenv";

dotenv.config();

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

const adapter = new PrismaNeon({
  connectionString: process.env.DATABASE_URL!,
});

export const prisma =
  globalForPrisma.prisma ?? new PrismaClient({ adapter });

if (process.env.NODE_ENV !== "production") globalForPrisma.prisma = prisma;
========================================
//src/types/auction.ts
export interface Auction {
  id: string;
  chit_group_id: string;
  month_number: number;
  winner_chit_member_id: string;
  original_bid: string;
  winning_amount: string;
  commission: string;
  carry_previous: string;
  raw_dividend: string;
  roundoff_dividend: string;
  carry_next: string;
  calculation_data: {
    total_amount: number;
    total_members: number;
    monthly_contribution: number;
    dividend_per_member: number;
    amount_to_collect: number;
    commission_type: string;
    commission_value: number;
    round_off_value: number;
    original_bid: number;
    winning_amount: number;
    commission: number;
    carry_previous: number;
    raw_dividend: number;
    roundoff_dividend: number;
    carry_next: number;
  };
  created_at: string;
  winner_chit_member?: {
    ticket_number: number;
    member: { name: { value: string } };
  };
}
========================================
//src/types/chitgroup.ts
export interface ChitGroup {
  id: string;
  user_id: string;
  name: string;
  total_amount: string;
  total_members: number;
  monthly_amount: string;
  duration_months: number;
  commission_type: 'PERCENT' | 'FIXED';
  commission_value: string;
  round_off_value: number;
  status: 'ACTIVE' | 'PENDING' | 'CANCELLED' | 'COMPLETED';
  created_at: string;
  chit_members?: ChitMemberBasic[];
  auctions?: AuctionBasic[];
  payments?: PaymentBasic[];
}

export interface ChitMemberBasic {
  id: string;
  ticket_number: number;
  is_active: boolean;
}

export interface AuctionBasic {
  id: string;
  month_number: number;
}

export interface PaymentBasic {
  id: string;
  amount_paid: string;
}
========================================
//src/types/chitmember.ts
export interface ChitMember {
  id: string;
  member_id: string;
  chit_group_id: string;
  ticket_number: number;
  is_active: boolean;
  created_at: string;
  member?: {
    id: string;
    name: { value: string; updated_at: string };
    mobile: { value: string; updated_at: string };
    upi_ids: { value: string; added_at: string; is_active: boolean }[];
  };
}
========================================
//src/types/member.ts
export interface Member {
  id: string;
  user_id: string;
  name: { value: string; updated_at: string };
  nickname: { value: string; updated_at: string };
  mobile: { value: string; updated_at: string };
  upi_ids: { value: string; added_at: string; is_active: boolean }[];
  is_active: boolean;
  created_at: string;
}
========================================
//src/types/payment.ts
export interface Payment {
  id: string;
  chit_group_id: string;
  chit_member_id: string;
  month_number: number;
  amount_paid: string;
  payment_method: 'CASH' | 'UPI' | 'BANK_TRANSFER';
  upi_id: string | null;
  payment_date: string;
  status: 'PARTIAL' | 'COMPLETED';
  notes: string | null;
  created_at: string;
  chit_member?: {
    ticket_number: number;
    member: { name: { value: string } };
  };
}
========================================
//src/types/user.ts
export interface User {
  id: string;
  name: { value: string; updated_at: string };
  username: string;
  email: string;
  phone: string;
  is_active: boolean;
  created_at: string;
}

========================================
//src/utils/auction.ts
export { calculateAuction } from './dividend';
export type { AuctionCalculation, CalculationInput } from './dividend';
========================================
//src/utils/dividend.ts
export interface AuctionCalculation {
  winning_amount: number;
  commission: number;
  carry_previous: number;
  raw_dividend: number;
  roundoff_dividend: number;
  carry_next: number;
}

export interface CalculationInput {
  total_amount: number;
  original_bid: number;
  commission_type: "PERCENT" | "FIXED";
  commission_value: number;
  round_off_value: number;
  carry_previous: number;
}

export function calculateAuction(input: CalculationInput): AuctionCalculation {
  const {
    total_amount,
    original_bid,
    commission_type,
    commission_value,
    round_off_value,
    carry_previous,
  } = input;

  // winning amount = total - bid
  const winning_amount = total_amount - original_bid;

  // commission = percent of winning amount or fixed value
  const commission =
    commission_type === "PERCENT"
      ? (winning_amount * commission_value) / 100
      : commission_value;

  // raw dividend = bid - commission + carry from previous month
  const raw_dividend = original_bid - commission + carry_previous;

  // round down to nearest round_off_value
  const roundoff_dividend =
    Math.floor(raw_dividend / round_off_value) * round_off_value;

  // carry forward to next month
  const carry_next = raw_dividend - roundoff_dividend;

  return {
    winning_amount,
    commission,
    carry_previous,
    raw_dividend,
    roundoff_dividend,
    carry_next,
  };
}
========================================
//src/utils/payment.ts
export function getPaymentStatus(amountPaid: number, amountDue: number): 'PARTIAL' | 'COMPLETED' {
  return amountPaid >= amountDue ? 'COMPLETED' : 'PARTIAL';
}

export function getRemainingAmount(amountDue: number, amountPaid: number): number {
  return Math.max(0, amountDue - amountPaid);
}
========================================
